<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ContaLegal PRO v3 - Sistema Contable Unificado</title>
    
    <!-- Librer√≠as externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
            position: relative;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .year-selector {
            position: absolute;
            top: 30px;
            right: 30px;
            background: white;
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .year-selector label {
            margin-right: 10px;
            font-weight: 600;
            color: #2c3e50;
        }

        .year-selector select {
            padding: 5px 10px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 1em;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-tab {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 15px 20px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .nav-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
        }

        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            min-height: 500px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Sub-navegaci√≥n para Facturas */
        .sub-nav-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 25px;
            background: rgba(248, 249, 250, 0.8);
            padding: 10px;
            border-radius: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .sub-nav-tab {
            background: white;
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .sub-nav-tab:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .sub-nav-tab.active {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .sub-tab-content {
            display: none;
        }

        .sub-tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #27ae60;
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .form-row-4 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #27ae60;
        }

        .checkbox-group label {
            margin: 0;
            color: #2c3e50;
            font-weight: 600;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .btn-info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .table th {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            font-weight: 600;
        }

        .table tr:hover {
            background-color: #f8f9fa;
        }

        .estado-cobrada {
            background: #d4edda;
            color: #155724;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .estado-pendiente {
            background: #f8d7da;
            color: #721c24;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .estado-emitida {
            background: #fff3cd;
            color: #856404;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .estado-pagado {
            background: #d4edda;
            color: #155724;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .estado-activa {
            background: #d1ecf1;
            color: #004085;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .tipo-ingreso {
            background: #d1ecf1;
            color: #004085;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .tipo-gasto {
            background: #f8d7da;
            color: #721c24;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .tipo-recurrente {
            background: #d4edda;
            color: #155724;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .tipo-factura {
            background: #fff3cd;
            color: #856404;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .stat-card .amount {
            font-size: 2em;
            font-weight: 700;
            color: #27ae60;
        }

        .factura-section {
            background: #e8f5e9;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 4px solid #27ae60;
        }

        .config-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .import-section {
            background: #fff3cd;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 4px solid #ffc107;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .file-upload {
            position: relative;
            display: inline-block;
            margin: 10px 0;
        }

        .file-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload-label {
            display: inline-block;
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .file-upload-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .logo-preview {
            max-width: 200px;
            max-height: 100px;
            margin: 10px 0;
            border: 2px dashed #e9ecef;
            border-radius: 10px;
            padding: 10px;
            display: none;
        }

        .logo-preview img {
            max-width: 100%;
            max-height: 80px;
            object-fit: contain;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .modal-close:hover {
            color: #333;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            animation: slideIn 0.3s ease;
            min-width: 300px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .notification.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .notification.info {
            background: #d1ecf1;
            color: #004085;
            border: 1px solid #bee5eb;
        }

        .preview-container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .conceptos-container {
            margin: 20px 0;
        }

        .concepto-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #27ae60;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .concepto-item .form-row {
            display: grid;
            grid-template-columns: 3fr 1fr 1fr 80px;
            gap: 15px;
            align-items: end;
        }

        .recurrente-section {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #4caf50;
        }

        .recurrente-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #4caf50;
        }

        .tipo-factura-selector {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            justify-content: center;
        }

        .tipo-factura-btn {
            padding: 15px 30px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .tipo-factura-btn.active {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border-color: #27ae60;
        }

        .tipo-factura-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1em;
        }

        .search-box::before {
            content: "üîç";
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2em;
        }

        .filters-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-group label {
            font-weight: 600;
            color: #2c3e50;
        }

        .filter-group select, .filter-group input {
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
        }

        /* Estilos para modelos tributarios */
        .form-model {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .model-section {
            margin-bottom: 30px;
        }

        .model-section h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .readonly-field {
            background-color: #f8f9fa;
            color: #6c757d;
        }


        @media print {
            body {
                background: white;
            }
            
            .nav-tabs, .btn, .year-selector, .file-upload {
                display: none !important;
            }
            
            .preview-container {
                box-shadow: none;
                margin: 0;
                padding: 20px;
            }
        }
    
        .pagos-parciales-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .pago-parcial-item {
            background: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .pago-parcial-info {
            flex: 1;
        }

        .sort-filters {
            display: flex;
            gap: 15px;
            align-items: center;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .sort-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sort-group label {
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }

        .sort-group select {
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sort-group select:hover {
            border-color: #27ae60;
        }

        .sort-group select:focus {
            outline: none;
            border-color: #27ae60;
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="year-selector">
            <label>Ejercicio:</label>
            <select id="ejercicioActual" onchange="cambiarEjercicio()">
                <option value="2023">2023</option>
                <option value="2024">2024</option>
                <option value="2025" selected>2025</option>
                <option value="2026">2026</option>
            </select>
        </div>

        <div class="header">
            <h1>‚öñÔ∏è ContaLegal PRO v3</h1>
            <p>Sistema de Gesti√≥n Contable Unificado Multi-Ejercicio</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard', this)">üìä Dashboard</button>
            <button class="nav-tab" onclick="showTab('configuracion', this)">‚öôÔ∏è Config</button>
            <button class="nav-tab" onclick="showTab('clientes', this)">üë• Clientes</button>
            <button class="nav-tab" onclick="showTab('facturas', this)">üìÑ Facturas</button>
            <button class="nav-tab" onclick="showTab('excel', this)">üìä Importar/Exportar</button>
            <button class="nav-tab" onclick="showTab('modelo130', this)">üìã M130</button>
            <button class="nav-tab" onclick="showTab('modelo303', this)">üìÑ M303</button>
            <button class="nav-tab" onclick="showTab('anual', this)">üìÖ Anual</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <h2>üìä Resumen del Ejercicio <span id="ejercicioDashboard">2025</span></h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Ingresos Totales</h3>
                    <div class="amount" id="totalIngresos">‚Ç¨0.00</div>
                </div>
                <div class="stat-card">
                    <h3>Gastos Totales</h3>
                    <div class="amount" id="totalGastos">‚Ç¨0.00</div>
                </div>
                <div class="stat-card">
                    <h3>Beneficio Neto</h3>
                    <div class="amount" id="beneficioNeto">‚Ç¨0.00</div>
                </div>
                <div class="stat-card">
                    <h3>IVA Pendiente</h3>
                    <div class="amount" id="ivaPendiente">‚Ç¨0.00</div>
                </div>
                <div class="stat-card">
                    <h3>Retenciones Practicadas</h3>
                    <div class="amount" id="totalRetenciones" style="color: #e74c3c;">‚Ç¨0.00</div>
                </div>
            </div>
            
            <div class="form-group">
                <label>Filtrar por per√≠odo:</label>
                <select id="periodoFilter" onchange="updateDashboard()">
                    <option value="all">Todos los per√≠odos</option>
                    <option value="Q1">1¬∫ Trimestre</option>
                    <option value="Q2">2¬∫ Trimestre</option>
                    <option value="Q3">3¬∫ Trimestre</option>
                    <option value="Q4">4¬∫ Trimestre</option>
                </select>
            </div>
            
            <div class="form-group" style="margin-top: 15px;">
                <label>Filtrar por estado:</label>
                <select id="estadoFilter" onchange="updateDashboard()">
                    <option value="todas">Todas las facturas</option>
                    <option value="pendientes">Solo Pendientes</option>
                    <option value="pagadas">Solo Pagadas</option>
                </select>
            </div>

            <div style="margin-top: 30px;">
                <h3>üìà √öltimos Ingresos <span id="contadorOperaciones" style="color: #7f8c8d; font-size: 0.8em;"></span></h3>
                <p style="font-size: 0.9em; color: #7f8c8d; margin-bottom: 10px;">
                    üí° <strong>Tip:</strong> Click en cualquier fila para editar la factura | Usa los filtros y botones para gestionar tus facturas
                </p>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Tipo</th>
                            <th>Cliente</th>
                            <th>Descripci√≥n</th>
                            <th>Importe</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="ultimasOperaciones">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Configuraci√≥n Tab -->
        <div id="configuracion" class="tab-content">
            <h2>‚öôÔ∏è Configuraci√≥n del Despacho</h2>
            
            <div class="config-section">
                <h3>üè¢ Datos del Despacho</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Nombre del Despacho:</label>
                        <input type="text" id="configNombreDespacho" placeholder="Luis Jurado Cano">
                    </div>
                    <div class="form-group">
                        <label>NIF/CIF:</label>
                        <input type="text" id="configNifDespacho" placeholder="12345678A">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Direcci√≥n:</label>
                        <input type="text" id="configDireccionDespacho" placeholder="Calle Principal, 123">
                    </div>
                    <div class="form-group">
                        <label>Ciudad y C√≥digo Postal:</label>
                        <input type="text" id="configCiudadDespacho" placeholder="28001 Madrid">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Tel√©fono:</label>
                        <input type="text" id="configTelefonoDespacho" placeholder="600 123 456">
                    </div>
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" id="configEmailDespacho" placeholder="despacho@ejemplo.com">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Logo del Despacho:</label>
                    <div class="file-upload">
                        <input type="file" id="logoFile" accept="image/*" onchange="cargarLogo(this)">
                        <label for="logoFile" class="file-upload-label">üì∑ Seleccionar Logo</label>
                    </div>
                    <div id="logoPreview" class="logo-preview">
                        <img id="logoImg" src="" alt="Logo del despacho">
                    </div>
                    <small style="color: #6c757d;">Formatos soportados: JPG, PNG, GIF. Tama√±o recomendado: 200x100px</small>
                </div>
                
                <div class="form-group">
                    <label>Informaci√≥n Bancaria (para facturas):</label>
                    <textarea id="configInfoBancaria" rows="3" placeholder="IBAN: ES91 2100 0418 4502 0005 1332"></textarea>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button type="button" class="btn btn-success" onclick="guardarConfiguracion()">üíæ Guardar Configuraci√≥n</button>
                    <button type="button" class="btn btn-secondary" onclick="resetearConfiguracion()">üîÑ Resetear</button>
                </div>
            </div>

            <div class="config-section">
                <h3>üìß Configuraci√≥n de Email (EmailJS)</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Service ID:</label>
                        <input type="text" id="emailjs_service_id" placeholder="service_xxxxx">
                    </div>
                    <div class="form-group">
                        <label>Template ID:</label>
                        <input type="text" id="emailjs_template_id" placeholder="template_xxxxx">
                    </div>
                    <div class="form-group">
                        <label>User ID (Public Key):</label>
                        <input type="text" id="emailjs_user_id" placeholder="xxxxxxxxxxxxx">
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button type="button" class="btn btn-info" onclick="probarEnvioEmail()">üìß Probar Env√≠o</button>
                </div>
            </div>
        </div>

        <!-- Clientes Tab -->
        <div id="clientes" class="tab-content">
            <h2>üë• Gesti√≥n de Clientes y Proveedores</h2>
            
            <div class="search-box">
                <input type="text" id="buscarContacto" placeholder="Buscar por nombre, NIF o email..." onkeyup="filtrarContactos()">
            </div>

            <div class="factura-section">
                <h3>‚ûï Nuevo Cliente/Proveedor</h3>
                <form id="contactoForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tipo:</label>
                            <select id="tipoContacto">
                                <option value="cliente">Cliente</option>
                                <option value="proveedor">Proveedor</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Nombre/Raz√≥n Social:</label>
                            <input type="text" id="nombreContacto" required>
                        </div>
                        <div class="form-group">
                            <label>NIF/CIF:</label>
                            <input type="text" id="nifContacto" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Direcci√≥n:</label>
                            <input type="text" id="direccionContacto">
                        </div>
                        <div class="form-group">
                            <label>Email:</label>
                            <input type="email" id="emailContacto">
                        </div>
                        <div class="form-group">
                            <label>Tel√©fono:</label>
                            <input type="text" id="telefonoContacto">
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button type="submit" class="btn btn-success">üíæ Guardar</button>
                        <button type="button" class="btn btn-secondary" onclick="limpiarFormularioContacto()">üóëÔ∏è Limpiar</button>
                    </div>
                </form>
            </div>

            <table class="table">
                <thead>
                    <tr>
                        <th>Tipo</th>
                        <th>Nombre</th>
                        <th>NIF/CIF</th>
                        <th>Email</th>
                        <th>Tel√©fono</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="contactosTable">
                </tbody>
            </table>
        </div>

        <!-- Facturas Tab UNIFICADO -->
        <div id="facturas" class="tab-content">
            <h2>üìÑ Gesti√≥n Unificada de Facturas</h2>
            
            <!-- Sub-navegaci√≥n -->
            <div class="sub-nav-tabs">
                <button class="sub-nav-tab active" onclick="showSubTab('facturas-emitidas', this)">üì§ Facturas Emitidas</button>
                <button class="sub-nav-tab" onclick="showSubTab('recurrentes', this)">üîÑ Recurrentes</button>
                <button class="sub-nav-tab" onclick="showSubTab('facturas-recibidas', this)">üì• Facturas Recibidas</button>
                <button class="sub-nav-tab" onclick="showSubTab('listado-general', this)">üìã Listado General</button>
            </div>

            <!-- FACTURAS EMITIDAS -->
            <div id="facturas-emitidas" class="sub-tab-content active">
                <div class="factura-section">
                    <h3 id="tituloFacturaEmitida">üìù Nueva Factura Emitida</h3>
                    <form id="facturaEmitidaForm">
                        <input type="hidden" id="facturaEmitidaId" value="">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Fecha:</label>
                                <input type="date" id="fechaFacturaEmitida" required>
                            </div>
                            <div class="form-group">
                                <label>N√∫mero:</label>
                                <input type="text" id="numeroFacturaEmitida">
                            </div>
                            <div class="form-group">
                                <label>Vencimiento:</label>
                                <input type="date" id="vencimientoFacturaEmitida">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Cliente:</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="text" id="clienteFacturaEmitida" list="listaContactos" required style="flex: 1;">
                                    <button type="button" class="btn btn-success btn-small" onclick="abrirModalContactoRapido('cliente', 'clienteFacturaEmitida')" title="A√±adir cliente nuevo">
                                        ‚ûï
                                    </button>
                                </div>
                                <datalist id="listaContactos"></datalist>
                            </div>
                            <div class="form-group">
                                <label>NIF/CIF:</label>
                                <input type="text" id="nifFacturaEmitida">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Descripci√≥n:</label>
                            <textarea id="descripcionFacturaEmitida" rows="3" required></textarea>
                        </div>

                        <h4>üí∞ Conceptos</h4>
                        <div id="conceptosFacturaEmitida" class="conceptos-container">
                            <div class="concepto-item">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Concepto:</label>
                                        <input type="text" class="concepto-desc" placeholder="Descripci√≥n del servicio">
                                    </div>
                                    <div class="form-group">
                                        <label>Cantidad:</label>
                                        <input type="number" class="concepto-cantidad" value="1" min="1">
                                    </div>
                                    <div class="form-group">
                                        <label>Precio Unit.:</label>
                                        <input type="number" class="concepto-precio" step="0.01" min="0">
                                    </div>
                                    <div>
                                        <button type="button" class="btn btn-danger btn-small" onclick="eliminarConcepto(this)">üóëÔ∏è</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-success btn-small" onclick="agregarConceptoEmitida()">‚ûï A√±adir Concepto</button>

                        <div class="form-row" style="margin-top: 20px;">
                            <div class="form-group">
                                <label>Subtotal:</label>
                                <input type="number" id="subtotalFacturaEmitida" step="0.01" readonly>
                            </div>
                            <div class="form-group">
                                <label>IVA (%):</label>
                                <select id="ivaFacturaEmitida" onchange="calcularTotalesFacturaEmitida()">
                                    <option value="21">21%</option>
                                    <option value="10">10%</option>
                                    <option value="4">4%</option>
                                    <option value="0">0% (Exento)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>IVA (‚Ç¨):</label>
                                <input type="number" id="ivaImporteEmitida" step="0.01" readonly>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="checkbox-group">
                                <input type="checkbox" id="aplicarRetencionEmitida" onchange="calcularTotalesFacturaEmitida()">
                                <label for="aplicarRetencionEmitida">Aplicar retenci√≥n 15% IRPF</label>
                            </div>
                            <div class="form-group">
                                <label>Retenci√≥n (‚Ç¨):</label>
                                <input type="number" id="retencionImporteEmitida" step="0.01" readonly>
                            </div>
                            <div class="form-group">
                                <label>Total:</label>
                                <input type="number" id="totalFacturaEmitida" step="0.01" readonly style="font-weight: bold; font-size: 1.2em;">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Estado:</label>
                                <select id="estadoFacturaEmitida">
                                    <option value="Pendiente">Pendiente</option>
                                    <option value="Pagado">Cobrado</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Fecha de cobro:</label>
                                <input type="date" id="fechaCobroEmitida">
                            </div>
                            <div class="form-group">
                                <label>Forma de pago:</label>
                                <select id="formaPagoEmitida">
                                    <option value="">Sin especificar</option>
                                    <option value="Transferencia">Transferencia</option>
                                    <option value="Efectivo">Efectivo</option>
                                    <option value="Tarjeta">Tarjeta</option>
                                    <option value="Cheque">Cheque</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="permitirPagosParciales" onchange="togglePagosParciales()" style="width: auto;">
                                Gestionar pagos parciales
                            </label>
                        </div>
                    </div>

                    <div id="seccionPagosParciales" class="pagos-parciales-section" style="display: none;">
                        <h4>üí∞ Pagos Parciales Realizados</h4>
                        <div id="listaPagosParciales" style="min-height: 50px;">
                            <p style="color: #6c757d; font-style: italic;">No hay pagos parciales registrados.</p>
                        </div>
                        
                        <h5 style="margin-top: 20px;">‚ûï A√±adir Nuevo Pago Parcial</h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Fecha del pago:</label>
                                <input type="date" id="fechaPagoParcial">
                            </div>
                            <div class="form-group">
                                <label>Cantidad pagada:</label>
                                <input type="number" id="cantidadPagoParcial" step="0.01" min="0">
                            </div>
                            <div class="form-group" style="display: flex; align-items: flex-end;">
                                <button type="button" class="btn btn-success" onclick="a√±adirPagoParcial()">‚ûï A√±adir Pago</button>
                            </div>
                        </div>
                    </div>


                        <div class="form-row">
                            <div class="form-group">
                                <label>Tags:</label>
                                <input type="text" id="tagsFacturaEmitida" placeholder="Ej: consultor√≠a, asesoramiento">
                            </div>
                            <div class="form-group">
                                <label>Cuenta:</label>
                                <input type="text" id="cuentaFacturaEmitida" placeholder="Prestaciones de servicios">
                            </div>
                            <div class="form-group">
                                <label>Proyecto:</label>
                                <input type="text" id="proyectoFacturaEmitida">
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 30px;">
                            <button type="submit" class="btn btn-success">üíæ Guardar Factura</button>
                            <button type="button" class="btn btn-info" onclick="vistaPrevia('emitida')">üëÅÔ∏è Vista Previa</button>
                            <button type="button" class="btn btn-warning" onclick="crearRecurrente('emitida')">üîÑ Hacer Recurrente</button>
                            <button type="button" class="btn btn-secondary" onclick="limpiarFormularioFacturaEmitida()">üóëÔ∏è Limpiar</button>
                        </div>
                    </form>
                </div>

                <!-- Tabla de facturas emitidas -->
                <div class="filters-row">
                    <div class="filter-group">
                        <label>Buscar:</label>
                        <input type="text" id="buscarFacturaEmitida" placeholder="Buscar facturas emitidas..." onkeyup="filtrarFacturasEmitidas()" style="width: 300px;">
                    </div>
                    <div class="filter-group">
                        <label>Estado:</label>
                        <select id="filtroEstadoFacturaEmitida" onchange="filtrarFacturasEmitidas()">
                            <option value="">Todos</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="Pagado">Cobrado</option>
                        </select>
                    </div>
                </div>

                <div class="sort-filters">
                    <div class="sort-group">
                        <label>üîΩ Ordenar por:</label>
                        <select id="ordenFacturasEmitidas" onchange="aplicarOrdenFacturasEmitidas()">
                            <option value="fecha-desc">Fecha (m√°s reciente)</option>
                            <option value="fecha-asc">Fecha (m√°s antigua)</option>
                            <option value="numero-desc">N√∫mero (descendente)</option>
                            <option value="numero-asc">N√∫mero (ascendente)</option>
                            <option value="importe-desc">Importe (mayor a menor)</option>
                            <option value="importe-asc">Importe (menor a mayor)</option>
                        </select>
                    </div>
                    <div class="sort-group">
                        <label>üìÖ A√±o:</label>
                        <select id="filtroAnoEmitidas" onchange="filtrarFacturasEmitidas()">
                            <option value="">Todos los a√±os</option>
                        </select>
                    </div>
                    <div class="sort-group">
                        <label>üìä Trimestre:</label>
                        <select id="filtroTrimestreEmitidas" onchange="filtrarFacturasEmitidas()">
                            <option value="">Todos</option>
                            <option value="1">T1 (Ene-Mar)</option>
                            <option value="2">T2 (Abr-Jun)</option>
                            <option value="3">T3 (Jul-Sep)</option>
                            <option value="4">T4 (Oct-Dic)</option>
                        </select>
                    </div>
                </div>

                <table class="table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>N√∫mero</th>
                            <th>Cliente</th>
                            <th>Descripci√≥n</th>
                            <th>Total</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="facturasEmitidasTable">
                    </tbody>
                </table>
            </div>

            <!-- RECURRENTES -->
            <div id="recurrentes" class="sub-tab-content">
                <div class="recurrente-section">
                    <h3 id="tituloRecurrente">‚ûï Nueva Factura Recurrente</h3>
                    <form id="recurrenteForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Cliente:</label>
                                <select id="clienteRecurrente" required>
                                    <option value="">Seleccionar cliente...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Concepto:</label>
                                <input type="text" id="conceptoRecurrente" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Importe Base (‚Ç¨):</label>
                                <input type="number" id="importeRecurrente" step="0.01" min="0" required>
                            </div>
                            <div class="form-group">
                                <label>IVA (%):</label>
                                <select id="ivaRecurrente">
                                    <option value="21">21%</option>
                                    <option value="10">10%</option>
                                    <option value="4">4%</option>
                                    <option value="0">0% (Exento)</option>
                                </select>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="retencionRecurrente">
                                <label for="retencionRecurrente">Aplicar retenci√≥n 15%</label>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Frecuencia:</label>
                                <select id="frecuenciaRecurrente" required>
                                    <option value="mensual">Mensual</option>
                                    <option value="bimensual">Bimensual</option>
                                    <option value="trimestral">Trimestral</option>
                                    <option value="semestral">Semestral</option>
                                    <option value="anual">Anual</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>D√≠a de emisi√≥n:</label>
                                <input type="number" id="diaEmision" min="1" max="31" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Fecha de inicio:</label>
                                <input type="date" id="fechaInicioRecurrente" required>
                            </div>
                            <div class="form-group">
                                <label>Fecha de fin (opcional):</label>
                                <input type="date" id="fechaFinRecurrente">
                            </div>
                        </div>
                        
                        <div class="checkbox-group">
                            <input type="checkbox" id="enviarEmailRecurrente" checked>
                            <label for="enviarEmailRecurrente">Enviar autom√°ticamente por email</label>
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button type="submit" class="btn btn-success">üíæ Crear Recurrente</button>
                            <button type="button" class="btn btn-secondary" onclick="limpiarFormularioRecurrente()">üóëÔ∏è Limpiar</button>
                        </div>
                    </form>
                </div>
                
                <!-- Filtros para Recurrentes -->
                <div class="filters-row">
                    <div class="filter-group">
                        <label>Buscar:</label>
                        <input type="text" id="buscarRecurrente" placeholder="Buscar recurrentes..." onkeyup="filtrarRecurrentes()" style="width: 300px;">
                    </div>
                    <div class="filter-group">
                        <label>Estado:</label>
                        <select id="filtroEstadoRecurrente" onchange="filtrarRecurrentes()">
                            <option value="">Todos</option>
                            <option value="activa">Activa</option>
                            <option value="pausada">Pausada</option>
                            <option value="finalizada">Finalizada</option>
                        </select>
                    </div>
                </div>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Concepto</th>
                            <th>Importe</th>
                            <th>Frecuencia</th>
                            <th>Pr√≥xima</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="recurrentesTable">
                    </tbody>
                </table>
            </div>

            <!-- FACTURAS RECIBIDAS -->
            <div id="facturas-recibidas" class="sub-tab-content">
                <div class="factura-section">
                    <h3 id="tituloFacturaRecibida">üìù Nueva Factura Recibida</h3>
                    <form id="facturaRecibidaForm">
                        <input type="hidden" id="facturaRecibidaId" value="">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Fecha:</label>
                                <input type="date" id="fechaFacturaRecibida" required>
                            </div>
                            <div class="form-group">
                                <label>N√∫mero:</label>
                                <input type="text" id="numeroFacturaRecibida">
                            </div>
                            <div class="form-group">
                                <label>Vencimiento:</label>
                                <input type="date" id="vencimientoFacturaRecibida">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Proveedor:</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="text" id="proveedorFacturaRecibida" list="listaContactos" required style="flex: 1;">
                                    <button type="button" class="btn btn-success btn-small" onclick="abrirModalContactoRapido('proveedor', 'proveedorFacturaRecibida')" title="A√±adir proveedor nuevo">
                                        ‚ûï
                                    </button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>NIF/CIF:</label>
                                <input type="text" id="nifFacturaRecibida">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Descripci√≥n:</label>
                            <textarea id="descripcionFacturaRecibida" rows="3" required></textarea>
                        </div>

                        <h4>üí∞ Conceptos</h4>
                        <div id="conceptosFacturaRecibida" class="conceptos-container">
                            <div class="concepto-item">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Concepto:</label>
                                        <input type="text" class="concepto-desc" placeholder="Descripci√≥n del servicio">
                                    </div>
                                    <div class="form-group">
                                        <label>Cantidad:</label>
                                        <input type="number" class="concepto-cantidad" value="1" min="1">
                                    </div>
                                    <div class="form-group">
                                        <label>Precio Unit.:</label>
                                        <input type="number" class="concepto-precio" step="0.01" min="0">
                                    </div>
                                    <div>
                                        <button type="button" class="btn btn-danger btn-small" onclick="eliminarConcepto(this)">üóëÔ∏è</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-success btn-small" onclick="agregarConceptoRecibida()">‚ûï A√±adir Concepto</button>

                        <div class="form-row" style="margin-top: 20px;">
                            <div class="form-group">
                                <label>Subtotal:</label>
                                <input type="number" id="subtotalFacturaRecibida" step="0.01" readonly>
                            </div>
                            <div class="form-group">
                                <label>IVA (%):</label>
                                <select id="ivaFacturaRecibida" onchange="calcularTotalesFacturaRecibida()">
                                    <option value="21">21%</option>
                                    <option value="10">10%</option>
                                    <option value="4">4%</option>
                                    <option value="0">0% (Exento)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>IVA (‚Ç¨):</label>
                                <input type="number" id="ivaImporteRecibida" step="0.01" readonly>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Total:</label>
                                <input type="number" id="totalFacturaRecibida" step="0.01" readonly style="font-weight: bold; font-size: 1.2em;">
                            </div>
                            <div class="form-group">
                                <label>Estado:</label>
                                <select id="estadoFacturaRecibida">
                                    <option value="Pendiente">Pendiente</option>
                                    <option value="Pagado">Pagado</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Fecha de pago:</label>
                                <input type="date" id="fechaPagoRecibida">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Tags:</label>
                                <input type="text" id="tagsFacturaRecibida" placeholder="Ej: suministros, servicios">
                            </div>
                            <div class="form-group">
                                <label>Cuenta:</label>
                                <input type="text" id="cuentaFacturaRecibida" placeholder="Otros servicios">
                            </div>
                            <div class="form-group">
                                <label>Proyecto:</label>
                                <input type="text" id="proyectoFacturaRecibida">
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 30px;">
                            <button type="submit" class="btn btn-success">üíæ Guardar Factura</button>
                            <button type="button" class="btn btn-info" onclick="vistaPrevia('recibida')">üëÅÔ∏è Vista Previa</button>
                            <button type="button" class="btn btn-secondary" onclick="limpiarFormularioFacturaRecibida()">üóëÔ∏è Limpiar</button>
                        </div>
                    </form>
                </div>

                <!-- Tabla de facturas recibidas -->
                <div class="filters-row">
                    <div class="filter-group">
                        <label>Buscar:</label>
                        <input type="text" id="buscarFacturaRecibida" placeholder="Buscar facturas recibidas..." onkeyup="filtrarFacturasRecibidas()" style="width: 300px;">
                    </div>
                    <div class="filter-group">
                        <label>Estado:</label>
                        <select id="filtroEstadoFacturaRecibida" onchange="filtrarFacturasRecibidas()">
                            <option value="">Todos</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="Pagado">Pagado</option>
                        </select>
                    </div>
                </div>

                                <div class="sort-filters">
                    <div class="sort-group">
                        <label>üîΩ Ordenar por:</label>
                        <select id="ordenFacturasRecibidas" onchange="aplicarOrdenFacturasRecibidas()">
                            <option value="fecha-desc">Fecha (m√°s reciente)</option>
                            <option value="fecha-asc">Fecha (m√°s antigua)</option>
                            <option value="numero-desc">N√∫mero (descendente)</option>
                            <option value="numero-asc">N√∫mero (ascendente)</option>
                            <option value="importe-desc">Importe (mayor a menor)</option>
                            <option value="importe-asc">Importe (menor a mayor)</option>
                        </select>
                    </div>
                    <div class="sort-group">
                        <label>üìÖ A√±o:</label>
                        <select id="filtroAnoRecibidas" onchange="filtrarFacturasRecibidas()">
                            <option value="">Todos los a√±os</option>
                        </select>
                    </div>
                    <div class="sort-group">
                        <label>üìä Trimestre:</label>
                        <select id="filtroTrimestreRecibidas" onchange="filtrarFacturasRecibidas()">
                            <option value="">Todos</option>
                            <option value="1">T1 (Ene-Mar)</option>
                            <option value="2">T2 (Abr-Jun)</option>
                            <option value="3">T3 (Jul-Sep)</option>
                            <option value="4">T4 (Oct-Dic)</option>
                        </select>
                    </div>
                </div>


                <table class="table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>N√∫mero</th>
                            <th>Proveedor</th>
                            <th>Descripci√≥n</th>
                            <th>Total</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="facturasRecibidasTable">
                    </tbody>
                </table>
            </div>

            <!-- LISTADO GENERAL -->
            <div id="listado-general" class="sub-tab-content">
                <h3>üìã Listado General de Operaciones</h3>
                
                <div class="filters-row">
                    <div class="filter-group">
                        <label>Buscar:</label>
                        <input type="text" id="buscarGeneral" placeholder="Buscar en todas las operaciones..." onkeyup="filtrarGeneral()" style="width: 350px;">
                    </div>
                    <div class="filter-group">
                        <label>Tipo:</label>
                        <select id="filtroTipoGeneral" onchange="filtrarGeneral()">
                            <option value="">Todos</option>
                            <option value="factura-emitida">Facturas Emitidas</option>
                            <option value="factura-recibida">Facturas Recibidas</option>
                            <option value="recurrente">Recurrentes</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Estado:</label>
                        <select id="filtroEstadoGeneral" onchange="filtrarGeneral()">
                            <option value="">Todos</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="Pagado">Pagado/Cobrado</option>
                        </select>
                    </div>
                </div>

                <table class="table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Tipo</th>
                            <th>N√∫mero</th>
                            <th>Cliente/Proveedor</th>
                            <th>Descripci√≥n</th>
                            <th>Total</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="listadoGeneralTable">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Excel Tab -->
        <div id="excel" class="tab-content">
            <h2>üìä Importar/Exportar Datos</h2>
            
            <div class="import-section">
                <h3>üì• Importar Datos desde Excel</h3>
                <p>Importa tus datos desde archivos Excel. El sistema es compatible con tu formato actual.</p>
                
                <div class="form-row">
                    <div class="file-upload">
                        <input type="file" id="importarExcel" accept=".xlsx,.xls,.csv" onchange="importarArchivo(this)">
                        <label for="importarExcel" class="file-upload-label">üìÅ Seleccionar Archivo Excel</label>
                    </div>
                    
                    <button class="btn btn-info" onclick="verPlantillaEjemplo()">üìã Ver Formato Esperado</button>
                </div>
                
                <div id="importStatus" style="margin-top: 20px;"></div>
            </div>

            <div class="config-section" style="margin-top: 30px;">
                <h3>üì§ Exportar Datos</h3>
                
                <div class="form-row" style="margin-bottom: 20px; gap: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label>üìÖ A√±o:</label>
                        <select id="a√±oExportar" style="padding: 10px; border-radius: 5px; width: 100%;">
                            <option value="2023">2023</option>
                            <option value="2024">2024</option>
                            <option value="2025" selected>2025</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>üìä Per√≠odo:</label>
                        <select id="periodoExportar" style="padding: 10px; border-radius: 5px; width: 100%;">
                            <option value="all">Todo el a√±o</option>
                            <option value="Q1">1er Trimestre (Ene-Mar)</option>
                            <option value="Q2">2do Trimestre (Abr-Jun)</option>
                            <option value="Q3">3er Trimestre (Jul-Sep)</option>
                            <option value="Q4">4to Trimestre (Oct-Dic)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row" style="margin-bottom: 15px;">
                    <button class="btn btn-success" onclick="exportarSoloIngresos()">üìà Exportar Ingresos</button>
                    <button class="btn btn-danger" onclick="exportarSoloGastos()">üìâ Exportar Gastos</button>
                    <button class="btn btn-primary" onclick="exportarIngresosYGastos()">üìä Exportar Ingresos + Gastos</button>
                </div>
                
                <div class="form-row">
                    <button class="btn btn-success" onclick="exportarClientes()">üë• Exportar Clientes</button>
                    <button class="btn btn-primary" onclick="exportarTodo()">üì¶ Exportar Todo Completo</button>
                </div>
            </div>

            <div class="config-section" style="margin-top: 30px;">
                <h3>‚ö†Ô∏è Reseteo Selectivo de Datos por A√±o</h3>
                <p style="color: #e74c3c; font-weight: 600;">Elige el a√±o y qu√© datos quieres eliminar</p>
                
                <div class="form-group" style="max-width: 300px; margin: 20px 0;">
                    <label>üìÖ Selecciona el a√±o a resetear:</label>
                    <select id="a√±oResetear" onchange="actualizarContadoresReset()">
                        <option value="2023">2023</option>
                        <option value="2024">2024</option>
                        <option value="2025" selected>2025</option>
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                    </select>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 15px 0;">
                    <div class="checkbox-group" style="margin: 10px 0;">
                        <input type="checkbox" id="resetFacturasEmitidas">
                        <label for="resetFacturasEmitidas">üìÑ Facturas Emitidas <span id="contadorEmitidas" style="color: #7f8c8d;">(0)</span></label>
                    </div>
                    
                    <div class="checkbox-group" style="margin: 10px 0;">
                        <input type="checkbox" id="resetFacturasRecibidas">
                        <label for="resetFacturasRecibidas">üì• Facturas Recibidas <span id="contadorRecibidas" style="color: #7f8c8d;">(0)</span></label>
                    </div>
                    
                    <div class="checkbox-group" style="margin: 10px 0;">
                        <input type="checkbox" id="resetClientes">
                        <label for="resetClientes">üë• Clientes <span id="contadorClientes" style="color: #7f8c8d;">(0)</span></label>
                    </div>
                    
                    <div class="checkbox-group" style="margin: 10px 0;">
                        <input type="checkbox" id="resetProveedores">
                        <label for="resetProveedores">üè™ Proveedores <span id="contadorProveedores" style="color: #7f8c8d;">(0)</span></label>
                    </div>
                    
                    <div class="checkbox-group" style="margin: 10px 0;">
                        <input type="checkbox" id="resetRecurrentes">
                        <label for="resetRecurrentes">üîÑ Facturas Recurrentes <span id="contadorRecurrentes" style="color: #7f8c8d;">(0)</span></label>
                    </div>
                    
                    <hr style="margin: 15px 0; border: 1px solid #dee2e6;">
                    
                    <div class="checkbox-group" style="margin: 10px 0;">
                        <input type="checkbox" id="resetTodo" onchange="toggleResetTodo()">
                        <label for="resetTodo" style="font-weight: 700; color: #e74c3c;">üóëÔ∏è Seleccionar TODO del a√±o</label>
                    </div>
                </div>
                
                <div class="form-row">
                    <button class="btn btn-danger" onclick="resetearDatosSelectivo()" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                        üóëÔ∏è Eliminar Seleccionados
                    </button>
                    <button class="btn btn-secondary" onclick="limpiarSeleccionReset()">
                        ‚Ü©Ô∏è Desmarcar Todo
                    </button>
                </div>
                
                <p style="font-size: 0.9em; color: #7f8c8d; margin-top: 10px;">
                    ‚ö†Ô∏è <strong>Importante:</strong> Esta acci√≥n NO se puede deshacer. Aseg√∫rate de exportar tus datos antes si los necesitas.
                </p>
            </div>

            <div class="config-section" style="margin-top: 30px;">
                <h3>üìã Plantillas de Ejemplo e Importar Clientes</h3>
                <p>Descarga estas plantillas para ver el formato correcto de importaci√≥n.</p>
                
                <div class="form-row">
                    <button class="btn btn-secondary" onclick="descargarPlantillaCompleta()">üìä Plantilla Completa</button>
                    <button class="btn btn-secondary" onclick="descargarPlantillaClientes()">üë• Plantilla Clientes</button>
                </div>

                <div class="form-row" style="margin-top: 20px;">
                    <div class="file-upload">
                        <input type="file" id="importarClientes" accept=".xlsx,.xls,.csv" onchange="importarClientesExcel(this)">
                        <label for="importarClientes" class="file-upload-label">üë• Importar Clientes Excel</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modelo 130 Tab -->
        <div id="modelo130" class="tab-content">
            <h2>üìã Modelo 130 - Pago Fraccionado IRPF</h2>
            <div class="form-group">
                <label>Trimestre:</label>
                <select id="trimestreM130" onchange="generarModelo130()">
                    <option value="">Selecciona trimestre</option>
                    <option value="Q1">1¬∫ Trimestre</option>
                    <option value="Q2">2¬∫ Trimestre</option>
                    <option value="Q3">3¬∫ Trimestre</option>
                    <option value="Q4">4¬∫ Trimestre</option>
                </select>
            </div>

            <div id="modelo130Content" class="form-model" style="display: none;">
                <h3>üìÑ Modelo 130 - <span id="trimestreSeleccionado"></span></h3>
                
                <div class="model-section">
                    <h4>I. Actividades econ√≥micas en estimaci√≥n directa</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>01. Ingresos del trimestre:</label>
                            <input type="number" id="m130_ingresos" class="readonly-field" readonly>
                        </div>
                        <div class="form-group">
                            <label>02. Gastos del trimestre:</label>
                            <input type="number" id="m130_gastos" class="readonly-field" readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>03. Rendimiento (01 - 02):</label>
                            <input type="number" id="m130_rendimiento" class="readonly-field" readonly>
                        </div>
                        <div class="form-group">
                            <label>04. Rendimiento acumulado:</label>
                            <input type="number" id="m130_rendimiento_acum" class="readonly-field" readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>05. 20% sobre rendimiento acumulado:</label>
                            <input type="number" id="m130_20_porciento" class="readonly-field" readonly>
                        </div>
                        <div class="form-group">
                            <label>06. Pagos anteriores:</label>
                            <input type="number" id="m130_pagos_anteriores" value="0" onchange="calcularResultadoM130()">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>07. Resultado (05 - 06):</label>
                        <input type="number" id="m130_resultado" class="readonly-field" readonly>
                    </div>
                </div>

                <button class="btn btn-success" onclick="descargarModelo130()">üì• Descargar Modelo 130</button>
            </div>
        </div>

        <!-- Modelo 303 Tab -->
        <div id="modelo303" class="tab-content">
            <h2>üìÑ Modelo 303 - Autoliquidaci√≥n IVA</h2>
            <div class="form-group">
                <label>Trimestre:</label>
                <select id="trimestreM303" onchange="generarModelo303()">
                    <option value="">Selecciona trimestre</option>
                    <option value="Q1">1¬∫ Trimestre</option>
                    <option value="Q2">2¬∫ Trimestre</option>
                    <option value="Q3">3¬∫ Trimestre</option>
                    <option value="Q4">4¬∫ Trimestre</option>
                </select>
            </div>

            <div id="modelo303Content" class="form-model" style="display: none;">
                <h3>üìÑ Modelo 303 - <span id="trimestreSeleccionado303"></span></h3>
                
                <div class="model-section">
                    <h4>IVA Devengado</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>01. Base imponible operaciones 21%:</label>
                            <input type="number" id="m303_base_21" class="readonly-field" readonly>
                        </div>
                        <div class="form-group">
                            <label>02. Cuota 21%:</label>
                            <input type="number" id="m303_cuota_21" class="readonly-field" readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>03. Base imponible operaciones 10%:</label>
                            <input type="number" id="m303_base_10" class="readonly-field" readonly>
                        </div>
                        <div class="form-group">
                            <label>04. Cuota 10%:</label>
                            <input type="number" id="m303_cuota_10" class="readonly-field" readonly>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>27. Total cuota devengada:</label>
                        <input type="number" id="m303_total_devengado" class="readonly-field" readonly>
                    </div>
                </div>

                <div class="model-section">
                    <h4>IVA Deducible</h4>
                    <div class="form-group">
                        <label>29. IVA soportado:</label>
                        <input type="number" id="m303_iva_soportado" class="readonly-field" readonly>
                    </div>
                    <div class="form-group">
                        <label>46. Resultado (27 - 29):</label>
                        <input type="number" id="m303_resultado" class="readonly-field" readonly>
                    </div>
                </div>

                <button class="btn btn-success" onclick="descargarModelo303()">üì• Descargar Modelo 303</button>
            </div>
        </div>

        <!-- Anual Tab -->
        <div id="anual" class="tab-content">
            <h2>üìÖ Resumen Anual</h2>
            <div class="form-group">
                <label>A√±o:</label>
                <select id="a√±oAnual" onchange="generarResumenAnual()">
                    <option value="">Selecciona a√±o</option>
                    <option value="2024">2024</option>
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                </select>
            </div>

            <div id="resumenAnualContent" style="display: none;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Ingresos Anuales</h3>
                        <div class="amount" id="ingresosAnual">‚Ç¨0.00</div>
                    </div>
                    <div class="stat-card">
                        <h3>Gastos Anuales</h3>
                        <div class="amount" id="gastosAnual">‚Ç¨0.00</div>
                    </div>
                    <div class="stat-card">
                        <h3>Beneficio Anual</h3>
                        <div class="amount" id="beneficioAnual">‚Ç¨0.00</div>
                    </div>
                    <div class="stat-card">
                        <h3>IVA Liquidado</h3>
                        <div class="amount" id="ivaAnual">‚Ç¨0.00</div>
                    </div>
                </div>

                <div class="form-model">
                    <h4>üìä An√°lisis por Trimestres</h4>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Trimestre</th>
                                <th>Ingresos</th>
                                <th>Gastos</th>
                                <th>Beneficio</th>
                                <th>IVA</th>
                            </tr>
                        </thead>
                        <tbody id="trimestresTable">
                        </tbody>
                    </table>
                </div>

                <button class="btn btn-success" onclick="exportarDatos()">üì§ Exportar Datos</button>
                <button class="btn btn-secondary" onclick="generarInformeAnual()">üìã Generar Informe Anual</button>
            </div>
        </div>
    </div>

    <!-- Modal para vista previa -->
    <div id="modalPreview" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="cerrarModal()">&times;</span>
            <div id="previewContent"></div>
        </div>
    </div>

    <!-- Modal para a√±adir contacto r√°pido -->
    <div id="modalContactoRapido" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="modal-close" onclick="cerrarModalContactoRapido()">&times;</span>
            <h3 id="tituloContactoRapido">‚ûï A√±adir Cliente R√°pido</h3>
            <form id="formContactoRapido" onsubmit="guardarContactoRapido(event)">
                <div class="form-group">
                    <label>Nombre / Raz√≥n Social: *</label>
                    <input type="text" id="nombreContactoRapido" required>
                </div>
                
                <div class="form-group">
                    <label>NIF/CIF:</label>
                    <input type="text" id="nifContactoRapido">
                </div>
                
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="emailContactoRapido">
                </div>
                
                <div class="form-group">
                    <label>Tel√©fono:</label>
                    <input type="tel" id="telefonoContactoRapido">
                </div>
                
                <div class="form-group">
                    <label>Direcci√≥n:</label>
                    <textarea id="direccionContactoRapido" rows="2"></textarea>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button type="submit" class="btn btn-success">‚úÖ Guardar y Usar</button>
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalContactoRapido()">‚ùå Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ===============================
        // VARIABLES GLOBALES Y CONFIGURACI√ìN
        // ===============================
        let ejercicioActual = localStorage.getItem('ejercicioActual') || '2025';
        let datos = {};
        let configDespacho = JSON.parse(localStorage.getItem('configDespacho')) || {};
        let configuracionEmail = JSON.parse(localStorage.getItem('configuracionEmail')) || {};

        // Estructura de datos por ejercicio UNIFICADA
        function inicializarDatos() {
            const datosGuardados = localStorage.getItem(`datos_${ejercicioActual}`);
            if (datosGuardados) {
                datos = JSON.parse(datosGuardados);
                
                // Migrar datos antiguos SOLO UNA VEZ para evitar duplicaciones
                let migracionRealizada = localStorage.getItem(`migracion_${ejercicioActual}`);
                
                if (!migracionRealizada) {
                    // Migrar ingresosDirectos a facturasEmitidas
                    if (datos.ingresosDirectos && datos.ingresosDirectos.length > 0) {
                        if (!datos.facturasEmitidas) datos.facturasEmitidas = [];
                        
                        // Convertir ingresos directos a facturas emitidas
                        datos.ingresosDirectos.forEach(ingreso => {
                            const facturaEmitida = {
                                ...ingreso,
                                tipo: 'factura-emitida',
                                numero: ingreso.numero || `ING-${ingreso.id}`,
                                cliente: ingreso.cliente,
                                conceptos: [{
                                    descripcion: ingreso.descripcion,
                                    cantidad: 1,
                                    precio: ingreso.subtotal,
                                    total: ingreso.subtotal
                                }],
                                ivaImporte: ingreso.iva || 0,
                                retencion: ingreso.retencion || 0,
                                fechaCobro: ingreso.fechaCobro
                            };
                            datos.facturasEmitidas.push(facturaEmitida);
                        });
                        
                        // Eliminar ingresosDirectos para evitar duplicaciones
                        delete datos.ingresosDirectos;
                    }
                    
                    // Migrar gastosDirectos a facturasRecibidas
                    if (datos.gastosDirectos && datos.gastosDirectos.length > 0) {
                        if (!datos.facturasRecibidas) datos.facturasRecibidas = [];
                        
                        // Convertir gastos directos a facturas recibidas
                        datos.gastosDirectos.forEach(gasto => {
                            const facturaRecibida = {
                                ...gasto,
                                tipo: 'factura-recibida',
                                numero: gasto.numero || `GAS-${gasto.id}`,
                                proveedor: gasto.proveedor,
                                conceptos: [{
                                    descripcion: gasto.descripcion,
                                    cantidad: 1,
                                    precio: gasto.subtotal,
                                    total: gasto.subtotal
                                }],
                                ivaImporte: gasto.iva || 0,
                                fechaPago: gasto.fechaPago
                            };
                            datos.facturasRecibidas.push(facturaRecibida);
                        });
                        
                        // Eliminar gastosDirectos para evitar duplicaciones
                        delete datos.gastosDirectos;
                    }
                    
                    // Migrar facturas antiguas si existen
                    if (datos.facturas && !datos.facturasEmitidas) {
                        datos.facturasEmitidas = datos.facturas.filter(f => f.tipo === 'ingreso').map(f => ({
                            ...f,
                            tipo: 'factura-emitida'
                        }));
                        
                        const facturasGasto = datos.facturas.filter(f => f.tipo === 'gasto').map(f => ({
                            ...f,
                            tipo: 'factura-recibida'
                        }));
                        
                        if (!datos.facturasRecibidas) datos.facturasRecibidas = [];
                        datos.facturasRecibidas.push(...facturasGasto);
                        
                        delete datos.facturas;
                    }
                    
                    // Marcar migraci√≥n como completada
                    localStorage.setItem(`migracion_${ejercicioActual}`, 'true');
                    guardarDatos(); // Guardar los cambios
                }
                
                // Asegurar que todas las propiedades existen
                if (!datos.facturasEmitidas) datos.facturasEmitidas = [];
                if (!datos.facturasRecibidas) datos.facturasRecibidas = [];
                if (!datos.clientes) datos.clientes = [];
                if (!datos.proveedores) datos.proveedores = [];
                if (!datos.recurrentes) datos.recurrentes = [];
                if (!datos.contadorFacturas) datos.contadorFacturas = 1;
            } else {
                datos = {
                    facturasEmitidas: [],
                    facturasRecibidas: [],
                    clientes: [],
                    proveedores: [],
                    recurrentes: [],
                    contadorFacturas: 1
                };
            }
        }

        // ===============================
        // INICIALIZACI√ìN
        // ===============================
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('ejercicioActual').value = ejercicioActual;
            document.getElementById('ejercicioDashboard').textContent = ejercicioActual;
            
            // Inicializar selector de a√±o para reseteo
            const a√±oResetear = document.getElementById('a√±oResetear');
            if (a√±oResetear) {
                a√±oResetear.value = ejercicioActual;
                // Actualizar contadores del a√±o seleccionado
                actualizarContadoresReset();
            }
            
            inicializarDatos();
            cargarConfiguracion();
            
            if (configuracionEmail.user_id) {
                emailjs.init(configuracionEmail.user_id);
            }
            
            updateDashboard();
            updateAllTables();
            actualizarListaContactos();
            
            // Establecer fecha actual por defecto
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fechaFacturaEmitida').value = today;
            document.getElementById('fechaFacturaRecibida').value = today;
            
            // Inicializar n√∫mero de factura
            generarNumeroFactura();

            // Agregar listeners para c√°lculo autom√°tico en conceptos
            document.addEventListener('change', function(e) {
                if (e.target.matches('.concepto-cantidad, .concepto-precio')) {
                    if (e.target.closest('#conceptosFacturaEmitida')) {
                        calcularTotalesFacturaEmitida();
                    } else if (e.target.closest('#conceptosFacturaRecibida')) {
                        calcularTotalesFacturaRecibida();
                    }
                }
            });
        });

        // ===============================
        // FUNCIONES DE NAVEGACI√ìN
        // ===============================
        function showTab(tabName, clickedButton) {
            // Ocultar todas las pesta√±as
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.classList.remove('active');
                tab.style.display = 'none';
            });
            
            // Remover clase active de todos los botones
            const buttons = document.querySelectorAll('.nav-tab');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Mostrar la pesta√±a seleccionada
            const selectedTab = document.getElementById(tabName);
            if (selectedTab) {
                selectedTab.classList.add('active');
                selectedTab.style.display = 'block';
            }
            
            // Activar el bot√≥n clicado
            if (clickedButton) {
                clickedButton.classList.add('active');
            }
        }

        function showSubTab(subTabName, clickedButton) {
            // Ocultar todas las sub-pesta√±as
            const subTabs = document.querySelectorAll('.sub-tab-content');
            subTabs.forEach(tab => {
                tab.classList.remove('active');
                tab.style.display = 'none';
            });
            
            // Remover clase active de todos los sub-botones
            const subButtons = document.querySelectorAll('.sub-nav-tab');
            subButtons.forEach(btn => btn.classList.remove('active'));
            
            // Mostrar la sub-pesta√±a seleccionada
            const selectedSubTab = document.getElementById(subTabName);
            if (selectedSubTab) {
                selectedSubTab.classList.add('active');
                selectedSubTab.style.display = 'block';
            }
            
            // Activar el sub-bot√≥n clicado
            if (clickedButton) {
                clickedButton.classList.add('active');
            }
        }

        function cambiarEjercicio() {
            guardarDatos(); // Guardar datos actuales
            ejercicioActual = document.getElementById('ejercicioActual').value;
            localStorage.setItem('ejercicioActual', ejercicioActual);
            inicializarDatos(); // Cargar datos del nuevo ejercicio
            updateDashboard();
            updateAllTables();
            document.getElementById('ejercicioDashboard').textContent = ejercicioActual;
        }

        // ===============================
        // FUNCIONES DE UTILIDAD
        // ===============================
        function formatCurrency(amount) {
            const num = parseFloat(amount) || 0;
            return new Intl.NumberFormat('es-ES', {
                style: 'currency',
                currency: 'EUR'
            }).format(num);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES');
        }

        function parseSpanishNumber(str) {
            if (!str) return 0;
            str = str.toString().replace(/\s+/g, '').replace('‚Ç¨', '');
            str = str.replace(',', '.');
            return parseFloat(str) || 0;
        }

        function mostrarNotificacion(mensaje, tipo = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${tipo}`;
            notification.innerHTML = mensaje;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        function guardarDatos() {
            console.log('üíæ Guardando datos en localStorage...');
            console.log('Ejercicio actual:', ejercicioActual);
            console.log('Facturas emitidas:', datos.facturasEmitidas?.length || 0);
            console.log('Facturas recibidas:', datos.facturasRecibidas?.length || 0);
            localStorage.setItem(`datos_${ejercicioActual}`, JSON.stringify(datos));
            console.log('‚úÖ Datos guardados correctamente');
        }

        // Funci√≥n para verificar si una factura ya existe (evitar duplicados)
        function facturaExiste(tipo, numero, fecha) {
            const facturas = tipo === 'emitida' ? datos.facturasEmitidas : datos.facturasRecibidas;
            return facturas.some(f => 
                f.numero === numero && 
                f.fecha === fecha
            );
        }

        // Funci√≥n para cargar datos de un a√±o espec√≠fico (sin cambiar el a√±o actual)
        function cargarDatosA√±o(a√±o) {
            const datosGuardados = localStorage.getItem(`datos_${a√±o}`);
            if (datosGuardados) {
                return JSON.parse(datosGuardados);
            } else {
                return {
                    facturasEmitidas: [],
                    facturasRecibidas: [],
                    clientes: [],
                    proveedores: [],
                    recurrentes: [],
                    contadorFacturas: 1
                };
            }
        }

        // Funci√≥n para actualizar los contadores de datos del a√±o seleccionado
        function actualizarContadoresReset() {
            const a√±oSeleccionado = document.getElementById('a√±oResetear').value;
            const datosA√±o = cargarDatosA√±o(a√±oSeleccionado);
            
            document.getElementById('contadorEmitidas').textContent = `(${datosA√±o.facturasEmitidas?.length || 0})`;
            document.getElementById('contadorRecibidas').textContent = `(${datosA√±o.facturasRecibidas?.length || 0})`;
            document.getElementById('contadorClientes').textContent = `(${datosA√±o.clientes?.length || 0})`;
            document.getElementById('contadorProveedores').textContent = `(${datosA√±o.proveedores?.length || 0})`;
            document.getElementById('contadorRecurrentes').textContent = `(${datosA√±o.recurrentes?.length || 0})`;
        }

        // Funci√≥n para marcar/desmarcar todas las opciones de reseteo
        function toggleResetTodo() {
            const todoChecked = document.getElementById('resetTodo').checked;
            document.getElementById('resetFacturasEmitidas').checked = todoChecked;
            document.getElementById('resetFacturasRecibidas').checked = todoChecked;
            document.getElementById('resetClientes').checked = todoChecked;
            document.getElementById('resetProveedores').checked = todoChecked;
            document.getElementById('resetRecurrentes').checked = todoChecked;
        }

        // Funci√≥n para limpiar la selecci√≥n
        function limpiarSeleccionReset() {
            document.getElementById('resetTodo').checked = false;
            document.getElementById('resetFacturasEmitidas').checked = false;
            document.getElementById('resetFacturasRecibidas').checked = false;
            document.getElementById('resetClientes').checked = false;
            document.getElementById('resetProveedores').checked = false;
            document.getElementById('resetRecurrentes').checked = false;
        }

        // Funci√≥n de reseteo selectivo por a√±o
        function resetearDatosSelectivo() {
            const a√±oSeleccionado = document.getElementById('a√±oResetear').value;
            const resetFacturasEmitidas = document.getElementById('resetFacturasEmitidas').checked;
            const resetFacturasRecibidas = document.getElementById('resetFacturasRecibidas').checked;
            const resetClientes = document.getElementById('resetClientes').checked;
            const resetProveedores = document.getElementById('resetProveedores').checked;
            const resetRecurrentes = document.getElementById('resetRecurrentes').checked;
            
            // Verificar que al menos una opci√≥n est√© seleccionada
            if (!resetFacturasEmitidas && !resetFacturasRecibidas && !resetClientes && !resetProveedores && !resetRecurrentes) {
                alert('‚ö†Ô∏è Por favor, selecciona al menos un tipo de dato para eliminar.');
                return;
            }
            
            // Cargar los datos del a√±o seleccionado
            const datosA√±o = cargarDatosA√±o(a√±oSeleccionado);
            
            // Crear mensaje de confirmaci√≥n personalizado
            let mensaje = `‚ö†Ô∏è Vas a eliminar del A√ëO ${a√±oSeleccionado}:\n\n`;
            let elementosAEliminar = [];
            
            if (resetFacturasEmitidas && datosA√±o.facturasEmitidas) {
                mensaje += `üìÑ ${datosA√±o.facturasEmitidas.length} Facturas Emitidas\n`;
                elementosAEliminar.push('Facturas Emitidas');
            }
            if (resetFacturasRecibidas && datosA√±o.facturasRecibidas) {
                mensaje += `üì• ${datosA√±o.facturasRecibidas.length} Facturas Recibidas\n`;
                elementosAEliminar.push('Facturas Recibidas');
            }
            if (resetClientes && datosA√±o.clientes) {
                mensaje += `üë• ${datosA√±o.clientes.length} Clientes\n`;
                elementosAEliminar.push('Clientes');
            }
            if (resetProveedores && datosA√±o.proveedores) {
                mensaje += `üè™ ${datosA√±o.proveedores.length} Proveedores\n`;
                elementosAEliminar.push('Proveedores');
            }
            if (resetRecurrentes && datosA√±o.recurrentes) {
                mensaje += `üîÑ ${datosA√±o.recurrentes.length} Facturas Recurrentes\n`;
                elementosAEliminar.push('Facturas Recurrentes');
            }
            
            mensaje += '\n¬øEst√°s seguro? Esta acci√≥n NO se puede deshacer.';
            
            if (confirm(mensaje)) {
                // Resetear los datos seleccionados del a√±o espec√≠fico
                if (resetFacturasEmitidas) datosA√±o.facturasEmitidas = [];
                if (resetFacturasRecibidas) datosA√±o.facturasRecibidas = [];
                if (resetClientes) datosA√±o.clientes = [];
                if (resetProveedores) datosA√±o.proveedores = [];
                if (resetRecurrentes) datosA√±o.recurrentes = [];
                
                // Guardar los cambios en ese a√±o espec√≠fico
                localStorage.setItem(`datos_${a√±oSeleccionado}`, JSON.stringify(datosA√±o));
                
                // Si el a√±o resetado es el a√±o actual, recargar los datos
                if (a√±oSeleccionado === ejercicioActual) {
                    datos = datosA√±o;
                    updateAllTables();
                    updateDashboard();
                    actualizarListaContactos();
                }
                
                // Actualizar contadores
                actualizarContadoresReset();
                
                // Limpiar selecci√≥n
                limpiarSeleccionReset();
                
                // Mostrar notificaci√≥n de √©xito
                mostrarNotificacion(`üóëÔ∏è Eliminados del a√±o ${a√±oSeleccionado}: ${elementosAEliminar.join(', ')}`, 'success');
            }
        }

        function generarNumeroFactura() {
            const year = ejercicioActual.slice(-2);
            const numero = datos.contadorFacturas.toString().padStart(4, '0');
            const numeroFactura = `${year}-${numero}`;
            document.getElementById('numeroFacturaEmitida').value = numeroFactura;
            return numeroFactura;
        }

        // ===============================
        // CONFIGURACI√ìN (mantener igual)
        // ===============================
        function cargarConfiguracion() {
            document.getElementById('configNombreDespacho').value = configDespacho.nombre || '';
            document.getElementById('configNifDespacho').value = configDespacho.nif || '';
            document.getElementById('configDireccionDespacho').value = configDespacho.direccion || '';
            document.getElementById('configCiudadDespacho').value = configDespacho.ciudad || '';
            document.getElementById('configTelefonoDespacho').value = configDespacho.telefono || '';
            document.getElementById('configEmailDespacho').value = configDespacho.email || '';
            document.getElementById('configInfoBancaria').value = configDespacho.infoBancaria || '';
            
            // Cargar logo si existe
            if (configDespacho.logo) {
                document.getElementById('logoImg').src = configDespacho.logo;
                document.getElementById('logoPreview').style.display = 'block';
            }
            
            document.getElementById('emailjs_service_id').value = configuracionEmail.service_id || '';
            document.getElementById('emailjs_template_id').value = configuracionEmail.template_id || '';
            document.getElementById('emailjs_user_id').value = configuracionEmail.user_id || '';
        }

        function cargarLogo(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const logoImg = document.getElementById('logoImg');
                    logoImg.src = e.target.result;
                    document.getElementById('logoPreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function guardarConfiguracion() {
            configDespacho = {
                nombre: document.getElementById('configNombreDespacho').value,
                nif: document.getElementById('configNifDespacho').value,
                direccion: document.getElementById('configDireccionDespacho').value,
                ciudad: document.getElementById('configCiudadDespacho').value,
                telefono: document.getElementById('configTelefonoDespacho').value,
                email: document.getElementById('configEmailDespacho').value,
                infoBancaria: document.getElementById('configInfoBancaria').value,
                logo: document.getElementById('logoImg').src !== '' ? document.getElementById('logoImg').src : null
            };
            
            configuracionEmail = {
                service_id: document.getElementById('emailjs_service_id').value,
                template_id: document.getElementById('emailjs_template_id').value,
                user_id: document.getElementById('emailjs_user_id').value,
                configured: !!(document.getElementById('emailjs_service_id').value && document.getElementById('emailjs_template_id').value && document.getElementById('emailjs_user_id').value)
            };
            
            localStorage.setItem('configDespacho', JSON.stringify(configDespacho));
            localStorage.setItem('configuracionEmail', JSON.stringify(configuracionEmail));
            
            if (configuracionEmail.user_id) {
                emailjs.init(configuracionEmail.user_id);
            }
            
            mostrarNotificacion('‚úÖ Configuraci√≥n guardada correctamente', 'success');
        }

        function resetearConfiguracion() {
            if (confirm('¬øEst√°s seguro de resetear la configuraci√≥n?')) {
                localStorage.removeItem('configDespacho');
                localStorage.removeItem('configuracionEmail');
                configDespacho = {};
                configuracionEmail = {};
                cargarConfiguracion();
                mostrarNotificacion('Configuraci√≥n reseteada', 'info');
            }
        }

        function probarEnvioEmail() {
            if (!configuracionEmail.configured) {
                alert('Configura EmailJS primero');
                return;
            }
            
            const email = prompt('Email de prueba:');
            if (!email) return;
            
            emailjs.send(configuracionEmail.service_id, configuracionEmail.template_id, {
                to_email: email,
                cliente_nombre: 'Cliente de Prueba',
                numero_factura: 'TEST-001',
                fecha_factura: formatDate(new Date()),
                importe_total: formatCurrency(1234.56),
                factura_html: '<h1>Factura de Prueba</h1>'
            })
            .then(() => {
                mostrarNotificacion('‚úÖ Email enviado correctamente', 'success');
            })
            .catch(error => {
                mostrarNotificacion('‚ö† Error: ' + error, 'error');
            });
        }

        // ===============================
        // GESTI√ìN DE CONTACTOS
        // ===============================
        document.getElementById('contactoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const tipo = document.getElementById('tipoContacto').value;
            const contacto = {
                id: Date.now(),
                tipo: tipo,
                nombre: document.getElementById('nombreContacto').value,
                nif: document.getElementById('nifContacto').value,
                direccion: document.getElementById('direccionContacto').value,
                email: document.getElementById('emailContacto').value,
                telefono: document.getElementById('telefonoContacto').value,
                fechaCreacion: new Date().toISOString()
            };
            
            if (tipo === 'cliente') {
                datos.clientes.push(contacto);
            } else {
                datos.proveedores.push(contacto);
            }
            
            guardarDatos();
            updateContactosTable();
            actualizarListaContactos();
            this.reset();
            mostrarNotificacion(`‚úÖ ${tipo.charAt(0).toUpperCase() + tipo.slice(1)} guardado`, 'success');
        });

        function updateContactosTable() {
            const tbody = document.getElementById('contactosTable');
            tbody.innerHTML = '';
            
            const todosContactos = [...datos.clientes, ...datos.proveedores];
            
            todosContactos.forEach(contacto => {
                const row = tbody.insertRow();
                const tipoClass = contacto.tipo === 'cliente' ? 'tipo-ingreso' : 'tipo-gasto';
                
                row.innerHTML = `
                    <td><span class="${tipoClass}">${contacto.tipo.toUpperCase()}</span></td>
                    <td>${contacto.nombre}</td>
                    <td>${contacto.nif}</td>
                    <td>${contacto.email || '-'}</td>
                    <td>${contacto.telefono || '-'}</td>
                    <td class="action-buttons">
                        <button class="btn btn-info btn-small" onclick="editarContacto(${contacto.id})">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-small" onclick="eliminarContacto(${contacto.id})">üóëÔ∏è</button>
                    </td>
                `;
            });
        }

        function actualizarListaContactos() {
            const datalist = document.getElementById('listaContactos');
            const selectRecurrente = document.getElementById('clienteRecurrente');
            
            datalist.innerHTML = '';
            selectRecurrente.innerHTML = '<option value="">Seleccionar...</option>';
            
            datos.clientes.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.nombre;
                datalist.appendChild(option);
                
                const optionSelect = document.createElement('option');
                optionSelect.value = cliente.id;
                optionSelect.textContent = cliente.nombre;
                selectRecurrente.appendChild(optionSelect);
            });
            
            datos.proveedores.forEach(proveedor => {
                const option = document.createElement('option');
                option.value = proveedor.nombre;
                datalist.appendChild(option);
            });
        }

        function editarContacto(id) {
            const contacto = [...datos.clientes, ...datos.proveedores].find(c => c.id === id);
            if (!contacto) return;
            
            document.getElementById('tipoContacto').value = contacto.tipo;
            document.getElementById('nombreContacto').value = contacto.nombre;
            document.getElementById('nifContacto').value = contacto.nif;
            document.getElementById('direccionContacto').value = contacto.direccion || '';
            document.getElementById('emailContacto').value = contacto.email || '';
            document.getElementById('telefonoContacto').value = contacto.telefono || '';
            
            // Eliminar el contacto antiguo
            if (contacto.tipo === 'cliente') {
                datos.clientes = datos.clientes.filter(c => c.id !== id);
            } else {
                datos.proveedores = datos.proveedores.filter(p => p.id !== id);
            }
            
            guardarDatos();
            updateContactosTable();
            showTab('clientes', document.querySelector('[onclick*="clientes"]'));
        }

        function eliminarContacto(id) {
            if (confirm('¬øEliminar este contacto?')) {
                datos.clientes = datos.clientes.filter(c => c.id !== id);
                datos.proveedores = datos.proveedores.filter(p => p.id !== id);
                guardarDatos();
                updateContactosTable();
                actualizarListaContactos();
            }
        }

        function limpiarFormularioContacto() {
            document.getElementById('contactoForm').reset();
        }

        function filtrarContactos() {
            const busqueda = document.getElementById('buscarContacto').value.toLowerCase();
            const filas = document.querySelectorAll('#contactosTable tr');
            
            filas.forEach(fila => {
                const texto = fila.textContent.toLowerCase();
                fila.style.display = texto.includes(busqueda) ? '' : 'none';
            });
        }

        // ===============================
        // GESTI√ìN DE FACTURAS EMITIDAS
        // ===============================
        function agregarConceptoEmitida() {
            const container = document.getElementById('conceptosFacturaEmitida');
            const div = document.createElement('div');
            div.className = 'concepto-item';
            div.innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label>Concepto:</label>
                        <input type="text" class="concepto-desc" placeholder="Descripci√≥n del servicio">
                    </div>
                    <div class="form-group">
                        <label>Cantidad:</label>
                        <input type="number" class="concepto-cantidad" value="1" min="1" onchange="calcularTotalesFacturaEmitida()">
                    </div>
                    <div class="form-group">
                        <label>Precio Unit.:</label>
                        <input type="number" class="concepto-precio" step="0.01" min="0" onchange="calcularTotalesFacturaEmitida()">
                    </div>
                    <div>
                        <button type="button" class="btn btn-danger btn-small" onclick="eliminarConcepto(this)">üóëÔ∏è</button>
                    </div>
                </div>
            `;
            container.appendChild(div);
        }

        function eliminarConcepto(btn) {
            const container = btn.closest('.conceptos-container');
            if (container.children.length > 1) {
                btn.closest('.concepto-item').remove();
                // Calcular totales seg√∫n el contenedor
                if (container.id === 'conceptosFacturaEmitida') {
                    calcularTotalesFacturaEmitida();
                } else if (container.id === 'conceptosFacturaRecibida') {
                    calcularTotalesFacturaRecibida();
                }
            } else {
                alert('Debe haber al menos un concepto');
            }
        }

        function calcularTotalesFacturaEmitida() {
            let subtotal = 0;
            
            document.querySelectorAll('#conceptosFacturaEmitida .concepto-item').forEach(item => {
                const cantidad = parseFloat(item.querySelector('.concepto-cantidad').value) || 0;
                const precio = parseFloat(item.querySelector('.concepto-precio').value) || 0;
                subtotal += cantidad * precio;
            });
            
            const ivaPercent = parseFloat(document.getElementById('ivaFacturaEmitida').value) || 0;
            const iva = subtotal * (ivaPercent / 100);
            
            let retencion = 0;
            if (document.getElementById('aplicarRetencionEmitida').checked) {
                retencion = subtotal * 0.15;
            }
            
            const total = subtotal + iva - retencion;
            
            document.getElementById('subtotalFacturaEmitida').value = subtotal.toFixed(2);
            document.getElementById('ivaImporteEmitida').value = iva.toFixed(2);
            document.getElementById('retencionImporteEmitida').value = retencion.toFixed(2);
            document.getElementById('totalFacturaEmitida').value = total.toFixed(2);
        }

        document.getElementById('facturaEmitidaForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const facturaId = document.getElementById('facturaEmitidaId').value;
            console.log('=== GUARDANDO FACTURA EMITIDA ===');
            console.log('ID Factura:', facturaId);
            console.log('Tipo de facturaId:', typeof facturaId);
            
            // Recopilar conceptos
            const conceptos = [];
            document.querySelectorAll('#conceptosFacturaEmitida .concepto-item').forEach(item => {
                const desc = item.querySelector('.concepto-desc').value;
                const cantidad = parseFloat(item.querySelector('.concepto-cantidad').value) || 0;
                const precio = parseFloat(item.querySelector('.concepto-precio').value) || 0;
                
                if (desc && cantidad && precio) {
                    conceptos.push({
                        descripcion: desc,
                        cantidad: cantidad,
                        precio: precio,
                        total: cantidad * precio
                    });
                }
            });
            
            const factura = {
                id: facturaId ? parseInt(facturaId) : Date.now(),
                tipo: 'factura-emitida',
                fecha: document.getElementById('fechaFacturaEmitida').value,
                numero: document.getElementById('numeroFacturaEmitida').value || generarNumeroFactura(),
                vencimiento: document.getElementById('vencimientoFacturaEmitida').value,
                cliente: document.getElementById('clienteFacturaEmitida').value,
                nif: document.getElementById('nifFacturaEmitida').value,
                descripcion: document.getElementById('descripcionFacturaEmitida').value,
                conceptos: conceptos,
                subtotal: parseFloat(document.getElementById('subtotalFacturaEmitida').value) || 0,
                ivaPercent: parseFloat(document.getElementById('ivaFacturaEmitida').value) || 0,
                ivaImporte: parseFloat(document.getElementById('ivaImporteEmitida').value) || 0,
                retencion: parseFloat(document.getElementById('retencionImporteEmitida').value) || 0,
                aplicarRetencion: document.getElementById('aplicarRetencionEmitida').checked,
                total: parseFloat(document.getElementById('totalFacturaEmitida').value) || 0,
                estado: document.getElementById('estadoFacturaEmitida').value,
                fechaCobro: document.getElementById('fechaCobroEmitida').value,
                formaPago: document.getElementById('formaPagoEmitida').value,
                tags: document.getElementById('tagsFacturaEmitida').value,
                cuenta: document.getElementById('cuentaFacturaEmitida').value,
                proyecto: document.getElementById('proyectoFacturaEmitida').value
            };
            
            console.log('Factura a guardar:', factura);
            
            // Variable para determinar si es una edici√≥n o nueva factura
            let esEdicion = false;
            
            if (facturaId && facturaId.trim() !== '') {
                // Actualizar factura existente
                const idBuscar = parseInt(facturaId);
                console.log('Modo: EDICI√ìN');
                console.log('Buscando factura con ID:', idBuscar);
                console.log('Total de facturas antes de buscar:', datos.facturasEmitidas.length);
                
                // Buscar el √≠ndice de la factura
                const index = datos.facturasEmitidas.findIndex(f => {
                    console.log(`Comparando: ${f.id} (tipo: ${typeof f.id}) == ${idBuscar} (tipo: ${typeof idBuscar})`);
                    return parseInt(f.id) === idBuscar;
                });
                
                console.log('√çndice encontrado:', index);
                
                if (index !== -1) {
                    // REEMPLAZAR COMPLETAMENTE la factura manteniendo el ID original
                    console.log('Factura encontrada en √≠ndice:', index);
                    console.log('Factura anterior:', datos.facturasEmitidas[index]);
                    
                    // Asegurar que el ID se mantiene como estaba originalmente
                    factura.id = datos.facturasEmitidas[index].id;
                    
                    // Reemplazar la factura
                    datos.facturasEmitidas[index] = factura;
                    
                    console.log('Factura actualizada:', datos.facturasEmitidas[index]);
                    esEdicion = true;
                } else {
                    console.error('‚ùå NO SE ENCONTR√ì LA FACTURA CON ID:', idBuscar);
                    console.error('IDs disponibles:', datos.facturasEmitidas.map(f => `${f.id} (${typeof f.id})`));
                    mostrarNotificacion('‚ùå Error: No se encontr√≥ la factura para actualizar', 'error');
                    return;
                }
            } else {
                // Nueva factura
                console.log('Modo: NUEVA FACTURA');
                factura.id = Date.now();
                datos.facturasEmitidas.push(factura);
                datos.contadorFacturas++;
                console.log('Nueva factura a√±adida con ID:', factura.id);
                console.log('Total facturas despu√©s de a√±adir:', datos.facturasEmitidas.length);
            }
            
            // Guardar en localStorage
            console.log('Guardando en localStorage...');
            console.log('Total de facturas antes de guardar:', datos.facturasEmitidas.length);
            guardarDatos();
            
            // Verificar que se guard√≥ correctamente
            const datosGuardados = localStorage.getItem(`datos_${ejercicioActual}`);
            console.log('Datos guardados en localStorage:', datosGuardados ? 'S√ç' : 'NO');
            if (datosGuardados) {
                const datosParseados = JSON.parse(datosGuardados);
                console.log('Total de facturas en localStorage:', datosParseados.facturasEmitidas?.length || 0);
            }
            
            // Actualizar todas las tablas
            console.log('Actualizando todas las tablas...');
            updateAllTables();
            console.log('Tablas actualizadas');
            
            // Mostrar notificaci√≥n de √©xito
            const mensajeDetalle = esEdicion ? 
                `Factura ${factura.numero} actualizada correctamente` : 
                `Factura ${factura.numero} creada correctamente`;
            mostrarNotificacion(`‚úÖ ${mensajeDetalle}`, 'success');
            
            // Limpiar formulario
            limpiarFormularioFacturaEmitida();
            console.log('=== FIN GUARDADO ===');
        });

        
        // ===== FUNCIONES PARA PAGOS PARCIALES =====
        function togglePagosParciales() {
            const checkbox = document.getElementById('permitirPagosParciales');
            const seccion = document.getElementById('seccionPagosParciales');
            if (checkbox && seccion) {
                seccion.style.display = checkbox.checked ? 'block' : 'none';
            }
        }

        function a√±adirPagoParcial() {
            const fecha = document.getElementById('fechaPagoParcial').value;
            const cantidad = parseFloat(document.getElementById('cantidadPagoParcial').value);
            
            if (!fecha || !cantidad || cantidad <= 0) {
                mostrarNotificacion('‚ö†Ô∏è Debes indicar una fecha y cantidad v√°lidas', 'warning');
                return;
            }
            
            const facturaId = document.getElementById('facturaEmitidaId').value;
            
            if (!facturaId) {
                mostrarNotificacion('‚ö†Ô∏è Guarda la factura primero antes de a√±adir pagos parciales', 'warning');
                return;
            }
            
            const factura = datos.facturasEmitidas.find(f => f.id == facturaId);
            if (!factura) {
                mostrarNotificacion('‚ùå No se encontr√≥ la factura', 'error');
                return;
            }
            
            if (!factura.pagosParciales) {
                factura.pagosParciales = [];
            }
            
            const pago = {
                id: Date.now(),
                fecha: fecha,
                cantidad: cantidad
            };
            
            factura.pagosParciales.push(pago);
            
            const totalPagado = factura.pagosParciales.reduce((sum, p) => sum + p.cantidad, 0);
            factura.totalPagado = totalPagado;
            
            if (totalPagado >= factura.total) {
                factura.estado = 'Pagado';
                if (!factura.fechaCobro) {
                    factura.fechaCobro = fecha;
                }
            }
            
            guardarDatos();
            actualizarListaPagosParciales(facturaId);
            updateAllTables();
            
            document.getElementById('fechaPagoParcial').value = '';
            document.getElementById('cantidadPagoParcial').value = '';
            
            mostrarNotificacion('‚úÖ Pago parcial a√±adido correctamente', 'success');
        }

        function actualizarListaPagosParciales(facturaId) {
            const lista = document.getElementById('listaPagosParciales');
            if (!lista) return;
            
            const factura = datos.facturasEmitidas.find(f => f.id == facturaId);
            
            if (!factura || !factura.pagosParciales || factura.pagosParciales.length === 0) {
                lista.innerHTML = '<p style="color: #6c757d; font-style: italic;">No hay pagos parciales registrados.</p>';
                return;
            }
            
            const totalPagado = factura.pagosParciales.reduce((sum, p) => sum + p.cantidad, 0);
            const pendiente = factura.total - totalPagado;
            
            let html = '';
            factura.pagosParciales.forEach(pago => {
                html += `
                    <div class="pago-parcial-item">
                        <div class="pago-parcial-info">
                            <strong>üìÖ ${formatDate(pago.fecha)}</strong> - 
                            <span style="color: #27ae60; font-weight: bold;">${formatCurrency(pago.cantidad)}</span>
                        </div>
                        <button class="btn btn-danger btn-small" onclick="eliminarPagoParcial('${facturaId}', '${pago.id}')">
                            üóëÔ∏è
                        </button>
                    </div>
                `;
            });
            
            html += `
                <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 5px;">
                    <strong>Total factura:</strong> ${formatCurrency(factura.total)}<br>
                    <strong>Total pagado:</strong> <span style="color: #27ae60;">${formatCurrency(totalPagado)}</span><br>
                    <strong>Pendiente:</strong> <span style="color: ${pendiente > 0 ? '#e74c3c' : '#27ae60'};">${formatCurrency(pendiente)}</span>
                </div>
            `;
            
            lista.innerHTML = html;
        }

        function eliminarPagoParcial(facturaId, pagoId) {
            if (!confirm('¬øEliminar este pago parcial?')) return;
            
            const factura = datos.facturasEmitidas.find(f => f.id == facturaId);
            if (!factura) return;
            
            factura.pagosParciales = factura.pagosParciales.filter(p => p.id != pagoId);
            
            const totalPagado = factura.pagosParciales.reduce((sum, p) => sum + p.cantidad, 0);
            factura.totalPagado = totalPagado;
            
            if (totalPagado < factura.total) {
                factura.estado = 'Pendiente';
            }
            
            guardarDatos();
            actualizarListaPagosParciales(facturaId);
            updateAllTables();
            
            mostrarNotificacion('‚úÖ Pago parcial eliminado', 'success');
        }

        // ===== FUNCIONES PARA ORDENACI√ìN Y FILTRADO =====
        function inicializarFiltrosAnos() {
            const anosEmitidas = [...new Set(datos.facturasEmitidas.map(f => new Date(f.fecha).getFullYear()))].sort((a, b) => b - a);
            const selectAnoEmitidas = document.getElementById('filtroAnoEmitidas');
            if (selectAnoEmitidas) {
                selectAnoEmitidas.innerHTML = '<option value="">Todos los a√±os</option>';
                anosEmitidas.forEach(ano => {
                    const option = document.createElement('option');
                    option.value = ano;
                    option.textContent = ano;
                    selectAnoEmitidas.appendChild(option);
                });
            }
            
            const anosRecibidas = [...new Set(datos.facturasRecibidas.map(f => new Date(f.fecha).getFullYear()))].sort((a, b) => b - a);
            const selectAnoRecibidas = document.getElementById('filtroAnoRecibidas');
            if (selectAnoRecibidas) {
                selectAnoRecibidas.innerHTML = '<option value="">Todos los a√±os</option>';
                anosRecibidas.forEach(ano => {
                    const option = document.createElement('option');
                    option.value = ano;
                    option.textContent = ano;
                    selectAnoRecibidas.appendChild(option);
                });
            }
        }

        function aplicarOrdenFacturasEmitidas() {
            updateFacturasEmitidasTable();
        }

        function aplicarOrdenFacturasRecibidas() {
            updateFacturasRecibidasTable();
        }

        function ordenarFacturas(facturas, criterio) {
            const sorted = [...facturas];
            
            switch(criterio) {
                case 'fecha-desc':
                    sorted.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                    break;
                case 'fecha-asc':
                    sorted.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
                    break;
                case 'numero-desc':
                    sorted.sort((a, b) => (b.numero || '').localeCompare(a.numero || ''));
                    break;
                case 'numero-asc':
                    sorted.sort((a, b) => (a.numero || '').localeCompare(b.numero || ''));
                    break;
                case 'importe-desc':
                    sorted.sort((a, b) => (b.total || 0) - (a.total || 0));
                    break;
                case 'importe-asc':
                    sorted.sort((a, b) => (a.total || 0) - (b.total || 0));
                    break;
                default:
                    sorted.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            }
            
            return sorted;
        }

        function getTrimestreFromDate(fecha) {
            const mes = new Date(fecha).getMonth() + 1;
            if (mes >= 1 && mes <= 3) return 1;
            if (mes >= 4 && mes <= 6) return 2;
            if (mes >= 7 && mes <= 9) return 3;
            return 4;
        }

function updateFacturasEmitidasTable() {
            console.log('üìã Actualizando tabla de facturas emitidas...');
            const tbody = document.getElementById('facturasEmitidasTable');
            tbody.innerHTML = '';
            
            console.log('Total facturas en datos:', datos.facturasEmitidas?.length || 0);
            const facturasFiltradas = filtrarFacturasEmitidasActual();
            console.log('Facturas despu√©s de filtrar:', facturasFiltradas.length);
            
            facturasFiltradas.forEach(factura => {
                const row = tbody.insertRow();
                const estadoClass = factura.estado === 'Pagado' ? 'estado-pagado' : 'estado-pendiente';
                
                // Botones de cambio r√°pido de estado
                let botonEstado = '';
                if (factura.estado !== 'Pagado') {
                    botonEstado = `<button class="btn btn-success btn-small" onclick="marcarComoPagadoTabla(${factura.id}, 'emitida')" title="Marcar como pagado">‚úì</button>`;
                } else {
                    botonEstado = `<button class="btn btn-secondary btn-small" onclick="marcarComoPendienteTabla(${factura.id}, 'emitida')" title="Marcar como pendiente">‚Ü©</button>`;
                }
                
                row.innerHTML = `
                    <td>${formatDate(factura.fecha)}</td>
                    <td>${factura.numero}</td>
                    <td>${factura.cliente}</td>
                    <td>${factura.descripcion.substring(0, 50)}${factura.descripcion.length > 50 ? '...' : ''}</td>
                    <td>${formatCurrency(factura.total)}</td>
                    <td><span class="${estadoClass}">${factura.estado}</span></td>
                    <td class="action-buttons">
                        ${botonEstado}
                        <button class="btn btn-info btn-small" onclick="editarFacturaEmitida(${factura.id})">‚úèÔ∏è</button>
                        <button class="btn btn-primary btn-small" onclick="verFacturaEmitida(${factura.id})">üëÅÔ∏è</button>
                        <button class="btn btn-success btn-small" onclick="imprimirFacturaEmitida(${factura.id})">üñ®Ô∏è</button>
                        <button class="btn btn-danger btn-small" onclick="eliminarFacturaEmitida(${factura.id})">üóëÔ∏è</button>
                    </td>
                `;
            });
            console.log('‚úÖ Tabla actualizada');
        }

        function filtrarFacturasEmitidasActual() {
            let facturas = [...datos.facturasEmitidas];
            
            const busqueda = document.getElementById('buscarFacturaEmitida')?.value.toLowerCase() || '';
            if (busqueda) {
                facturas = facturas.filter(f => 
                    f.numero.toLowerCase().includes(busqueda) ||
                    f.cliente.toLowerCase().includes(busqueda) ||
                    f.descripcion.toLowerCase().includes(busqueda)
                );
            }
            
            const filtroEstado = document.getElementById('filtroEstadoFacturaEmitida')?.value || '';
            if (filtroEstado) {
                facturas = facturas.filter(f => f.estado === filtroEstado);
            }
            
            const filtroAno = document.getElementById('filtroAnoEmitidas')?.value || '';
            if (filtroAno) {
                facturas = facturas.filter(f => new Date(f.fecha).getFullYear() == filtroAno);
            }
            
            const filtroTrimestre = document.getElementById('filtroTrimestreEmitidas')?.value || '';
            if (filtroTrimestre) {
                facturas = facturas.filter(f => getTrimestreFromDate(f.fecha) == filtroTrimestre);
            }
            
            const criterioOrden = document.getElementById('ordenFacturasEmitidas')?.value || 'fecha-desc';
            facturas = ordenarFacturas(facturas, criterioOrden);
            
            return facturas;
        }

        function filtrarFacturasEmitidas() {
            updateFacturasEmitidasTable();
        }

        function limpiarFormularioFacturaEmitida() {
            document.getElementById('facturaEmitidaForm').reset();
            document.getElementById('facturaEmitidaId').value = '';
            document.getElementById('numeroFacturaEmitida').value = generarNumeroFactura();
            
            // Resetear conceptos
            const container = document.getElementById('conceptosFacturaEmitida');
            container.innerHTML = `
                <div class="concepto-item">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Concepto:</label>
                            <input type="text" class="concepto-desc" placeholder="Descripci√≥n del servicio">
                        </div>
                        <div class="form-group">
                            <label>Cantidad:</label>
                            <input type="number" class="concepto-cantidad" value="1" min="1" onchange="calcularTotalesFacturaEmitida()">
                        </div>
                        <div class="form-group">
                            <label>Precio Unit.:</label>
                            <input type="number" class="concepto-precio" step="0.01" min="0" onchange="calcularTotalesFacturaEmitida()">
                        </div>
                        <div>
                            <button type="button" class="btn btn-danger btn-small" onclick="eliminarConcepto(this)">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `;
            
            calcularTotalesFacturaEmitida();
        }

        function editarFacturaEmitida(id) {
            console.log('=== EDITANDO FACTURA EMITIDA ===');
            console.log('ID a buscar:', id);
            console.log('Total facturas:', datos.facturasEmitidas.length);
            
            const factura = datos.facturasEmitidas.find(f => f.id == id);
            if (!factura) {
                console.error('‚ùå NO SE ENCONTR√ì LA FACTURA');
                mostrarNotificacion('‚ùå Error: No se encontr√≥ la factura', 'error');
                return;
            }
            
            console.log('‚úÖ Factura encontrada:', factura);
            
            // Rellenar formulario
            document.getElementById('facturaEmitidaId').value = factura.id;
            document.getElementById('fechaFacturaEmitida').value = factura.fecha;
            document.getElementById('numeroFacturaEmitida').value = factura.numero;
            document.getElementById('vencimientoFacturaEmitida').value = factura.vencimiento || '';
            document.getElementById('clienteFacturaEmitida').value = factura.cliente;
            document.getElementById('nifFacturaEmitida').value = factura.nif || '';
            document.getElementById('descripcionFacturaEmitida').value = factura.descripcion;
            document.getElementById('ivaFacturaEmitida').value = factura.ivaPercent;
            document.getElementById('aplicarRetencionEmitida').checked = factura.aplicarRetencion || factura.retencion > 0;
            document.getElementById('estadoFacturaEmitida').value = factura.estado;
            document.getElementById('fechaCobroEmitida').value = factura.fechaCobro || '';
            document.getElementById('formaPagoEmitida').value = factura.formaPago || '';
            document.getElementById('tagsFacturaEmitida').value = factura.tags || '';
            document.getElementById('cuentaFacturaEmitida').value = factura.cuenta || '';
            document.getElementById('proyectoFacturaEmitida').value = factura.proyecto || '';
            
            // Rellenar conceptos
            const container = document.getElementById('conceptosFacturaEmitida');
            container.innerHTML = '';
            if (factura.conceptos && factura.conceptos.length > 0) {
                factura.conceptos.forEach(concepto => {
                    const div = document.createElement('div');
                    div.className = 'concepto-item';
                    div.innerHTML = `
                        <div class="form-row">
                            <div class="form-group">
                                <label>Concepto:</label>
                                <input type="text" class="concepto-desc" value="${concepto.descripcion}">
                            </div>
                            <div class="form-group">
                                <label>Cantidad:</label>
                                <input type="number" class="concepto-cantidad" value="${concepto.cantidad}" min="1" onchange="calcularTotalesFacturaEmitida()">
                            </div>
                            <div class="form-group">
                                <label>Precio Unit.:</label>
                                <input type="number" class="concepto-precio" value="${concepto.precio}" step="0.01" min="0" onchange="calcularTotalesFacturaEmitida()">
                            </div>
                            <div>
                                <button type="button" class="btn btn-danger btn-small" onclick="eliminarConcepto(this)">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }
            
            calcularTotalesFacturaEmitida();
            
            // Cargar pagos parciales si existen
            if (factura.pagosParciales && factura.pagosParciales.length > 0) {
                const checkbox = document.getElementById('permitirPagosParciales');
                if (checkbox) {
                    checkbox.checked = true;
                    togglePagosParciales();
                    actualizarListaPagosParciales(factura.id);
                }
            }
            showSubTab('facturas-emitidas', document.querySelector('[onclick*="facturas-emitidas"]'));
            
            // Scroll autom√°tico hacia el t√≠tulo del formulario
            setTimeout(() => {
                const titulo = document.getElementById('tituloFacturaEmitida');
                if (titulo) {
                    titulo.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
            
            console.log('=== FIN EDICI√ìN ===');
        }

        function verFacturaEmitida(id) {
            const factura = datos.facturasEmitidas.find(f => f.id === id);
            if (!factura) return;
            
            const content = generarHTMLFactura(factura);
            document.getElementById('previewContent').innerHTML = content;
            document.getElementById('modalPreview').classList.add('active');
        }

        function imprimirFacturaEmitida(id) {
            const factura = datos.facturasEmitidas.find(f => f.id === id);
            if (!factura) return;
            
            generarPDFFactura(factura);
        }

        function eliminarFacturaEmitida(id) {
            if (confirm('¬øEliminar esta factura emitida?')) {
                datos.facturasEmitidas = datos.facturasEmitidas.filter(f => f.id !== id);
                guardarDatos();
                updateFacturasEmitidasTable();
                mostrarNotificacion('Factura emitida eliminada', 'info');
            }
        }

        // ===============================
        // GESTI√ìN DE FACTURAS RECIBIDAS
        // ===============================
        function agregarConceptoRecibida() {
            const container = document.getElementById('conceptosFacturaRecibida');
            const div = document.createElement('div');
            div.className = 'concepto-item';
            div.innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label>Concepto:</label>
                        <input type="text" class="concepto-desc" placeholder="Descripci√≥n del servicio">
                    </div>
                    <div class="form-group">
                        <label>Cantidad:</label>
                        <input type="number" class="concepto-cantidad" value="1" min="1" onchange="calcularTotalesFacturaRecibida()">
                    </div>
                    <div class="form-group">
                        <label>Precio Unit.:</label>
                        <input type="number" class="concepto-precio" step="0.01" min="0" onchange="calcularTotalesFacturaRecibida()">
                    </div>
                    <div>
                        <button type="button" class="btn btn-danger btn-small" onclick="eliminarConcepto(this)">üóëÔ∏è</button>
                    </div>
                </div>
            `;
            container.appendChild(div);
        }

        function calcularTotalesFacturaRecibida() {
            let subtotal = 0;
            
            document.querySelectorAll('#conceptosFacturaRecibida .concepto-item').forEach(item => {
                const cantidad = parseFloat(item.querySelector('.concepto-cantidad').value) || 0;
                const precio = parseFloat(item.querySelector('.concepto-precio').value) || 0;
                subtotal += cantidad * precio;
            });
            
            const ivaPercent = parseFloat(document.getElementById('ivaFacturaRecibida').value) || 0;
            const iva = subtotal * (ivaPercent / 100);
            const total = subtotal + iva;
            
            document.getElementById('subtotalFacturaRecibida').value = subtotal.toFixed(2);
            document.getElementById('ivaImporteRecibida').value = iva.toFixed(2);
            document.getElementById('totalFacturaRecibida').value = total.toFixed(2);
        }

        document.getElementById('facturaRecibidaForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const facturaId = document.getElementById('facturaRecibidaId').value;
            console.log('=== GUARDANDO FACTURA RECIBIDA ===');
            console.log('ID Factura:', facturaId);
            
            // Recopilar conceptos
            const conceptos = [];
            document.querySelectorAll('#conceptosFacturaRecibida .concepto-item').forEach(item => {
                const desc = item.querySelector('.concepto-desc').value;
                const cantidad = parseFloat(item.querySelector('.concepto-cantidad').value) || 0;
                const precio = parseFloat(item.querySelector('.concepto-precio').value) || 0;
                
                if (desc && cantidad && precio) {
                    conceptos.push({
                        descripcion: desc,
                        cantidad: cantidad,
                        precio: precio,
                        total: cantidad * precio
                    });
                }
            });
            
            const factura = {
                id: facturaId ? parseInt(facturaId) : Date.now(),
                tipo: 'factura-recibida',
                fecha: document.getElementById('fechaFacturaRecibida').value,
                numero: document.getElementById('numeroFacturaRecibida').value,
                vencimiento: document.getElementById('vencimientoFacturaRecibida').value,
                proveedor: document.getElementById('proveedorFacturaRecibida').value,
                nif: document.getElementById('nifFacturaRecibida').value,
                descripcion: document.getElementById('descripcionFacturaRecibida').value,
                conceptos: conceptos,
                subtotal: parseFloat(document.getElementById('subtotalFacturaRecibida').value),
                ivaPercent: parseFloat(document.getElementById('ivaFacturaRecibida').value),
                ivaImporte: parseFloat(document.getElementById('ivaImporteRecibida').value),
                total: parseFloat(document.getElementById('totalFacturaRecibida').value),
                estado: document.getElementById('estadoFacturaRecibida').value,
                fechaPago: document.getElementById('fechaPagoRecibida').value,
                tags: document.getElementById('tagsFacturaRecibida').value,
                cuenta: document.getElementById('cuentaFacturaRecibida').value,
                proyecto: document.getElementById('proyectoFacturaRecibida').value
            };
            
            console.log('Factura a guardar:', factura);
            
            if (facturaId) {
                // Actualizar factura existente
                const idBuscar = parseInt(facturaId);
                console.log('Buscando factura con ID:', idBuscar);
                console.log('Facturas actuales:', datos.facturasRecibidas.length);
                
                const index = datos.facturasRecibidas.findIndex(f => f.id == idBuscar);
                console.log('√çndice encontrado:', index);
                
                if (index !== -1) {
                    // REEMPLAZAR COMPLETAMENTE la factura
                    factura.id = idBuscar; // Asegurar que el ID se mantiene
                    datos.facturasRecibidas[index] = factura;
                    console.log('Factura actualizada en √≠ndice:', index);
                } else {
                    console.error('‚ùå NO SE ENCONTR√ì LA FACTURA CON ID:', idBuscar);
                    mostrarNotificacion('‚ùå Error: No se encontr√≥ la factura', 'error');
                    return;
                }
            } else {
                // Nueva factura
                datos.facturasRecibidas.push(factura);
                console.log('Nueva factura a√±adida. Total facturas:', datos.facturasRecibidas.length);
            }
            
            // Guardar en localStorage
            console.log('Guardando en localStorage...');
            guardarDatos();
            
            // Verificar que se guard√≥
            const verificacion = localStorage.getItem(`datos_${ejercicioActual}`);
            console.log('Datos guardados en localStorage:', verificacion ? 'S√ç' : 'NO');
            
            // Actualizar todas las tablas
            console.log('Actualizando tablas...');
            updateAllTables();
            
            mostrarNotificacion(`‚úÖ Factura recibida ${facturaId ? 'actualizada' : 'guardada'} correctamente`, 'success');
            limpiarFormularioFacturaRecibida();
            console.log('=== FIN GUARDADO ===');
        });

        function updateFacturasRecibidasTable() {
            console.log('üìã Actualizando tabla de facturas recibidas...');
            const tbody = document.getElementById('facturasRecibidasTable');
            tbody.innerHTML = '';
            
            console.log('Total facturas en datos:', datos.facturasRecibidas?.length || 0);
            const facturasFiltradas = filtrarFacturasRecibidasActual();
            console.log('Facturas despu√©s de filtrar:', facturasFiltradas.length);
            
            facturasFiltradas.forEach(factura => {
                const row = tbody.insertRow();
                const estadoClass = factura.estado === 'Pagado' ? 'estado-pagado' : 'estado-pendiente';
                
                // Botones de cambio r√°pido de estado
                let botonEstado = '';
                if (factura.estado !== 'Pagado') {
                    botonEstado = `<button class="btn btn-success btn-small" onclick="marcarComoPagadoTabla(${factura.id}, 'recibida')" title="Marcar como pagado">‚úì</button>`;
                } else {
                    botonEstado = `<button class="btn btn-secondary btn-small" onclick="marcarComoPendienteTabla(${factura.id}, 'recibida')" title="Marcar como pendiente">‚Ü©</button>`;
                }
                
                row.innerHTML = `
                    <td>${formatDate(factura.fecha)}</td>
                    <td>${factura.numero || '-'}</td>
                    <td>${factura.proveedor}</td>
                    <td>${factura.descripcion.substring(0, 50)}${factura.descripcion.length > 50 ? '...' : ''}</td>
                    <td>${formatCurrency(factura.total)}</td>
                    <td><span class="${estadoClass}">${factura.estado}</span></td>
                    <td class="action-buttons">
                        ${botonEstado}
                        <button class="btn btn-info btn-small" onclick="editarFacturaRecibida(${factura.id})">‚úèÔ∏è</button>
                        <button class="btn btn-primary btn-small" onclick="verFacturaRecibida(${factura.id})">üëÅÔ∏è</button>
                        <button class="btn btn-success btn-small" onclick="imprimirFacturaRecibida(${factura.id})">üñ®Ô∏è</button>
                        <button class="btn btn-danger btn-small" onclick="eliminarFacturaRecibida(${factura.id})">üóëÔ∏è</button>
                    </td>
                `;
            });
            console.log('‚úÖ Tabla actualizada');
        }

        function filtrarFacturasRecibidasActual() {
            let facturas = [...datos.facturasRecibidas];
            
            const busqueda = document.getElementById('buscarFacturaRecibida')?.value.toLowerCase() || '';
            if (busqueda) {
                facturas = facturas.filter(f => 
                    (f.numero && f.numero.toLowerCase().includes(busqueda)) ||
                    f.proveedor.toLowerCase().includes(busqueda) ||
                    f.descripcion.toLowerCase().includes(busqueda)
                );
            }
            
            const filtroEstado = document.getElementById('filtroEstadoFacturaRecibida')?.value || '';
            if (filtroEstado) {
                facturas = facturas.filter(f => f.estado === filtroEstado);
            }
            
            const filtroAno = document.getElementById('filtroAnoRecibidas')?.value || '';
            if (filtroAno) {
                facturas = facturas.filter(f => new Date(f.fecha).getFullYear() == filtroAno);
            }
            
            const filtroTrimestre = document.getElementById('filtroTrimestreRecibidas')?.value || '';
            if (filtroTrimestre) {
                facturas = facturas.filter(f => getTrimestreFromDate(f.fecha) == filtroTrimestre);
            }
            
            const criterioOrden = document.getElementById('ordenFacturasRecibidas')?.value || 'fecha-desc';
            facturas = ordenarFacturas(facturas, criterioOrden);
            
            return facturas;
        }

        function filtrarFacturasRecibidas() {
            updateFacturasRecibidasTable();
        }

        function limpiarFormularioFacturaRecibida() {
            document.getElementById('facturaRecibidaForm').reset();
            document.getElementById('facturaRecibidaId').value = '';
            
            // Resetear conceptos
            const container = document.getElementById('conceptosFacturaRecibida');
            container.innerHTML = `
                <div class="concepto-item">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Concepto:</label>
                            <input type="text" class="concepto-desc" placeholder="Descripci√≥n del servicio">
                        </div>
                        <div class="form-group">
                            <label>Cantidad:</label>
                            <input type="number" class="concepto-cantidad" value="1" min="1" onchange="calcularTotalesFacturaRecibida()">
                        </div>
                        <div class="form-group">
                            <label>Precio Unit.:</label>
                            <input type="number" class="concepto-precio" step="0.01" min="0" onchange="calcularTotalesFacturaRecibida()">
                        </div>
                        <div>
                            <button type="button" class="btn btn-danger btn-small" onclick="eliminarConcepto(this)">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `;
            
            calcularTotalesFacturaRecibida();
        }

        function editarFacturaRecibida(id) {
            console.log('=== EDITANDO FACTURA RECIBIDA ===');
            console.log('ID a buscar:', id);
            console.log('Total facturas:', datos.facturasRecibidas.length);
            
            const factura = datos.facturasRecibidas.find(f => f.id == id);
            if (!factura) {
                console.error('‚ùå NO SE ENCONTR√ì LA FACTURA');
                mostrarNotificacion('‚ùå Error: No se encontr√≥ la factura', 'error');
                return;
            }
            
            console.log('‚úÖ Factura encontrada:', factura);
            
            // Rellenar formulario
            document.getElementById('facturaRecibidaId').value = factura.id;
            document.getElementById('fechaFacturaRecibida').value = factura.fecha;
            document.getElementById('numeroFacturaRecibida').value = factura.numero || '';
            document.getElementById('vencimientoFacturaRecibida').value = factura.vencimiento || '';
            document.getElementById('proveedorFacturaRecibida').value = factura.proveedor;
            document.getElementById('nifFacturaRecibida').value = factura.nif || '';
            document.getElementById('descripcionFacturaRecibida').value = factura.descripcion;
            document.getElementById('ivaFacturaRecibida').value = factura.ivaPercent;
            document.getElementById('estadoFacturaRecibida').value = factura.estado;
            document.getElementById('fechaPagoRecibida').value = factura.fechaPago || '';
            document.getElementById('tagsFacturaRecibida').value = factura.tags || '';
            document.getElementById('cuentaFacturaRecibida').value = factura.cuenta || '';
            document.getElementById('proyectoFacturaRecibida').value = factura.proyecto || '';
            
            // Rellenar conceptos
            const container = document.getElementById('conceptosFacturaRecibida');
            container.innerHTML = '';
            if (factura.conceptos && factura.conceptos.length > 0) {
                factura.conceptos.forEach(concepto => {
                    const div = document.createElement('div');
                    div.className = 'concepto-item';
                    div.innerHTML = `
                        <div class="form-row">
                            <div class="form-group">
                                <label>Concepto:</label>
                                <input type="text" class="concepto-desc" value="${concepto.descripcion}">
                            </div>
                            <div class="form-group">
                                <label>Cantidad:</label>
                                <input type="number" class="concepto-cantidad" value="${concepto.cantidad}" min="1" onchange="calcularTotalesFacturaRecibida()">
                            </div>
                            <div class="form-group">
                                <label>Precio Unit.:</label>
                                <input type="number" class="concepto-precio" value="${concepto.precio}" step="0.01" min="0" onchange="calcularTotalesFacturaRecibida()">
                            </div>
                            <div>
                                <button type="button" class="btn btn-danger btn-small" onclick="eliminarConcepto(this)">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }
            
            calcularTotalesFacturaRecibida();
            showSubTab('facturas-recibidas', document.querySelector('[onclick*="facturas-recibidas"]'));
            
            // Scroll autom√°tico hacia el t√≠tulo del formulario
            setTimeout(() => {
                const titulo = document.getElementById('tituloFacturaRecibida');
                if (titulo) {
                    titulo.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
            
            console.log('=== FIN EDICI√ìN ===');
        }

        function verFacturaRecibida(id) {
            const factura = datos.facturasRecibidas.find(f => f.id === id);
            if (!factura) return;
            
            const content = generarHTMLFactura(factura);
            document.getElementById('previewContent').innerHTML = content;
            document.getElementById('modalPreview').classList.add('active');
        }

        function imprimirFacturaRecibida(id) {
            const factura = datos.facturasRecibidas.find(f => f.id === id);
            if (!factura) return;
            
            generarPDFFactura(factura);
        }

        function eliminarFacturaRecibida(id) {
            if (confirm('¬øEliminar esta factura recibida?')) {
                datos.facturasRecibidas = datos.facturasRecibidas.filter(f => f.id !== id);
                guardarDatos();
                updateFacturasRecibidasTable();
                mostrarNotificacion('Factura recibida eliminada', 'info');
            }
        }

        // ===============================
        // GESTI√ìN DE RECURRENTES
        // ===============================
        document.getElementById('recurrenteForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const clienteId = document.getElementById('clienteRecurrente').value;
            const cliente = datos.clientes.find(c => c.id == clienteId);
            
            if (!cliente) {
                alert('Selecciona un cliente v√°lido');
                return;
            }
            
            const recurrente = {
                id: Date.now(),
                tipo: 'recurrente',
                clienteId: cliente.id,
                clienteNombre: cliente.nombre,
                concepto: document.getElementById('conceptoRecurrente').value,
                importe: parseFloat(document.getElementById('importeRecurrente').value),
                ivaPercent: parseFloat(document.getElementById('ivaRecurrente').value),
                aplicarRetencion: document.getElementById('retencionRecurrente').checked,
                frecuencia: document.getElementById('frecuenciaRecurrente').value,
                diaEmision: parseInt(document.getElementById('diaEmision').value),
                fechaInicio: document.getElementById('fechaInicioRecurrente').value,
                fechaFin: document.getElementById('fechaFinRecurrente').value,
                enviarEmail: document.getElementById('enviarEmailRecurrente').checked,
                estado: 'activa'
            };
            
            datos.recurrentes.push(recurrente);
            guardarDatos();
            updateRecurrentesTable();
            this.reset();
            mostrarNotificacion('‚úÖ Factura recurrente creada', 'success');
        });

        function updateRecurrentesTable() {
            const tbody = document.getElementById('recurrentesTable');
            tbody.innerHTML = '';
            
            const recurrentesFiltradas = filtrarRecurrentesActual();
            
            recurrentesFiltradas.forEach(rec => {
                const row = tbody.insertRow();
                const estadoClass = rec.estado === 'activa' ? 'estado-activa' : 'estado-pendiente';
                
                const iva = rec.importe * (rec.ivaPercent / 100);
                const retencion = rec.aplicarRetencion ? rec.importe * 0.15 : 0;
                const total = rec.importe + iva - retencion;
                
                // Calcular pr√≥xima fecha
                const proximaFecha = calcularProximaFecha(rec);
                
                row.innerHTML = `
                    <td>${rec.clienteNombre}</td>
                    <td>${rec.concepto}</td>
                    <td>${formatCurrency(total)}</td>
                    <td>${rec.frecuencia}</td>
                    <td>${formatDate(proximaFecha)}</td>
                    <td><span class="${estadoClass}">${rec.estado.toUpperCase()}</span></td>
                    <td class="action-buttons">
                        <button class="btn btn-info btn-small" onclick="editarRecurrente(${rec.id})">‚úèÔ∏è</button>
                        <button class="btn btn-primary btn-small" onclick="verRecurrente(${rec.id})">üëÅÔ∏è</button>
                        <button class="btn btn-success btn-small" onclick="imprimirRecurrente(${rec.id})">üñ®Ô∏è</button>
                        <button class="btn btn-danger btn-small" onclick="eliminarRecurrente(${rec.id})">üóëÔ∏è</button>
                    </td>
                `;
            });
        }

        function filtrarRecurrentesActual() {
            let recurrentes = [...datos.recurrentes];
            
            const busqueda = document.getElementById('buscarRecurrente')?.value.toLowerCase() || '';
            if (busqueda) {
                recurrentes = recurrentes.filter(r => 
                    r.clienteNombre.toLowerCase().includes(busqueda) ||
                    r.concepto.toLowerCase().includes(busqueda)
                );
            }
            
            const filtroEstado = document.getElementById('filtroEstadoRecurrente')?.value || '';
            if (filtroEstado) {
                recurrentes = recurrentes.filter(r => r.estado === filtroEstado);
            }
            
            return recurrentes;
        }

        function filtrarRecurrentes() {
            updateRecurrentesTable();
        }

        function calcularProximaFecha(rec) {
            const inicio = new Date(rec.fechaInicio);
            const hoy = new Date();
            
            // L√≥gica b√°sica - se puede expandir seg√∫n necesidades
            switch(rec.frecuencia) {
                case 'mensual':
                    inicio.setMonth(inicio.getMonth() + 1);
                    break;
                case 'trimestral':
                    inicio.setMonth(inicio.getMonth() + 3);
                    break;
                case 'semestral':
                    inicio.setMonth(inicio.getMonth() + 6);
                    break;
                case 'anual':
                    inicio.setFullYear(inicio.getFullYear() + 1);
                    break;
            }
            
            return inicio.toISOString().split('T')[0];
        }

        function editarRecurrente(id) {
            const recurrente = datos.recurrentes.find(r => r.id === id);
            if (!recurrente) return;
            
            document.getElementById('clienteRecurrente').value = recurrente.clienteId;
            document.getElementById('conceptoRecurrente').value = recurrente.concepto;
            document.getElementById('importeRecurrente').value = recurrente.importe;
            document.getElementById('ivaRecurrente').value = recurrente.ivaPercent;
            document.getElementById('retencionRecurrente').checked = recurrente.aplicarRetencion;
            document.getElementById('frecuenciaRecurrente').value = recurrente.frecuencia;
            document.getElementById('diaEmision').value = recurrente.diaEmision;
            document.getElementById('fechaInicioRecurrente').value = recurrente.fechaInicio;
            document.getElementById('fechaFinRecurrente').value = recurrente.fechaFin || '';
            document.getElementById('enviarEmailRecurrente').checked = recurrente.enviarEmail;
            
            // Eliminar recurrente original para edici√≥n
            datos.recurrentes = datos.recurrentes.filter(r => r.id !== id);
            guardarDatos();
            updateRecurrentesTable();
            
            // Scroll autom√°tico hacia el t√≠tulo del formulario
            setTimeout(() => {
                const titulo = document.getElementById('tituloRecurrente');
                if (titulo) {
                    titulo.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        }

        function verRecurrente(id) {
            const rec = datos.recurrentes.find(r => r.id === id);
            if (!rec) return;
            
            const iva = rec.importe * (rec.ivaPercent / 100);
            const retencion = rec.aplicarRetencion ? rec.importe * 0.15 : 0;
            const total = rec.importe + iva - retencion;
            
            const content = `
                <div class="preview-container">
                    <h2>Detalle de Factura Recurrente</h2>
                    <table style="width: 100%; margin-top: 20px;">
                        <tr><td><strong>Cliente:</strong></td><td>${rec.clienteNombre}</td></tr>
                        <tr><td><strong>Concepto:</strong></td><td>${rec.concepto}</td></tr>
                        <tr><td><strong>Importe Base:</strong></td><td>${formatCurrency(rec.importe)}</td></tr>
                        <tr><td><strong>IVA (${rec.ivaPercent}%):</strong></td><td>${formatCurrency(iva)}</td></tr>
                        ${rec.aplicarRetencion ? `<tr><td><strong>Retenci√≥n (15%):</strong></td><td>-${formatCurrency(retencion)}</td></tr>` : ''}
                        <tr><td><strong>Total:</strong></td><td>${formatCurrency(total)}</td></tr>
                        <tr><td><strong>Frecuencia:</strong></td><td>${rec.frecuencia}</td></tr>
                        <tr><td><strong>D√≠a de emisi√≥n:</strong></td><td>${rec.diaEmision}</td></tr>
                        <tr><td><strong>Estado:</strong></td><td>${rec.estado}</td></tr>
                        <tr><td><strong>Inicio:</strong></td><td>${formatDate(rec.fechaInicio)}</td></tr>
                        <tr><td><strong>Fin:</strong></td><td>${formatDate(rec.fechaFin)}</td></tr>
                    </table>
                </div>
            `;
            
            document.getElementById('previewContent').innerHTML = content;
            document.getElementById('modalPreview').classList.add('active');
        }

        function imprimirRecurrente(id) {
            const rec = datos.recurrentes.find(r => r.id === id);
            if (!rec) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const iva = rec.importe * (rec.ivaPercent / 100);
            const retencion = rec.aplicarRetencion ? rec.importe * 0.15 : 0;
            const total = rec.importe + iva - retencion;
            
            doc.setFontSize(16);
            doc.text('FACTURA RECURRENTE', 20, 20);
            
            doc.setFontSize(10);
            doc.text(`Cliente: ${rec.clienteNombre}`, 20, 40);
            doc.text(`Concepto: ${rec.concepto}`, 20, 47);
            doc.text(`Frecuencia: ${rec.frecuencia}`, 20, 54);
            
            // Tabla de totales con headers azules
            doc.autoTable({
                head: [['Concepto', 'Importe']],
                body: [
                    ['Subtotal', formatCurrency(rec.importe)],
                    [`IVA (${rec.ivaPercent}%)`, formatCurrency(iva)],
                    ...(rec.aplicarRetencion ? [['Retenci√≥n (15%)', `-${formatCurrency(retencion)}`]] : []),
                    ['TOTAL', formatCurrency(total)]
                ],
                startY: 65,
                headStyles: {
                    fillColor: [52, 152, 219],
                    fontSize: 10,
                    textColor: [255, 255, 255]
                }
            });
            
            doc.save(`Recurrente_${rec.clienteNombre}_${rec.id}.pdf`);
        }

        function eliminarRecurrente(id) {
            if (confirm('¬øEliminar esta factura recurrente?')) {
                datos.recurrentes = datos.recurrentes.filter(r => r.id !== id);
                guardarDatos();
                updateRecurrentesTable();
            }
        }

        function limpiarFormularioRecurrente() {
            document.getElementById('recurrenteForm').reset();
        }

        // ===============================
        // LISTADO GENERAL
        // ===============================
        function updateListadoGeneralTable() {
            const tbody = document.getElementById('listadoGeneralTable');
            tbody.innerHTML = '';
            
            const operacionesFiltradas = filtrarGeneralActual();
            
            operacionesFiltradas.forEach(op => {
                const row = tbody.insertRow();
                let tipoClass = '';
                let tipoTexto = '';
                
                switch(op.tipo) {
                    case 'factura-emitida':
                        tipoClass = 'tipo-factura';
                        tipoTexto = 'FACT. EMITIDA';
                        break;
                    case 'factura-recibida':
                        tipoClass = 'tipo-gasto';
                        tipoTexto = 'FACT. RECIBIDA';
                        break;
                    case 'recurrente':
                        tipoClass = 'tipo-recurrente';
                        tipoTexto = 'RECURRENTE';
                        break;
                }
                
                const estadoClass = op.estado === 'Pagado' || op.estado === 'activa' ? 'estado-pagado' : 'estado-pendiente';
                const nombreCliente = op.cliente || op.proveedor || op.clienteNombre || '-';
                const numero = op.numero || '-';
                
                row.innerHTML = `
                    <td>${formatDate(op.fecha || op.fechaInicio)}</td>
                    <td><span class="${tipoClass}">${tipoTexto}</span></td>
                    <td>${numero}</td>
                    <td>${nombreCliente}</td>
                    <td>${(op.descripcion || op.concepto || '').substring(0, 50)}${(op.descripcion || op.concepto || '').length > 50 ? '...' : ''}</td>
                    <td>${formatCurrency(op.total || ((op.importe || 0) * (1 + (op.ivaPercent || 0) / 100) - (op.aplicarRetencion ? (op.importe || 0) * 0.15 : 0)))}</td>
                    <td><span class="${estadoClass}">${op.estado || 'Activa'}</span></td>
                    <td class="action-buttons">
                        <button class="btn btn-info btn-small" onclick="editarOperacionGeneral('${op.tipo}', ${op.id})">‚úèÔ∏è</button>
                        <button class="btn btn-primary btn-small" onclick="verOperacionGeneral('${op.tipo}', ${op.id})">üëÅÔ∏è</button>
                        <button class="btn btn-success btn-small" onclick="imprimirOperacionGeneral('${op.tipo}', ${op.id})">üñ®Ô∏è</button>
                        <button class="btn btn-danger btn-small" onclick="eliminarOperacionGeneral('${op.tipo}', ${op.id})">üóëÔ∏è</button>
                    </td>
                `;
            });
        }

        function filtrarGeneralActual() {
            // Combinar todas las operaciones
            const operaciones = [
                ...datos.facturasEmitidas,
                ...datos.facturasRecibidas,
                ...datos.recurrentes
            ];
            
            let operacionesFiltradas = [...operaciones];
            
            const busqueda = document.getElementById('buscarGeneral')?.value.toLowerCase() || '';
            if (busqueda) {
                operacionesFiltradas = operacionesFiltradas.filter(op => 
                    (op.numero && op.numero.toLowerCase().includes(busqueda)) ||
                    (op.cliente && op.cliente.toLowerCase().includes(busqueda)) ||
                    (op.proveedor && op.proveedor.toLowerCase().includes(busqueda)) ||
                    (op.clienteNombre && op.clienteNombre.toLowerCase().includes(busqueda)) ||
                    (op.descripcion && op.descripcion.toLowerCase().includes(busqueda)) ||
                    (op.concepto && op.concepto.toLowerCase().includes(busqueda))
                );
            }
            
            const filtroTipo = document.getElementById('filtroTipoGeneral')?.value || '';
            if (filtroTipo) {
                operacionesFiltradas = operacionesFiltradas.filter(op => op.tipo === filtroTipo);
            }
            
            const filtroEstado = document.getElementById('filtroEstadoGeneral')?.value || '';
            if (filtroEstado) {
                operacionesFiltradas = operacionesFiltradas.filter(op => op.estado === filtroEstado);
            }
            
            // Ordenar por fecha descendente
            operacionesFiltradas.sort((a, b) => {
                const fechaA = new Date(a.fecha || a.fechaInicio);
                const fechaB = new Date(b.fecha || b.fechaInicio);
                return fechaB - fechaA;
            });
            
            return operacionesFiltradas;
        }

        function filtrarGeneral() {
            updateListadoGeneralTable();
        }

        function editarOperacionGeneral(tipo, id) {
            switch(tipo) {
                case 'factura-emitida':
                    editarFacturaEmitida(id);
                    break;
                case 'factura-recibida':
                    editarFacturaRecibida(id);
                    break;
                case 'recurrente':
                    editarRecurrente(id);
                    break;
            }
        }

        function verOperacionGeneral(tipo, id) {
            switch(tipo) {
                case 'factura-emitida':
                    verFacturaEmitida(id);
                    break;
                case 'factura-recibida':
                    verFacturaRecibida(id);
                    break;
                case 'recurrente':
                    verRecurrente(id);
                    break;
            }
        }

        function imprimirOperacionGeneral(tipo, id) {
            switch(tipo) {
                case 'factura-emitida':
                    imprimirFacturaEmitida(id);
                    break;
                case 'factura-recibida':
                    imprimirFacturaRecibida(id);
                    break;
                case 'recurrente':
                    imprimirRecurrente(id);
                    break;
            }
        }

        function eliminarOperacionGeneral(tipo, id) {
            switch(tipo) {
                case 'factura-emitida':
                    eliminarFacturaEmitida(id);
                    break;
                case 'factura-recibida':
                    eliminarFacturaRecibida(id);
                    break;
                case 'recurrente':
                    eliminarRecurrente(id);
                    break;
            }
        }

        // ===============================
        // SISTEMA DE IMPRESI√ìN UNIFICADO CON HEADERS AZULES
        // ===============================
        function generarHTMLFactura(factura) {
            let conceptosHTML = '';
            if (factura.conceptos) {
                factura.conceptos.forEach(concepto => {
                    conceptosHTML += `
                        <tr>
                            <td style="padding: 12px 8px; border-bottom: 1px solid #dee2e6; color: #212529;">${concepto.descripcion}</td>
                            <td style="padding: 12px 8px; text-align: right; border-bottom: 1px solid #dee2e6; color: #212529; width: 120px;">${formatCurrency(concepto.total)}</td>
                        </tr>
                    `;
                });
            }

            const logoHTML = configDespacho.logo ? 
                `<img src="${configDespacho.logo}" alt="Logo" style="max-height: 60px; max-width: 180px; object-fit: contain;">` : 
                '';
            
            const esEmitida = factura.tipo === 'factura-emitida';
            const clienteProveedor = esEmitida ? factura.cliente : factura.proveedor;
            
            // Obtener direcci√≥n del cliente/proveedor si existe
            let direccionContacto = '';
            if (esEmitida) {
                const cliente = datos.clientes.find(c => c.nombre === clienteProveedor);
                if (cliente && cliente.direccion) {
                    direccionContacto = cliente.direccion;
                }
            } else {
                const proveedor = datos.proveedores.find(p => p.nombre === clienteProveedor);
                if (proveedor && proveedor.direccion) {
                    direccionContacto = proveedor.direccion;
                }
            }
            
            return `
                <div class="preview-container" style="max-width: 800px; margin: 0 auto; padding: 40px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 11pt; line-height: 1.4;">
                    
                    <!-- Encabezado con logo y datos del despacho -->
                    <div style="text-align: left; margin-bottom: 40px;">
                        ${logoHTML}
                    </div>
                    
                    <div style="text-align: right; margin-bottom: 60px;">
                        <p style="margin: 3px 0; color: #2c3e50;"><strong>${configDespacho.nombre || 'Mi Despacho'}</strong></p>
                        <p style="margin: 3px 0; color: #495057; font-size: 10pt;">${configDespacho.nif || ''}</p>
                        <p style="margin: 3px 0; color: #495057; font-size: 10pt;">${configDespacho.direccion || ''}</p>
                        <p style="margin: 3px 0; color: #495057; font-size: 10pt;">${configDespacho.ciudad || ''}</p>
                        <p style="margin: 3px 0; color: #495057; font-size: 10pt;">${configDespacho.email || ''}</p>
                        <p style="margin: 3px 0; color: #495057; font-size: 10pt;">${configDespacho.telefono || ''}</p>
                    </div>
                    
                    <!-- Info de factura -->
                    <div style="text-align: right; margin-bottom: 30px;">
                        <table style="margin-left: auto; border-collapse: collapse;">
                            <tr>
                                <td style="padding: 5px 15px 5px 0; text-align: right; color: #6c757d;"><strong>FACTURA</strong></td>
                                <td style="padding: 5px 0; color: #2c3e50;">${factura.numero}</td>
                            </tr>
                            <tr>
                                <td style="padding: 5px 15px 5px 0; text-align: right; color: #6c757d;"><strong>FECHA</strong></td>
                                <td style="padding: 5px 0; color: #2c3e50;">${formatDate(factura.fecha)}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- T√≠tulo -->
                    <h2 style="text-align: center; margin: 30px 0; font-weight: 700; font-size: 14pt; color: #2c3e50;">MINUTA DE HONORARIOS</h2>
                    
                    <!-- Datos del cliente -->
                    <div style="margin-bottom: 40px; padding-left: 8px;">
                        <p style="margin: 8px 0; color: #6c757d;"><strong>${esEmitida ? 'CLIENTE' : 'PROVEEDOR'}</strong></p>
                        <p style="margin: 8px 0; color: #2c3e50; font-weight: 600;">${clienteProveedor}</p>
                        ${factura.nif ? `<p style="margin: 8px 0; color: #495057;">${factura.nif}</p>` : ''}
                        ${direccionContacto ? `<p style="margin: 8px 0; color: #495057;">${direccionContacto}</p>` : ''}
                    </div>
                    
                    <!-- Tabla de conceptos -->
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 40px;">
                        <thead>
                            <tr>
                                <th style="padding: 12px 8px; text-align: left; border-bottom: 2px solid #2c3e50; font-weight: 700; color: #2c3e50;">DESCRIPCI√ìN DEL ASUNTO</th>
                                <th style="padding: 12px 8px; text-align: right; border-bottom: 2px solid #2c3e50; font-weight: 700; color: #2c3e50; width: 120px;">HONORARIOS</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${conceptosHTML}
                        </tbody>
                    </table>
                    
                    <!-- Totales -->
                    <div style="text-align: right; margin-bottom: 60px;">
                        <table style="margin-left: auto; width: 300px; border-collapse: collapse;">
                            <tr>
                                <td style="padding: 8px 20px 8px 0; text-align: right; color: #495057;"><strong>BASE IMPONIBLE</strong></td>
                                <td style="padding: 8px 8px 8px 0; text-align: right; color: #2c3e50; width: 120px;">${formatCurrency(factura.subtotal)}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 20px 8px 0; text-align: right; color: #495057;"><strong>IVA (${factura.ivaPercent}%)</strong></td>
                                <td style="padding: 8px 8px 8px 0; text-align: right; color: #2c3e50; width: 120px;">${formatCurrency(factura.ivaImporte)}</td>
                            </tr>
                            ${factura.retencion && factura.retencion > 0 ? `
                            <tr>
                                <td style="padding: 8px 20px 8px 0; text-align: right; color: #495057;"><strong>RET (15%)</strong></td>
                                <td style="padding: 8px 8px 8px 0; text-align: right; color: #e74c3c; width: 120px;">-${formatCurrency(factura.retencion)}</td>
                            </tr>
                            ` : ''}
                            <tr>
                                <td style="padding: 12px 20px 8px 0; text-align: right; border-top: 2px solid #2c3e50; color: #2c3e50;"><strong>TOTAL</strong></td>
                                <td style="padding: 12px 8px 8px 0; text-align: right; border-top: 2px solid #2c3e50; color: #2c3e50; width: 120px;"><strong>${formatCurrency(factura.total)}</strong></td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- Informaci√≥n de pago -->
                    ${configDespacho.infoBancaria ? `
                    <div style="margin-top: 60px; padding-top: 20px; border-top: 1px solid #dee2e6; text-align: center; font-size: 10pt;">
                        <p style="margin: 5px 0; color: #6c757d;">${configDespacho.infoBancaria}</p>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        function generarPDFFactura(factura) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const esEmitida = factura.tipo === 'factura-emitida';
            const clienteProveedor = esEmitida ? factura.cliente : factura.proveedor;
            
            // Obtener direcci√≥n del cliente/proveedor si existe
            let direccionContacto = '';
            if (esEmitida) {
                const cliente = datos.clientes.find(c => c.nombre === clienteProveedor);
                if (cliente && cliente.direccion) {
                    direccionContacto = cliente.direccion;
                }
            } else {
                const proveedor = datos.proveedores.find(p => p.nombre === clienteProveedor);
                if (proveedor && proveedor.direccion) {
                    direccionContacto = proveedor.direccion;
                }
            }
            
            // Logo en la esquina superior izquierda - MANTENER PROPORCI√ìN ORIGINAL
            if (configDespacho.logo) {
                try {
                    // Crear imagen temporal para obtener dimensiones originales
                    const img = new Image();
                    img.src = configDespacho.logo;
                    
                    // Calcular dimensiones manteniendo proporci√≥n
                    const maxWidth = 60;  // Ancho m√°ximo en el PDF
                    const maxHeight = 30; // Alto m√°ximo en el PDF
                    
                    let width = img.width;
                    let height = img.height;
                    const aspectRatio = width / height;
                    
                    // Escalar manteniendo proporci√≥n
                    if (width > maxWidth) {
                        width = maxWidth;
                        height = width / aspectRatio;
                    }
                    if (height > maxHeight) {
                        height = maxHeight;
                        width = height * aspectRatio;
                    }
                    
                    // Centrar el logo en el espacio asignado
                    const xPos = 20 + (maxWidth - width) / 2;
                    doc.addImage(configDespacho.logo, 'PNG', xPos, 15, width, height);
                } catch (e) {
                    console.log('No se pudo a√±adir el logo al PDF');
                }
            }
            
            // Informaci√≥n del despacho (alineada a la derecha)
            doc.setFontSize(10);
            let yPos = 45;
            
            // Nombre en negrita con color oscuro
            doc.setFont(undefined, 'bold');
            doc.setTextColor(44, 62, 80); // #2c3e50
            doc.text(configDespacho.nombre || 'Mi Despacho', 200, yPos, { align: 'right' });
            
            // Resto de datos con color gris
            doc.setFont(undefined, 'normal');
            doc.setTextColor(73, 80, 87); // #495057
            yPos += 5;
            doc.text(configDespacho.nif || '', 200, yPos, { align: 'right' });
            yPos += 5;
            doc.text(configDespacho.direccion || '', 200, yPos, { align: 'right' });
            yPos += 5;
            doc.text(configDespacho.ciudad || '', 200, yPos, { align: 'right' });
            yPos += 5;
            doc.text(configDespacho.email || '', 200, yPos, { align: 'right' });
            yPos += 5;
            doc.text(configDespacho.telefono || '', 200, yPos, { align: 'right' });
            
            // Informaci√≥n de la factura (alineada a la derecha)
            yPos += 15;
            doc.setFontSize(10);
            
            // Etiqueta FACTURA en gris medio
            doc.setFont(undefined, 'bold');
            doc.setTextColor(108, 117, 125); // #6c757d
            doc.text('FACTURA', 145, yPos);
            
            // N√∫mero de factura en gris oscuro
            doc.setFont(undefined, 'normal');
            doc.setTextColor(44, 62, 80); // #2c3e50
            doc.text(`${factura.numero}`, 200, yPos, { align: 'right' });
            
            yPos += 6;
            // Etiqueta FECHA en gris medio
            doc.setFont(undefined, 'bold');
            doc.setTextColor(108, 117, 125); // #6c757d
            doc.text('FECHA', 145, yPos);
            
            // Fecha en gris oscuro
            doc.setFont(undefined, 'normal');
            doc.setTextColor(44, 62, 80); // #2c3e50
            doc.text(formatDate(factura.fecha), 200, yPos, { align: 'right' });
            
            // T√≠tulo "MINUTA DE HONORARIOS" en gris oscuro
            yPos += 20;
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(44, 62, 80); // #2c3e50 - mismo color que DESCRIPCI√ìN DEL ASUNTO
            doc.text('MINUTA DE HONORARIOS', 105, yPos, { align: 'center' });
            
            // Datos del cliente
            yPos += 15;
            doc.setFontSize(10);
            doc.setTextColor(108, 117, 125); // #6c757d para etiqueta CLIENTE
            doc.text(esEmitida ? 'CLIENTE' : 'PROVEEDOR', 25, yPos); // X=25 (margin 20 + padding 5)
            
            yPos += 6;
            doc.setFont(undefined, 'bold');
            doc.setTextColor(44, 62, 80); // #2c3e50 para el nombre del cliente
            doc.text(clienteProveedor, 25, yPos); // X=25 (margin 20 + padding 5)
            yPos += 5;
            doc.setFont(undefined, 'normal');
            doc.setTextColor(73, 80, 87); // #495057 - gris para NIF y direcci√≥n
            if (factura.nif) {
                doc.text(factura.nif, 25, yPos); // X=25 (margin 20 + padding 5)
                yPos += 5;
            }
            if (direccionContacto) {
                doc.text(direccionContacto, 25, yPos); // X=25 (margin 20 + padding 5)
                yPos += 5;
            }
            
            // Tabla de conceptos simplificada (solo descripci√≥n y honorarios)
            yPos += 10;
            let tableData = [];
            if (factura.conceptos) {
                tableData = factura.conceptos.map(c => [
                    c.descripcion,
                    formatCurrency(c.total)
                ]);
            }
            
            doc.autoTable({
                head: [['DESCRIPCI√ìN DEL ASUNTO', 'HONORARIOS']],
                body: tableData,
                startY: yPos,
                headStyles: {
                    fillColor: [255, 255, 255],
                    textColor: [44, 62, 80], // #2c3e50
                    fontSize: 10,
                    fontStyle: 'bold',
                    lineWidth: { top: 0, right: 0, bottom: 1, left: 0 },
                    lineColor: [44, 62, 80] // #2c3e50
                },
                bodyStyles: {
                    fillColor: [255, 255, 255], // Fondo blanco sin gris
                    fontSize: 10,
                    textColor: [33, 37, 41], // #212529
                    lineWidth: 0,
                    lineColor: [222, 226, 230] // #dee2e6
                },
                columnStyles: {
                    0: { cellWidth: 135 },
                    1: { halign: 'right', cellWidth: 45 } // Alineado a la derecha para que S y ‚Ç¨ coincidan
                },
                margin: { left: 20, right: 10 },
                alternateRowStyles: {
                    fillColor: [255, 255, 255] // Fondo blanco tambi√©n para filas alternas
                }
            });
            
            // Totales - alineados con el mismo padding que HONORARIOS
            const finalY = doc.lastAutoTable.finalY + 15;
            
            doc.setFontSize(10);
            
            // Posici√≥n X para las etiquetas y valores
            const labelX = 120;
            const valueX = 195; // Alineado con padding derecho igual que la columna HONORARIOS (200 - 5 padding)
            
            // BASE IMPONIBLE
            doc.setFont(undefined, 'bold');
            doc.setTextColor(73, 80, 87); // #495057
            doc.text('BASE IMPONIBLE', labelX, finalY);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(44, 62, 80); // #2c3e50
            doc.text(formatCurrency(factura.subtotal), valueX, finalY, { align: 'right' });
            
            // IVA
            doc.setFont(undefined, 'bold');
            doc.setTextColor(73, 80, 87); // #495057
            doc.text(`IVA (${factura.ivaPercent}%)`, labelX, finalY + 6);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(44, 62, 80); // #2c3e50
            doc.text(formatCurrency(factura.ivaImporte), valueX, finalY + 6, { align: 'right' });
            
            let lineY = finalY + 12;
            if (factura.retencion && factura.retencion > 0) {
                doc.setFont(undefined, 'bold');
                doc.setTextColor(73, 80, 87); // #495057
                doc.text('RET (15%)', labelX, finalY + 12);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(231, 76, 60); // Rojo para retenci√≥n
                doc.text(`-${formatCurrency(factura.retencion)}`, valueX, finalY + 12, { align: 'right' });
                lineY = finalY + 18;
            }
            
            // L√≠nea separadora delgada
            doc.setLineWidth(0.5);
            doc.setDrawColor(44, 62, 80); // #2c3e50
            doc.line(labelX, lineY, valueX, lineY);
            
            // Total final - en gris oscuro como DESCRIPCI√ìN
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(44, 62, 80); // #2c3e50 - mismo color que DESCRIPCI√ìN
            doc.text('TOTAL', labelX, lineY + 6);
            doc.text(formatCurrency(factura.total), valueX, lineY + 6, { align: 'right' });
            
            // Informaci√≥n bancaria como pie de p√°gina
            if (configDespacho.infoBancaria) {
                const infoY = 260; // Posici√≥n fija para pie de p√°gina
                
                // L√≠nea separadora superior
                doc.setLineWidth(0.3);
                doc.setDrawColor(200, 200, 200); // Gris claro
                doc.line(20, infoY - 5, 190, infoY - 5);
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(8.5);
                doc.setTextColor(100, 100, 100); // Gris medio
                
                // Dividir el texto largo en l√≠neas para el PDF
                const textLines = doc.splitTextToSize(configDespacho.infoBancaria, 170);
                doc.text(textLines, 105, infoY, { align: 'center' });
            }
            
            // Descargar PDF con formato: "1-0189 MARTA LAGO PALMEIRO.pdf"
            doc.save(`${factura.numero} ${clienteProveedor}.pdf`);
        }

        function crearRecurrente(tipo) {
            // Prellenar formulario de recurrente con datos de la factura actual
            if (tipo === 'emitida') {
                const subtotal = parseFloat(document.getElementById('subtotalFacturaEmitida').value);
                const ivaPercent = parseFloat(document.getElementById('ivaFacturaEmitida').value);
                const retencion = document.getElementById('aplicarRetencionEmitida').checked;
                
                showSubTab('recurrentes', document.querySelector('[onclick*="recurrentes"]'));
                
                // Prellenar campos
                document.getElementById('importeRecurrente').value = subtotal;
                document.getElementById('ivaRecurrente').value = ivaPercent;
                document.getElementById('retencionRecurrente').checked = retencion;
                
                const conceptos = [];
                document.querySelectorAll('#conceptosFacturaEmitida .concepto-item').forEach(item => {
                    const desc = item.querySelector('.concepto-desc').value;
                    if (desc) conceptos.push(desc);
                });
                document.getElementById('conceptoRecurrente').value = conceptos.join(', ');
            }
        }

        function vistaPrevia(tipo) {
            let factura = {};
            
            if (tipo === 'emitida') {
                factura = {
                    tipo: 'factura-emitida',
                    fecha: document.getElementById('fechaFacturaEmitida').value,
                    numero: document.getElementById('numeroFacturaEmitida').value || generarNumeroFactura(),
                    vencimiento: document.getElementById('vencimientoFacturaEmitida').value,
                    cliente: document.getElementById('clienteFacturaEmitida').value,
                    nif: document.getElementById('nifFacturaEmitida').value,
                    descripcion: document.getElementById('descripcionFacturaEmitida').value,
                    conceptos: [],
                    subtotal: parseFloat(document.getElementById('subtotalFacturaEmitida').value),
                    ivaPercent: parseFloat(document.getElementById('ivaFacturaEmitida').value),
                    ivaImporte: parseFloat(document.getElementById('ivaImporteEmitida').value),
                    retencion: parseFloat(document.getElementById('retencionImporteEmitida').value),
                    total: parseFloat(document.getElementById('totalFacturaEmitida').value)
                };
                
                document.querySelectorAll('#conceptosFacturaEmitida .concepto-item').forEach(item => {
                    const desc = item.querySelector('.concepto-desc').value;
                    const cantidad = parseFloat(item.querySelector('.concepto-cantidad').value) || 0;
                    const precio = parseFloat(item.querySelector('.concepto-precio').value) || 0;
                    
                    if (desc && cantidad && precio) {
                        factura.conceptos.push({
                            descripcion: desc,
                            cantidad: cantidad,
                            precio: precio,
                            total: cantidad * precio
                        });
                    }
                });
            } else if (tipo === 'recibida') {
                factura = {
                    tipo: 'factura-recibida',
                    fecha: document.getElementById('fechaFacturaRecibida').value,
                    numero: document.getElementById('numeroFacturaRecibida').value,
                    vencimiento: document.getElementById('vencimientoFacturaRecibida').value,
                    proveedor: document.getElementById('proveedorFacturaRecibida').value,
                    nif: document.getElementById('nifFacturaRecibida').value,
                    descripcion: document.getElementById('descripcionFacturaRecibida').value,
                    conceptos: [],
                    subtotal: parseFloat(document.getElementById('subtotalFacturaRecibida').value),
                    ivaPercent: parseFloat(document.getElementById('ivaFacturaRecibida').value),
                    ivaImporte: parseFloat(document.getElementById('ivaImporteRecibida').value),
                    total: parseFloat(document.getElementById('totalFacturaRecibida').value)
                };
                
                document.querySelectorAll('#conceptosFacturaRecibida .concepto-item').forEach(item => {
                    const desc = item.querySelector('.concepto-desc').value;
                    const cantidad = parseFloat(item.querySelector('.concepto-cantidad').value) || 0;
                    const precio = parseFloat(item.querySelector('.concepto-precio').value) || 0;
                    
                    if (desc && cantidad && precio) {
                        factura.conceptos.push({
                            descripcion: desc,
                            cantidad: cantidad,
                            precio: precio,
                            total: cantidad * precio
                        });
                    }
                });
            }
            
            const content = generarHTMLFactura(factura);
            document.getElementById('previewContent').innerHTML = content;
            document.getElementById('modalPreview').classList.add('active');
        }

        function cerrarModal() {
            document.getElementById('modalPreview').classList.remove('active');
        }

        // ===============================
        // MODAL CONTACTO R√ÅPIDO
        // ===============================
        let contactoRapidoConfig = {
            tipo: 'cliente', // 'cliente' o 'proveedor'
            campoDestino: '' // ID del campo donde se rellenar√° el nombre
        };

        function abrirModalContactoRapido(tipo, campoDestino) {
            contactoRapidoConfig.tipo = tipo;
            contactoRapidoConfig.campoDestino = campoDestino;
            
            // Actualizar t√≠tulo del modal
            const titulo = tipo === 'cliente' ? '‚ûï A√±adir Cliente R√°pido' : '‚ûï A√±adir Proveedor R√°pido';
            document.getElementById('tituloContactoRapido').textContent = titulo;
            
            // Limpiar formulario
            document.getElementById('formContactoRapido').reset();
            
            // Si hay texto en el campo de cliente/proveedor, usarlo como nombre por defecto
            const campoActual = document.getElementById(campoDestino);
            if (campoActual && campoActual.value) {
                document.getElementById('nombreContactoRapido').value = campoActual.value;
            }
            
            // Mostrar modal
            document.getElementById('modalContactoRapido').classList.add('active');
            
            // Enfocar el campo de nombre
            setTimeout(() => {
                document.getElementById('nombreContactoRapido').focus();
            }, 100);
        }

        function cerrarModalContactoRapido() {
            document.getElementById('modalContactoRapido').classList.remove('active');
            document.getElementById('formContactoRapido').reset();
        }

        function guardarContactoRapido(event) {
            event.preventDefault();
            
            const tipo = contactoRapidoConfig.tipo;
            const contacto = {
                id: Date.now(),
                tipo: tipo,
                nombre: document.getElementById('nombreContactoRapido').value,
                nif: document.getElementById('nifContactoRapido').value,
                email: document.getElementById('emailContactoRapido').value,
                telefono: document.getElementById('telefonoContactoRapido').value,
                direccion: document.getElementById('direccionContactoRapido').value,
                fechaCreacion: new Date().toISOString()
            };
            
            // Guardar en el array correspondiente
            if (tipo === 'cliente') {
                datos.clientes.push(contacto);
            } else {
                datos.proveedores.push(contacto);
            }
            
            // Guardar datos
            guardarDatos();
            
            // Actualizar listas
            updateContactosTable();
            actualizarListaContactos();
            
            // Rellenar el campo de destino con el nombre del contacto
            const campoDestino = document.getElementById(contactoRapidoConfig.campoDestino);
            if (campoDestino) {
                campoDestino.value = contacto.nombre;
                
                // Si hay un campo NIF correspondiente, rellenarlo tambi√©n
                if (contactoRapidoConfig.campoDestino === 'clienteFacturaEmitida') {
                    const nifField = document.getElementById('nifFacturaEmitida');
                    if (nifField && contacto.nif) {
                        nifField.value = contacto.nif;
                    }
                } else if (contactoRapidoConfig.campoDestino === 'proveedorFacturaRecibida') {
                    const nifField = document.getElementById('nifFacturaRecibida');
                    if (nifField && contacto.nif) {
                        nifField.value = contacto.nif;
                    }
                }
            }
            
            // Cerrar modal
            cerrarModalContactoRapido();
            
            // Mostrar notificaci√≥n
            const tipoTexto = tipo === 'cliente' ? 'Cliente' : 'Proveedor';
            mostrarNotificacion(`‚úÖ ${tipoTexto} "${contacto.nombre}" a√±adido correctamente`, 'success');
        }

        // ===============================
        // IMPORTACI√ìN/EXPORTACI√ìN ADAPTADA AL NUEVO FORMATO CON RETENCIONES CORREGIDAS
        // ===============================
        function importarArchivo(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    let facturas_importadas = 0;
                    let facturas_omitidas = 0;
                    
                    // Asegurar que las propiedades existen
                    if (!datos.facturasEmitidas) datos.facturasEmitidas = [];
                    if (!datos.facturasRecibidas) datos.facturasRecibidas = [];
                    
                    // Importar hoja de INGRESOS como facturas emitidas
                    if (workbook.SheetNames.includes('INGRESOS')) {
                        const sheet = workbook.Sheets['INGRESOS'];
                        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                        
                        // Encontrar fila de headers
                        let headerRow = -1;
                        for (let i = 0; i < jsonData.length; i++) {
                            if (jsonData[i][0] === 'Fecha') {
                                headerRow = i;
                                break;
                            }
                        }
                        
                        if (headerRow !== -1) {
                            for (let i = headerRow + 1; i < jsonData.length; i++) {
                                const row = jsonData[i];
                                if (row[0] && !row[0].toString().includes('TRIMESTRE')) {
                                    const fechaFactura = convertirFecha(row[0]);
                                    const numeroFactura = row[1] || '';
                                    
                                    // VERIFICAR SI LA FACTURA YA EXISTE
                                    if (facturaExiste('emitida', numeroFactura, fechaFactura)) {
                                        facturas_omitidas++;
                                        continue; // Saltar esta factura duplicada
                                    }
                                    
                                    const subtotalImportado = parseSpanishNumber(row[11]);
                                    const ivaImportado = parseSpanishNumber(row[12]);
                                    // CORRECCI√ìN: La retenci√≥n viene NEGATIVA en el Excel
                                    // Ejemplo: -1.88, -22.5, etc.
                                    const retencionEnExcel = parseSpanishNumber(row[13]) || 0;
                                    // Guardamos el valor ABSOLUTO (positivo) de la retenci√≥n
                                    const retencionImportada = Math.abs(retencionEnExcel);
                                    const totalImportado = parseSpanishNumber(row[16]);
                                    
                                    // CORRECCI√ìN: Calcular correctamente el porcentaje de IVA
                                    let ivaPercent = 21; // Valor por defecto
                                    if (subtotalImportado > 0 && ivaImportado > 0) {
                                        const porcentajeCalculado = Math.round((ivaImportado / subtotalImportado) * 100);
                                        // Validar que el porcentaje sea uno de los est√°ndar
                                        if ([0, 4, 10, 21].includes(porcentajeCalculado)) {
                                            ivaPercent = porcentajeCalculado;
                                        }
                                    } else if (ivaImportado === 0) {
                                        ivaPercent = 0;
                                    }
                                    
                                    // NUEVO: Detectar si debe aplicarse retenci√≥n
                                    // Si la retenci√≥n es diferente de 0, marcamos la casilla
                                    const aplicarRetencion = retencionEnExcel !== 0;
                                    
                                    const factura = {
                                        id: Date.now() + i + Math.random() * 1000,
                                        tipo: 'factura-emitida',
                                        fecha: convertirFecha(row[0]),
                                        numero: row[1] || '',
                                        cliente: row[3] || '',
                                        descripcion: row[4] || '',
                                        conceptos: [{
                                            descripcion: row[4] || '',
                                            cantidad: 1,
                                            precio: subtotalImportado,
                                            total: subtotalImportado
                                        }],
                                        subtotal: subtotalImportado,
                                        ivaPercent: ivaPercent,
                                        ivaImporte: ivaImportado,
                                        retencion: retencionImportada, // Guardamos el valor ABSOLUTO
                                        aplicarRetencion: aplicarRetencion, // Marcamos si hay retenci√≥n
                                        total: totalImportado,
                                        estado: row[19] === 'Pagado' ? 'Pagado' : 'Pendiente', // Columna 20 (Estado): normalizar a Pagado/Pendiente
                                        fechaCobro: row[20] ? convertirFecha(row[20]) : '', // Columna 21 (Fecha de cobro)
                                        tags: row[5] || '',
                                        cuenta: row[6] || '',
                                        proyecto: row[8] || ''
                                    };
                                    
                                    datos.facturasEmitidas.push(factura);
                                    facturas_importadas++;
                                }
                            }
                        }
                    }
                    
                    // Importar hoja de GASTOS como facturas recibidas
                    if (workbook.SheetNames.includes('GASTOS')) {
                        const sheet = workbook.Sheets['GASTOS'];
                        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                        
                        // Encontrar fila de headers
                        let headerRow = -1;
                        for (let i = 0; i < jsonData.length; i++) {
                            if (jsonData[i][0] === 'Fecha emisi√≥n' || jsonData[i][0] === 'Fecha') {
                                headerRow = i;
                                break;
                            }
                        }
                        
                        if (headerRow !== -1) {
                            for (let i = headerRow + 1; i < jsonData.length; i++) {
                                const row = jsonData[i];
                                if (row[0] && !row[0].toString().includes('TRIMESTRE')) {
                                    const fechaFactura = convertirFecha(row[0]);
                                    const numeroFactura = row[1] || '';
                                    
                                    // VERIFICAR SI LA FACTURA YA EXISTE
                                    if (facturaExiste('recibida', numeroFactura, fechaFactura)) {
                                        facturas_omitidas++;
                                        continue; // Saltar esta factura duplicada
                                    }
                                    
                                    const subtotalImportado = parseSpanishNumber(row[10]);
                                    const ivaImportado = parseSpanishNumber(row[11]);
                                    const totalImportado = parseSpanishNumber(row[15]);
                                    
                                    // CORRECCI√ìN: Calcular correctamente el porcentaje de IVA para gastos
                                    let ivaPercent = 21; // Valor por defecto
                                    if (subtotalImportado > 0 && ivaImportado > 0) {
                                        const porcentajeCalculado = Math.round((ivaImportado / subtotalImportado) * 100);
                                        // Validar que el porcentaje sea uno de los est√°ndar
                                        if ([0, 4, 10, 21].includes(porcentajeCalculado)) {
                                            ivaPercent = porcentajeCalculado;
                                        }
                                    } else if (ivaImportado === 0) {
                                        ivaPercent = 0;
                                    }
                                    
                                    const factura = {
                                        id: Date.now() + i + 10000 + Math.random() * 1000,
                                        tipo: 'factura-recibida',
                                        fecha: fechaFactura,
                                        numero: numeroFactura,
                                        proveedor: row[5] || '',
                                        descripcion: row[6] || '',
                                        conceptos: [{
                                            descripcion: row[6] || '',
                                            cantidad: 1,
                                            precio: subtotalImportado,
                                            total: subtotalImportado
                                        }],
                                        subtotal: subtotalImportado,
                                        ivaPercent: ivaPercent,
                                        ivaImporte: ivaImportado,
                                        total: totalImportado,
                                        estado: row[18] === 'Pagado' ? 'Pagado' : 'Pendiente', // Solo dos estados v√°lidos
                                        fechaPago: row[19] ? convertirFecha(row[19]) : '',
                                        tags: row[7] || '',
                                        cuenta: row[8] || '',
                                        proyecto: row[9] || ''
                                    };
                                    
                                    datos.facturasRecibidas.push(factura);
                                    facturas_importadas++;
                                }
                            }
                        }
                    }
                    
                    guardarDatos();
                    updateAllTables();
                    updateDashboard();
                    
                    let mensajeStatus = `
                        <div class="notification success" style="position: static;">
                            ‚úÖ Importaci√≥n completada:<br>
                            - ${facturas_importadas} facturas importadas`;
                    
                    if (facturas_omitidas > 0) {
                        mensajeStatus += `<br>- ${facturas_omitidas} facturas omitidas (ya exist√≠an)`;
                    }
                    
                    mensajeStatus += `<br>- Retenciones procesadas correctamente
                        </div>
                    `;
                    
                    document.getElementById('importStatus').innerHTML = mensajeStatus;
                    
                    let mensajeNotif = `‚úÖ Importaci√≥n exitosa: ${facturas_importadas} facturas importadas`;
                    if (facturas_omitidas > 0) {
                        mensajeNotif += `, ${facturas_omitidas} duplicadas omitidas`;
                    }
                    
                    mostrarNotificacion(mensajeNotif, 'success');
                    
                } catch (error) {
                    console.error('Error en importaci√≥n:', error);
                    document.getElementById('importStatus').innerHTML = `
                        <div class="notification error" style="position: static;">
                            ‚ö† Error al importar: ${error.message}
                        </div>
                    `;
                    mostrarNotificacion('‚ö† Error en la importaci√≥n: ' + error.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function importarClientesExcel(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    let clientesImportados = 0;
                    let proveedoresImportados = 0;
                    
                    // Buscar hoja de clientes
                    const sheetNames = ['CLIENTES', 'Clientes', 'clientes', 'Sheet1'];
                    let sheet = null;
                    let sheetName = '';
                    
                    for (const name of sheetNames) {
                        if (workbook.SheetNames.includes(name)) {
                            sheet = workbook.Sheets[name];
                            sheetName = name;
                            break;
                        }
                    }
                    
                    if (sheet) {
                        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                        
                        // Encontrar fila de headers
                        let headerRow = -1;
                        for (let i = 0; i < jsonData.length; i++) {
                            if (jsonData[i][0] && (
                                jsonData[i][0].toString().toLowerCase().includes('tipo') ||
                                jsonData[i][0].toString().toLowerCase().includes('nombre')
                            )) {
                                headerRow = i;
                                break;
                            }
                        }
                        
                        if (headerRow !== -1) {
                            for (let i = headerRow + 1; i < jsonData.length; i++) {
                                const row = jsonData[i];
                                if (row[0] && row[1]) { // Tipo y Nombre requeridos
                                    const contacto = {
                                        id: Date.now() + i,
                                        tipo: row[0].toString().toLowerCase().includes('cliente') ? 'cliente' : 'proveedor',
                                        nombre: row[1] || '',
                                        nif: row[2] || '',
                                        direccion: row[3] || '',
                                        email: row[4] || '',
                                        telefono: row[5] || '',
                                        fechaCreacion: new Date().toISOString()
                                    };
                                    
                                    if (contacto.tipo === 'cliente') {
                                        datos.clientes.push(contacto);
                                        clientesImportados++;
                                    } else {
                                        datos.proveedores.push(contacto);
                                        proveedoresImportados++;
                                    }
                                }
                            }
                        }
                        
                        guardarDatos();
                        updateContactosTable();
                        actualizarListaContactos();
                        
                        mostrarNotificacion(`‚úÖ Contactos importados: ${clientesImportados} clientes, ${proveedoresImportados} proveedores`, 'success');
                        
                    } else {
                        mostrarNotificacion('‚ö† No se encontr√≥ hoja de clientes v√°lida', 'error');
                    }
                    
                } catch (error) {
                    console.error(error);
                    mostrarNotificacion('‚ö† Error al importar clientes: ' + error.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function convertirFecha(valor) {
            if (!valor) return '';
            
            // Si es una fecha de Excel (n√∫mero)
            if (typeof valor === 'number') {
                const date = new Date((valor - 25569) * 86400 * 1000);
                return date.toISOString().split('T')[0];
            }
            
            // Si es texto, intentar parsear
            const str = valor.toString();
            
            // Formato DD/MM/YY o DD/MM/YYYY
            if (str.includes('/')) {
                const partes = str.split('/');
                if (partes.length === 3) {
                    let [dia, mes, a√±o] = partes;
                    
                    // Ajustar a√±o de 2 d√≠gitos
                    if (a√±o.length === 2) {
                        a√±o = '20' + a√±o;
                    }
                    
                    // Asegurar formato de 2 d√≠gitos
                    dia = dia.padStart(2, '0');
                    mes = mes.padStart(2, '0');
                    
                    return `${a√±o}-${mes}-${dia}`;
                }
            }
            
            return valor;
        }

        // Funci√≥n auxiliar para filtrar facturas por a√±o y per√≠odo
        function filtrarPorPeriodo(facturas) {
            const a√±oSeleccionado = parseInt(document.getElementById('a√±oExportar').value);
            const periodo = document.getElementById('periodoExportar').value;
            
            // Primero filtrar por a√±o
            let facturasFiltradas = facturas.filter(f => {
                const fecha = new Date(f.fecha);
                return fecha.getFullYear() === a√±oSeleccionado;
            });
            
            // Luego filtrar por trimestre si no es "all"
            if (periodo !== 'all') {
                facturasFiltradas = facturasFiltradas.filter(f => {
                    const fecha = new Date(f.fecha);
                    const mes = fecha.getMonth() + 1; // 1-12
                    
                    switch(periodo) {
                        case 'Q1': return mes >= 1 && mes <= 3;
                        case 'Q2': return mes >= 4 && mes <= 6;
                        case 'Q3': return mes >= 7 && mes <= 9;
                        case 'Q4': return mes >= 10 && mes <= 12;
                        default: return true;
                    }
                });
            }
            
            return facturasFiltradas;
        }
        
        // Funci√≥n auxiliar para aplicar formato a las hojas (negrita en primera fila)
        function aplicarFormatoExcel(ws, tipoHoja) {
            // Configurar anchos de columna seg√∫n el tipo de hoja
            if (tipoHoja === 'INGRESOS') {
                ws['!cols'] = [
                    {wch: 15}, // ID
                    {wch: 12}, // Tipo
                    {wch: 12}, // Fecha
                    {wch: 14}, // N¬∫ Factura
                    {wch: 30}, // Cliente
                    {wch: 45}, // Descripci√≥n
                    {wch: 12}, // Tags
                    {wch: 15}, // Forma de pago
                    {wch: 15}, // Proyecto
                    {wch: 14}, // Base imponible
                    {wch: 12}, // IVA
                    {wch: 12}, // Retenci√≥n
                    {wch: 14}, // Total
                    {wch: 12}, // Estado
                    {wch: 14}  // Fecha de cobro
                ];
            } else if (tipoHoja === 'GASTOS') {
                ws['!cols'] = [
                    {wch: 15}, // ID
                    {wch: 12}, // Tipo
                    {wch: 12}, // Fecha emisi√≥n
                    {wch: 14}, // N¬∫ Factura
                    {wch: 30}, // Proveedor
                    {wch: 45}, // Descripci√≥n
                    {wch: 12}, // Tags
                    {wch: 15}, // Proyecto
                    {wch: 14}, // Base imponible
                    {wch: 12}, // IVA
                    {wch: 14}, // Total
                    {wch: 12}, // Estado
                    {wch: 14}  // Fecha de pago
                ];
            } else if (tipoHoja === 'AMBOS') {
                ws['!cols'] = [
                    {wch: 15}, // ID
                    {wch: 12}, // Tipo
                    {wch: 12}, // Fecha
                    {wch: 14}, // N¬∫ Factura
                    {wch: 35}, // Cliente/Proveedor
                    {wch: 45}, // Descripci√≥n
                    {wch: 14}, // Base
                    {wch: 12}, // IVA
                    {wch: 12}, // Retenci√≥n
                    {wch: 14}, // TOTAL
                    {wch: 12}, // Estado
                    {wch: 14}  // Fecha Cobro/Pago
                ];
            } else if (tipoHoja === 'CLIENTES') {
                ws['!cols'] = [
                    {wch: 15}, // ID
                    {wch: 15}, // Tipo
                    {wch: 35}, // Nombre
                    {wch: 15}, // NIF/CIF
                    {wch: 35}, // Email
                    {wch: 15}, // Tel√©fono
                    {wch: 45}, // Direcci√≥n
                    {wch: 14}  // Fecha Creaci√≥n
                ];
            }
            
            // Habilitar filtros autom√°ticos en la primera fila
            const ref = ws['!ref'];
            if (ref) {
                ws['!autofilter'] = { ref: ref };
            }
            
            return ws;
        }
        
        function exportarSoloIngresos() {
            const a√±oSeleccionado = document.getElementById('a√±oExportar').value;
            const periodo = document.getElementById('periodoExportar').value;
            const periodoTexto = periodo === 'all' ? 'Anual' : periodo;
            
            const facturasFiltradas = filtrarPorPeriodo(datos.facturasEmitidas);
            
            // Formato compatible con importaci√≥n: sin emojis, columnas en el orden correcto
            const ingresosData = facturasFiltradas.map(f => ({
                'Fecha': f.fecha,
                'Num': f.numero || '',
                'Vencimiento': '',
                'Cliente': f.cliente || '',
                'Descripci√≥n': f.descripcion || '',
                'Tags': f.tags || '',
                'Cuenta': f.cuenta || '',
                'F.Pago': f.formaPago || '',
                'Proyecto': f.proyecto || '',
                '': '', // Columna 10 vac√≠a
                '  ': '', // Columna 11 vac√≠a
                'Subtotal': f.subtotal || 0,
                'IVA': f.ivaImporte || 0,
                'Retenci√≥n': f.retencion ? -f.retencion : 0,
                'Empleados': '',
                'Rec. de eq.': '',
                'Total': f.total || 0,
                'Cobrado': '',
                'Pendiente': '',
                'Estado': f.estado || 'Pendiente',
                'Fecha Cobro': f.fechaCobro || ''
            }));
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(ingresosData);
            aplicarFormatoExcel(ws, 'INGRESOS');
            XLSX.utils.book_append_sheet(wb, ws, "INGRESOS"); // Sin emoji
            
            XLSX.writeFile(wb, `Ingresos_${a√±oSeleccionado}_${periodoTexto}.xlsx`);
            mostrarNotificacion('‚úÖ Ingresos exportados (formato compatible)', 'success');
        }
        
        function exportarSoloGastos() {
            const a√±oSeleccionado = document.getElementById('a√±oExportar').value;
            const periodo = document.getElementById('periodoExportar').value;
            const periodoTexto = periodo === 'all' ? 'Anual' : periodo;
            
            const facturasFiltradas = filtrarPorPeriodo(datos.facturasRecibidas);
            
            // Formato compatible con importaci√≥n: sin emojis, columnas en el orden correcto
            const gastosData = facturasFiltradas.map(f => ({
                'Fecha emisi√≥n': f.fecha,
                'Num': f.numero || '',
                'Num interno': '',
                'Fecha contable': '',
                'Vencimiento': '',
                'Proveedor': f.proveedor || '',
                'Descripci√≥n': f.descripcion || '',
                'Tags': f.tags || '',
                'Cuenta': f.cuenta || '',
                'Proyecto': f.proyecto || '',
                'Subtotal': f.subtotal || 0,
                'IVA': f.ivaImporte || 0,
                'Retenci√≥n': '',
                'Empleados': '',
                'Rec. de eq.': '',
                'Total': f.total || 0,
                'Pagado': '',
                'Pendiente': '',
                'Estado': f.estado || 'Pendiente',
                'Fecha de pago': f.fechaPago || ''
            }));
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(gastosData);
            aplicarFormatoExcel(ws, 'GASTOS');
            XLSX.utils.book_append_sheet(wb, ws, "GASTOS"); // Sin emoji
            
            XLSX.writeFile(wb, `Gastos_${a√±oSeleccionado}_${periodoTexto}.xlsx`);
            mostrarNotificacion('‚úÖ Gastos exportados (formato compatible)', 'success');
        }
        
        function exportarIngresosYGastos() {
            const a√±oSeleccionado = document.getElementById('a√±oExportar').value;
            const periodo = document.getElementById('periodoExportar').value;
            const periodoTexto = periodo === 'all' ? 'Anual' : periodo;
            
            const ingresosFiltrados = filtrarPorPeriodo(datos.facturasEmitidas);
            const gastosFiltrados = filtrarPorPeriodo(datos.facturasRecibidas);
            
            // HOJA DE INGRESOS - Formato compatible
            const ingresosData = ingresosFiltrados.map(f => ({
                'Fecha': f.fecha,
                'Num': f.numero || '',
                'Vencimiento': '',
                'Cliente': f.cliente || '',
                'Descripci√≥n': f.descripcion || '',
                'Tags': f.tags || '',
                'Cuenta': f.cuenta || '',
                'F.Pago': f.formaPago || '',
                'Proyecto': f.proyecto || '',
                '': '',
                '  ': '',
                'Subtotal': f.subtotal || 0,
                'IVA': f.ivaImporte || 0,
                'Retenci√≥n': f.retencion ? -f.retencion : 0,
                'Empleados': '',
                'Rec. de eq.': '',
                'Total': f.total || 0,
                'Cobrado': '',
                'Pendiente': '',
                'Estado': f.estado || 'Pendiente',
                'Fecha Cobro': f.fechaCobro || ''
            }));
            
            // HOJA DE GASTOS - Formato compatible
            const gastosData = gastosFiltrados.map(f => ({
                'Fecha emisi√≥n': f.fecha,
                'Num': f.numero || '',
                'Num interno': '',
                'Fecha contable': '',
                'Vencimiento': '',
                'Proveedor': f.proveedor || '',
                'Descripci√≥n': f.descripcion || '',
                'Tags': f.tags || '',
                'Cuenta': f.cuenta || '',
                'Proyecto': f.proyecto || '',
                'Subtotal': f.subtotal || 0,
                'IVA': f.ivaImporte || 0,
                'Retenci√≥n': '',
                'Empleados': '',
                'Rec. de eq.': '',
                'Total': f.total || 0,
                'Pagado': '',
                'Pendiente': '',
                'Estado': f.estado || 'Pendiente',
                'Fecha de pago': f.fechaPago || ''
            }));
            
            const wb = XLSX.utils.book_new();
            
            // Agregar hoja de INGRESOS
            const wsIngresos = XLSX.utils.json_to_sheet(ingresosData);
            aplicarFormatoExcel(wsIngresos, 'INGRESOS');
            XLSX.utils.book_append_sheet(wb, wsIngresos, 'INGRESOS');
            
            // Agregar hoja de GASTOS
            const wsGastos = XLSX.utils.json_to_sheet(gastosData);
            aplicarFormatoExcel(wsGastos, 'GASTOS');
            XLSX.utils.book_append_sheet(wb, wsGastos, 'GASTOS');
            
            XLSX.writeFile(wb, `Facturas_${a√±oSeleccionado}_${periodoTexto}.xlsx`);
            mostrarNotificacion('‚úÖ Facturas exportadas (formato compatible)', 'success');
        }

        function exportarFacturas() {
            exportarIngresosYGastos();
        }

        function exportarClientes() {
            const todosContactos = [...datos.clientes, ...datos.proveedores].map(c => ({
                'Tipo': c.tipo === 'cliente' ? 'Cliente' : 'Proveedor',
                'Nombre': c.nombre,
                'NIF/CIF': c.nif,
                'Direcci√≥n': c.direccion || '',
                'Email': c.email || '',
                'Tel√©fono': c.telefono || ''
            }));
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(todosContactos);
            
            // Aplicar formato
            ws['!cols'] = [
                {wch: 15}, // Tipo
                {wch: 35}, // Nombre
                {wch: 15}, // NIF/CIF
                {wch: 45}, // Direcci√≥n
                {wch: 35}, // Email
                {wch: 15}  // Tel√©fono
            ];
            
            // Habilitar filtros autom√°ticos
            if (ws['!ref']) {
                ws['!autofilter'] = { ref: ws['!ref'] };
            }
            
            XLSX.utils.book_append_sheet(wb, ws, "CLIENTES"); // Sin emoji
            XLSX.writeFile(wb, `Contactos_${ejercicioActual}.xlsx`);
            mostrarNotificacion('‚úÖ Contactos exportados (formato compatible)', 'success');
        }

        // Funci√≥n auxiliar para aplicar formato profesional a hojas Excel

        function exportarTodo() {
            const a√±oSeleccionado = document.getElementById('a√±oExportar').value;
            const periodo = document.getElementById('periodoExportar').value;
            const periodoTexto = periodo === 'all' ? 'Anual' : periodo;
            
            const wb = XLSX.utils.book_new();
            
            // Filtrar facturas por per√≠odo
            const ingresosFiltrados = filtrarPorPeriodo(datos.facturasEmitidas);
            const gastosFiltrados = filtrarPorPeriodo(datos.facturasRecibidas);
            
            // ========================================
            // HOJA 1: INGRESOS (Facturas Emitidas) - FORMATO COMPATIBLE
            // ========================================
            const ingresosData = ingresosFiltrados.map(f => ({
                'Fecha': f.fecha,
                'Num': f.numero || '',
                'Vencimiento': '',
                'Cliente': f.cliente || '',
                'Descripci√≥n': f.descripcion || '',
                'Tags': f.tags || '',
                'Cuenta': f.cuenta || '',
                'F.Pago': f.formaPago || '',
                'Proyecto': f.proyecto || '',
                '': '',
                '  ': '',
                'Subtotal': f.subtotal || 0,
                'IVA': f.ivaImporte || 0,
                'Retenci√≥n': f.retencion ? -f.retencion : 0,
                'Empleados': '',
                'Rec. de eq.': '',
                'Total': f.total || 0,
                'Cobrado': '',
                'Pendiente': '',
                'Estado': f.estado || 'Pendiente',
                'Fecha Cobro': f.fechaCobro || ''
            }));
            
            const wsIngresos = XLSX.utils.json_to_sheet(ingresosData);
            aplicarFormatoExcel(wsIngresos, 'INGRESOS');
            XLSX.utils.book_append_sheet(wb, wsIngresos, "INGRESOS"); // Sin emoji
            
            // ========================================
            // HOJA 2: GASTOS (Facturas Recibidas) - FORMATO COMPATIBLE
            // ========================================
            const gastosData = gastosFiltrados.map(f => ({
                'Fecha emisi√≥n': f.fecha,
                'Num': f.numero || '',
                'Num interno': '',
                'Fecha contable': '',
                'Vencimiento': '',
                'Proveedor': f.proveedor || '',
                'Descripci√≥n': f.descripcion || '',
                'Tags': f.tags || '',
                'Cuenta': f.cuenta || '',
                'Proyecto': f.proyecto || '',
                'Subtotal': f.subtotal || 0,
                'IVA': f.ivaImporte || 0,
                'Retenci√≥n': '',
                'Empleados': '',
                'Rec. de eq.': '',
                'Total': f.total || 0,
                'Pagado': '',
                'Pendiente': '',
                'Estado': f.estado || 'Pendiente',
                'Fecha de pago': f.fechaPago || ''
            }));
            
            const wsGastos = XLSX.utils.json_to_sheet(gastosData);
            aplicarFormatoExcel(wsGastos, 'GASTOS');
            XLSX.utils.book_append_sheet(wb, wsGastos, "GASTOS"); // Sin emoji
            
            // ========================================
            // HOJA 3: CLIENTES Y PROVEEDORES - FORMATO COMPATIBLE
            // ========================================
            const clientesData = [...datos.clientes, ...datos.proveedores].map(c => ({
                'Nombre': c.nombre,
                'Tipo': c.tipo === 'cliente' ? 'Cliente' : 'Proveedor',
                'NIF/CIF': c.nif,
                'Email': c.email || '',
                'Tel√©fono': c.telefono || '',
                'Direcci√≥n': c.direccion || ''
            }));
            
            const wsClientes = XLSX.utils.json_to_sheet(clientesData);
            aplicarFormatoExcel(wsClientes, 'CLIENTES');
            XLSX.utils.book_append_sheet(wb, wsClientes, "CLIENTES"); // Sin emoji
            
            // ========================================
            // HOJA 4: RESUMEN FINANCIERO
            // ========================================
            const totalIngresos = ingresosFiltrados.reduce((sum, f) => sum + (f.total || 0), 0);
            const totalGastos = gastosFiltrados.reduce((sum, f) => sum + (f.total || 0), 0);
            const beneficio = totalIngresos - totalGastos;
            
            const ingresosPendientes = ingresosFiltrados.filter(f => f.estado !== 'Pagado').reduce((sum, f) => sum + (f.total || 0), 0);
            const gastosPendientes = gastosFiltrados.filter(f => f.estado !== 'Pagado').reduce((sum, f) => sum + (f.total || 0), 0);
            
            const ivaRepercutido = ingresosFiltrados.reduce((sum, f) => sum + (f.ivaImporte || 0), 0);
            const ivaSoportado = gastosFiltrados.reduce((sum, f) => sum + (f.ivaImporte || 0), 0);
            const ivaPendiente = ivaRepercutido - ivaSoportado;
            
            const retencionesTotales = ingresosFiltrados.reduce((sum, f) => sum + (f.retencion || 0), 0);
            
            const resumenData = [
                { '': '', '': '' },
                { 'CONCEPTO': 'RESUMEN FINANCIERO ' + a√±oSeleccionado + ' - ' + periodoTexto, 'IMPORTE': '' },
                { '': '', '': '' },
                { 'CONCEPTO': 'Total Ingresos', 'IMPORTE': totalIngresos },
                { 'CONCEPTO': 'Total Gastos', 'IMPORTE': totalGastos },
                { 'CONCEPTO': 'Beneficio Neto', 'IMPORTE': beneficio },
                { '': '', '': '' },
                { 'CONCEPTO': 'Ingresos Pendientes', 'IMPORTE': ingresosPendientes },
                { 'CONCEPTO': 'Gastos Pendientes', 'IMPORTE': gastosPendientes },
                { '': '', '': '' },
                { 'CONCEPTO': 'IVA Repercutido', 'IMPORTE': ivaRepercutido },
                { 'CONCEPTO': 'IVA Soportado', 'IMPORTE': ivaSoportado },
                { 'CONCEPTO': 'IVA Pendiente de Liquidar', 'IMPORTE': ivaPendiente },
                { '': '', '': '' },
                { 'CONCEPTO': 'Retenciones Practicadas', 'IMPORTE': retencionesTotales },
                { '': '', '': '' },
                { 'CONCEPTO': 'Total Facturas Emitidas', 'IMPORTE': ingresosFiltrados.length },
                { 'CONCEPTO': 'Total Facturas Recibidas', 'IMPORTE': gastosFiltrados.length }
            ];
            
            const wsResumen = XLSX.utils.json_to_sheet(resumenData);
            wsResumen['!cols'] = [
                {wch: 40},
                {wch: 20}
            ];
            XLSX.utils.book_append_sheet(wb, wsResumen, "RESUMEN"); // Sin emoji
            
            // Guardar archivo
            XLSX.writeFile(wb, `ContaLegal_${a√±oSeleccionado}_${periodoTexto}_Completo.xlsx`);
            mostrarNotificacion('‚úÖ Excel completo exportado (formato compatible)', 'success');
        }

        function exportarDatosExcel(datos, nombre, archivo) {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(datos);
            XLSX.utils.book_append_sheet(wb, ws, nombre);
            XLSX.writeFile(wb, `${archivo}.xlsx`);
        }

        function verPlantillaEjemplo() {
            const content = `
                <div class="preview-container">
                    <h2>Formato de Importaci√≥n Excel</h2>
                    <p>Tu archivo Excel debe tener las siguientes hojas y columnas:</p>
                    
                    <h3>Hoja "INGRESOS":</h3>
                    <ul>
                        <li>Columna A: Fecha (formato DD/MM/YY o DD/MM/YYYY)</li>
                        <li>Columna B: Num (n√∫mero de factura)</li>
                        <li>Columna C: Vencimiento</li>
                        <li>Columna D: Cliente</li>
                        <li>Columna E: Descripci√≥n</li>
                        <li>Columna L: Subtotal</li>
                        <li>Columna M: IVA</li>
                        <li>Columna N: Retenci√≥n</li>
                        <li>Columna Q: Total</li>
                        <li>Columna T: Estado</li>
                        <li>Columna U: Fecha de cobro</li>
                    </ul>
                    
                    <h3>Hoja "GASTOS":</h3>
                    <ul>
                        <li>Columna A: Fecha emisi√≥n</li>
                        <li>Columna B: Num</li>
                        <li>Columna F: Proveedor</li>
                        <li>Columna G: Descripci√≥n</li>
                        <li>Columna K: Subtotal</li>
                        <li>Columna L: IVA</li>
                        <li>Columna P: Total</li>
                        <li>Columna S: Estado</li>
                        <li>Columna T: Fecha de pago</li>
                    </ul>
                    
                    <h3>Hoja "CLIENTES":</h3>
                    <ul>
                        <li>Columna A: Tipo (Cliente/Proveedor)</li>
                        <li>Columna B: Nombre</li>
                        <li>Columna C: NIF/CIF</li>
                        <li>Columna D: Direcci√≥n</li>
                        <li>Columna E: Email</li>
                        <li>Columna F: Tel√©fono</li>
                    </ul>
                    
                    <p><strong>Nota:</strong> Las filas con "TRIMESTRE" en la columna Fecha ser√°n ignoradas.</p>
                    <p><strong>Importante:</strong> Las retenciones se procesan autom√°ticamente desde la columna N en INGRESOS.</p>
                </div>
            `;
            
            document.getElementById('previewContent').innerHTML = content;
            document.getElementById('modalPreview').classList.add('active');
        }

        function descargarPlantillaClientes() {
            const data = [
                ['Tipo', 'Nombre', 'NIF/CIF', 'Direcci√≥n', 'Email', 'Tel√©fono'],
                ['Cliente', 'Cliente Ejemplo S.L.', 'B12345678', 'Calle Mayor 123, 28001 Madrid', 'cliente@ejemplo.com', '600123456'],
                ['Proveedor', 'Proveedor Ejemplo S.A.', 'A87654321', 'Avenida Principal 456, 08001 Barcelona', 'proveedor@ejemplo.com', '600654321']
            ];
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, "CLIENTES");
            XLSX.writeFile(wb, "Plantilla_Clientes.xlsx");
        }

        function descargarPlantillaCompleta() {
            const wb = XLSX.utils.book_new();
            
            // Hoja de Ingresos
            const ingresosData = [
                ['Fecha', 'Num', 'Vencimiento', 'Cliente', 'Descripci√≥n', 'Tags', 'Cuenta', 'F.Pago', 'Proyecto', '', '', 'Subtotal', 'IVA', 'Retenci√≥n', 'Empleados', 'Rec. de eq.', 'Total', 'Cobrado', 'Pendiente', 'Estado', 'Fecha de cobro'],
                ['01/01/25', '1-0001', '31/01/25', 'Cliente Ejemplo', 'Servicio de consultor√≠a', '', 'Prestaciones de servicios', '', '', '', '', '1000.00', '210.00', '150.00', '0.00', '0.00', '1060.00', '1060.00', '0.00', 'Pagado', '01/01/25']
            ];
            const wsIngresos = XLSX.utils.aoa_to_sheet(ingresosData);
            XLSX.utils.book_append_sheet(wb, wsIngresos, "INGRESOS");
            
            // Hoja de Gastos
            const gastosData = [
                ['Fecha emisi√≥n', 'Num', 'Num interno', 'Fecha contable', 'Vencimiento', 'Proveedor', 'Descripci√≥n', 'Tags', 'Cuenta', 'Proyecto', 'Subtotal', 'IVA', 'Retenci√≥n', 'Empleados', 'Rec. de eq.', 'Total', 'Pagado', 'Pendiente', 'Estado', 'Fecha de pago'],
                ['01/01/25', 'FAC-001', '', '01/01/25', '31/01/25', 'Proveedor Ejemplo', 'Servicios profesionales', '', 'Otros servicios', '', '100.00', '21.00', '0.00', '0.00', '0.00', '121.00', '121.00', '0.00', 'Pagado', '01/01/25']
            ];
            const wsGastos = XLSX.utils.aoa_to_sheet(gastosData);
            XLSX.utils.book_append_sheet(wb, wsGastos, "GASTOS");
            
            // Hoja de Clientes
            const clientesData = [
                ['Tipo', 'Nombre', 'NIF/CIF', 'Direcci√≥n', 'Email', 'Tel√©fono'],
                ['Cliente', 'Cliente Ejemplo S.L.', 'B12345678', 'Calle Mayor 123, 28001 Madrid', 'cliente@ejemplo.com', '600123456'],
                ['Proveedor', 'Proveedor Ejemplo S.A.', 'A87654321', 'Avenida Principal 456, 08001 Barcelona', 'proveedor@ejemplo.com', '600654321']
            ];
            const wsClientes = XLSX.utils.aoa_to_sheet(clientesData);
            XLSX.utils.book_append_sheet(wb, wsClientes, "CLIENTES");
            
            XLSX.writeFile(wb, "Plantilla_ContaLegal_Completa.xlsx");
        }

        // ===============================
        // MODELOS TRIBUTARIOS ADAPTADOS
        // ===============================
        function filtrarPorTrimestre(datos, trimestre) {
            const qNum = parseInt(trimestre.replace('Q', ''));
            const startMonth = (qNum - 1) * 3 + 1;
            const endMonth = qNum * 3;
            
            return datos.filter(item => {
                const fecha = new Date(item.fecha || item.fechaInicio);
                const mes = fecha.getMonth() + 1;
                const a√±o = fecha.getFullYear();
                
                return a√±o.toString() === ejercicioActual && mes >= startMonth && mes <= endMonth;
            });
        }

        function generarModelo130() {
            const trimestre = document.getElementById('trimestreM130').value;
            if (!trimestre) return;
            
            // Usar solo facturas
            const todasFacturasEmitidas = datos.facturasEmitidas;
            const todasFacturasRecibidas = datos.facturasRecibidas;
            
            const ingresosT = filtrarPorTrimestre(todasFacturasEmitidas, trimestre);
            const gastosT = filtrarPorTrimestre(todasFacturasRecibidas, trimestre);
            
            const ingresosTrimestre = ingresosT.reduce((sum, item) => sum + (item.subtotal || 0), 0);
            const gastosTrimestre = gastosT.reduce((sum, item) => sum + (item.subtotal || 0), 0);
            const rendimiento = ingresosTrimestre - gastosTrimestre;
            
            const trimestreNum = parseInt(trimestre.split('Q')[1]);
            let rendimientoAcum = 0;
            
            for (let i = 1; i <= trimestreNum; i++) {
                const tAcum = 'Q' + i;
                const ingAcum = filtrarPorTrimestre(todasFacturasEmitidas, tAcum).reduce((sum, item) => sum + (item.subtotal || 0), 0);
                const gasAcum = filtrarPorTrimestre(todasFacturasRecibidas, tAcum).reduce((sum, item) => sum + (item.subtotal || 0), 0);
                rendimientoAcum += (ingAcum - gasAcum);
            }
            
            const pago20Porciento = rendimientoAcum > 0 ? rendimientoAcum * 0.20 : 0;
            
            document.getElementById('m130_ingresos').value = ingresosTrimestre.toFixed(2);
            document.getElementById('m130_gastos').value = gastosTrimestre.toFixed(2);
            document.getElementById('m130_rendimiento').value = rendimiento.toFixed(2);
            document.getElementById('m130_rendimiento_acum').value = rendimientoAcum.toFixed(2);
            document.getElementById('m130_20_porciento').value = pago20Porciento.toFixed(2);
            
            calcularResultadoM130();
            
            document.getElementById('trimestreSeleccionado').textContent = trimestre + ' - ' + ejercicioActual;
            document.getElementById('modelo130Content').style.display = 'block';
        }

        function calcularResultadoM130() {
            const pago20 = parseFloat(document.getElementById('m130_20_porciento').value) || 0;
            const pagosAnteriores = parseFloat(document.getElementById('m130_pagos_anteriores').value) || 0;
            const resultado = Math.max(0, pago20 - pagosAnteriores);
            
            document.getElementById('m130_resultado').value = resultado.toFixed(2);
        }

        function generarModelo303() {
            const trimestre = document.getElementById('trimestreM303').value;
            if (!trimestre) return;
            
            // Usar solo facturas
            const todasFacturasEmitidas = datos.facturasEmitidas;
            const todasFacturasRecibidas = datos.facturasRecibidas;
            
            const ingresosT = filtrarPorTrimestre(todasFacturasEmitidas, trimestre);
            const gastosT = filtrarPorTrimestre(todasFacturasRecibidas, trimestre);
            
            const base21 = ingresosT.filter(i => (i.ivaPercent || 21) === 21).reduce((sum, item) => sum + (item.subtotal || 0), 0);
            const base10 = ingresosT.filter(i => (i.ivaPercent || 21) === 10).reduce((sum, item) => sum + (item.subtotal || 0), 0);
            
            const cuota21 = base21 * 0.21;
            const cuota10 = base10 * 0.10;
            const totalDevengado = cuota21 + cuota10;
            
            const ivaSoportado = gastosT.reduce((sum, item) => sum + (item.ivaImporte || 0), 0);
            const resultado = totalDevengado - ivaSoportado;
            
            document.getElementById('m303_base_21').value = base21.toFixed(2);
            document.getElementById('m303_cuota_21').value = cuota21.toFixed(2);
            document.getElementById('m303_base_10').value = base10.toFixed(2);
            document.getElementById('m303_cuota_10').value = cuota10.toFixed(2);
            document.getElementById('m303_total_devengado').value = totalDevengado.toFixed(2);
            document.getElementById('m303_iva_soportado').value = ivaSoportado.toFixed(2);
            document.getElementById('m303_resultado').value = resultado.toFixed(2);
            
            document.getElementById('trimestreSeleccionado303').textContent = trimestre + ' - ' + ejercicioActual;
            document.getElementById('modelo303Content').style.display = 'block';
        }

        function generarResumenAnual() {
            const a√±o = document.getElementById('a√±oAnual').value;
            if (!a√±o) return;
            
            // Usar ejercicio actual si no se especifica
            const a√±oFiltro = a√±o || ejercicioActual;
            
            // Usar solo facturas
            const todasFacturasEmitidas = datos.facturasEmitidas;
            const todasFacturasRecibidas = datos.facturasRecibidas;
            
            const ingresosA√±o = todasFacturasEmitidas.filter(i => i.fecha.startsWith(a√±oFiltro));
            const gastosA√±o = todasFacturasRecibidas.filter(g => g.fecha.startsWith(a√±oFiltro));
            
            const totalIngresos = ingresosA√±o.reduce((sum, item) => sum + (item.total || 0), 0);
            const totalGastos = gastosA√±o.reduce((sum, item) => sum + (item.total || 0), 0);
            const beneficio = totalIngresos - totalGastos;
            
            const ivaRepercutido = ingresosA√±o.reduce((sum, item) => sum + (item.ivaImporte || 0), 0);
            const ivaSoportado = gastosA√±o.reduce((sum, item) => sum + (item.ivaImporte || 0), 0);
            const ivaLiquidado = ivaRepercutido - ivaSoportado;
            
            document.getElementById('ingresosAnual').textContent = formatCurrency(totalIngresos);
            document.getElementById('gastosAnual').textContent = formatCurrency(totalGastos);
            document.getElementById('beneficioAnual').textContent = formatCurrency(beneficio);
            document.getElementById('ivaAnual').textContent = formatCurrency(ivaLiquidado);
            
            const tbody = document.getElementById('trimestresTable');
            tbody.innerHTML = '';
            
            for (let i = 1; i <= 4; i++) {
                const trimestre = `Q${i}`;
                const ingT = filtrarPorTrimestre(todasFacturasEmitidas, trimestre);
                const gasT = filtrarPorTrimestre(todasFacturasRecibidas, trimestre);
                
                const ingTotal = ingT.reduce((sum, item) => sum + (item.total || 0), 0);
                const gasTotal = gasT.reduce((sum, item) => sum + (item.total || 0), 0);
                const benTrim = ingTotal - gasTotal;
                
                const ivaRepT = ingT.reduce((sum, item) => sum + (item.ivaImporte || 0), 0);
                const ivaSopT = gasT.reduce((sum, item) => sum + (item.ivaImporte || 0), 0);
                const ivaLiqT = ivaRepT - ivaSopT;
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${i}¬∫ Trimestre</td>
                    <td>${formatCurrency(ingTotal)}</td>
                    <td>${formatCurrency(gasTotal)}</td>
                    <td>${formatCurrency(benTrim)}</td>
                    <td>${formatCurrency(ivaLiqT)}</td>
                `;
            }
            
            document.getElementById('resumenAnualContent').style.display = 'block';
        }

        function descargarModelo130() {
            const trimestre = document.getElementById('trimestreM130').value;
            const datos130 = {
                trimestre: trimestre,
                ejercicio: ejercicioActual,
                ingresos: document.getElementById('m130_ingresos').value,
                gastos: document.getElementById('m130_gastos').value,
                rendimiento: document.getElementById('m130_rendimiento').value,
                rendimientoAcum: document.getElementById('m130_rendimiento_acum').value,
                pago20: document.getElementById('m130_20_porciento').value,
                pagosAnteriores: document.getElementById('m130_pagos_anteriores').value,
                resultado: document.getElementById('m130_resultado').value
            };
            
            const contenido = `MODELO 130 - PAGO FRACCIONADO IRPF
Ejercicio: ${datos130.ejercicio}
Trimestre: ${datos130.trimestre}
====================================

01. Ingresos del trimestre: ‚Ç¨${datos130.ingresos}
02. Gastos del trimestre: ‚Ç¨${datos130.gastos}
03. Rendimiento: ‚Ç¨${datos130.rendimiento}
04. Rendimiento acumulado: ‚Ç¨${datos130.rendimientoAcum}
05. 20% sobre rendimiento acumulado: ‚Ç¨${datos130.pago20}
06. Pagos anteriores: ‚Ç¨${datos130.pagosAnteriores}
07. Resultado a ingresar: ‚Ç¨${datos130.resultado}

Generado el: ${new Date().toLocaleDateString('es-ES')}`;
            
            const blob = new Blob([contenido], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Modelo_130_${trimestre}_${ejercicioActual}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function descargarModelo303() {
            const trimestre = document.getElementById('trimestreM303').value;
            const datos303 = {
                trimestre: trimestre,
                ejercicio: ejercicioActual,
                base21: document.getElementById('m303_base_21').value,
                cuota21: document.getElementById('m303_cuota_21').value,
                base10: document.getElementById('m303_base_10').value,
                cuota10: document.getElementById('m303_cuota_10').value,
                totalDevengado: document.getElementById('m303_total_devengado').value,
                ivaSoportado: document.getElementById('m303_iva_soportado').value,
                resultado: document.getElementById('m303_resultado').value
            };
            
            const contenido = `MODELO 303 - AUTOLIQUIDACI√ìN IVA
Ejercicio: ${datos303.ejercicio}
Trimestre: ${datos303.trimestre}
====================================

IVA DEVENGADO:
01. Base imponible 21%: ‚Ç¨${datos303.base21}
02. Cuota 21%: ‚Ç¨${datos303.cuota21}
03. Base imponible 10%: ‚Ç¨${datos303.base10}
04. Cuota 10%: ‚Ç¨${datos303.cuota10}
27. Total cuota devengada: ‚Ç¨${datos303.totalDevengado}

IVA DEDUCIBLE:
29. IVA soportado: ‚Ç¨${datos303.ivaSoportado}

LIQUIDACI√ìN:
46. Resultado: ‚Ç¨${datos303.resultado}

Generado el: ${new Date().toLocaleDateString('es-ES')}`;
            
            const blob = new Blob([contenido], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Modelo_303_${trimestre}_${ejercicioActual}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportarDatos() {
            const datosCompletos = {
                ejercicio: ejercicioActual,
                facturasEmitidas: datos.facturasEmitidas,
                facturasRecibidas: datos.facturasRecibidas,
                clientes: datos.clientes,
                proveedores: datos.proveedores,
                recurrentes: datos.recurrentes,
                fechaExportacion: new Date().toISOString()
            };
            
            const contenido = JSON.stringify(datosCompletos, null, 2);
            const blob = new Blob([contenido], { type: 'application/json;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `datos_contabilidad_${ejercicioActual}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function generarInformeAnual() {
            const a√±o = document.getElementById('a√±oAnual').value || ejercicioActual;
            
            // Usar solo facturas
            const todasFacturasEmitidas = datos.facturasEmitidas;
            const todasFacturasRecibidas = datos.facturasRecibidas;
            
            const ingresosA√±o = todasFacturasEmitidas.filter(i => i.fecha.startsWith(a√±o));
            const gastosA√±o = todasFacturasRecibidas.filter(g => g.fecha.startsWith(a√±o));
            
            let informe = `INFORME ANUAL DE CONTABILIDAD - ${a√±o}
${'='.repeat(50)}

RESUMEN GENERAL:
`;
            
            const totalIngresos = ingresosA√±o.reduce((sum, item) => sum + (item.total || 0), 0);
            const totalGastos = gastosA√±o.reduce((sum, item) => sum + (item.total || 0), 0);
            const beneficio = totalIngresos - totalGastos;
            
            informe += `
Total Ingresos: ${formatCurrency(totalIngresos)}
Total Gastos: ${formatCurrency(totalGastos)}
Beneficio Neto: ${formatCurrency(beneficio)}

AN√ÅLISIS TRIMESTRAL:
`;
            
            for (let i = 1; i <= 4; i++) {
                const trimestre = `Q${i}`;
                const ingT = filtrarPorTrimestre(todasFacturasEmitidas, trimestre);
                const gasT = filtrarPorTrimestre(todasFacturasRecibidas, trimestre);
                
                const ingTotal = ingT.reduce((sum, item) => sum + (item.total || 0), 0);
                const gasTotal = gasT.reduce((sum, item) => sum + (item.total || 0), 0);
                const benTrim = ingTotal - gasTotal;
                
                informe += `
${i}¬∫ Trimestre:
  Ingresos: ${formatCurrency(ingTotal)}
  Gastos: ${formatCurrency(gasTotal)}
  Beneficio: ${formatCurrency(benTrim)}
`;
            }
            
            informe += `

DETALLE DE INGRESOS:
`;
            ingresosA√±o.forEach(ing => {
                const cliente = ing.cliente || '-';
                informe += `${formatDate(ing.fecha)} - ${cliente} - ${ing.descripcion} - ${formatCurrency(ing.total)}\n`;
            });
            
            informe += `

DETALLE DE GASTOS:
`;
            gastosA√±o.forEach(gas => {
                const proveedor = gas.proveedor || '-';
                informe += `${formatDate(gas.fecha)} - ${proveedor} - ${gas.descripcion} - ${formatCurrency(gas.total)}\n`;
            });
            
            informe += `

Generado el: ${new Date().toLocaleDateString('es-ES')}`;
            
            const blob = new Blob([informe], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Informe_Anual_${a√±o}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ===============================
        // DASHBOARD Y ACTUALIZACIONES ADAPTADAS
        // ===============================
        function updateDashboard() {
            const periodo = document.getElementById('periodoFilter').value;
            
            // Usar solo facturas
            const todasFacturasEmitidas = datos.facturasEmitidas;
            const todasFacturasRecibidas = datos.facturasRecibidas;
            
            let ingresosFiltered = todasFacturasEmitidas;
            let gastosFiltered = todasFacturasRecibidas;
            
            if (periodo !== 'all') {
                // Filtrar por trimestre
                const trimestre = periodo; // Ya viene como 'Q1', 'Q2', etc.
                ingresosFiltered = filtrarPorTrimestre(todasFacturasEmitidas, trimestre);
                gastosFiltered = filtrarPorTrimestre(todasFacturasRecibidas, trimestre);
            }
            
            const totalIngresos = ingresosFiltered.reduce((sum, i) => sum + (i.total || 0), 0);
            const totalGastos = gastosFiltered.reduce((sum, g) => sum + (g.total || 0), 0);
            const beneficioNeto = totalIngresos - totalGastos;
            
            const ivaRepercutido = ingresosFiltered.reduce((sum, i) => sum + (i.ivaImporte || 0), 0);
            const ivaSoportado = gastosFiltered.reduce((sum, g) => sum + (g.ivaImporte || 0), 0);
            const ivaPendiente = ivaRepercutido - ivaSoportado;
            
            // Calcular total de retenciones practicadas
            const totalRetenciones = ingresosFiltered.reduce((sum, i) => sum + (i.retencion || 0), 0);
            
            document.getElementById('totalIngresos').textContent = formatCurrency(totalIngresos);
            document.getElementById('totalGastos').textContent = formatCurrency(totalGastos);
            document.getElementById('beneficioNeto').textContent = formatCurrency(beneficioNeto);
            document.getElementById('ivaPendiente').textContent = formatCurrency(ivaPendiente);
            document.getElementById('totalRetenciones').textContent = formatCurrency(totalRetenciones);
            
            // Actualizar √∫ltimas operaciones
            updateUltimasOperaciones();
        }

        function updateUltimasOperaciones() {
            const tbody = document.getElementById('ultimasOperaciones');
            tbody.innerHTML = '';
            
            // SOLO facturas emitidas (ingresos), NO incluir gastos
            let operaciones = [
                ...datos.facturasEmitidas.map(f => ({ ...f, tipoOp: 'Factura Emitida', nombre: f.cliente, tipoFactura: 'emitida' }))
            ];
            
            // Aplicar filtro de estado
            const estadoFilter = document.getElementById('estadoFilter')?.value || 'todas';
            if (estadoFilter === 'pendientes') {
                // Solo facturas pendientes (todo lo que NO est√° pagado)
                operaciones = operaciones.filter(op => op.estado !== 'Pagado');
            } else if (estadoFilter === 'pagadas') {
                // Solo facturas pagadas
                operaciones = operaciones.filter(op => op.estado === 'Pagado');
            }
            
            // Ordenar por fecha descendente
            operaciones.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            // Mostrar hasta 50 facturas
            const mostrar = Math.min(50, operaciones.length);
            operaciones.slice(0, mostrar).forEach(op => {
                const row = tbody.insertRow();
                const tipoClass = op.tipoOp.includes('Emitida') ? 'tipo-ingreso' : 'tipo-gasto';
                const estadoClass = op.estado === 'Pagado' ? 'estado-pagado' : 'estado-pendiente';
                
                // Hacer la fila clickeable para editar
                row.style.cursor = 'pointer';
                row.onclick = function(e) {
                    // Si el click fue en un bot√≥n, no ejecutar el click de la fila
                    if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                        return;
                    }
                    editarFacturaDesdeDashboard(op.id, op.tipoFactura);
                };
                
                // Efecto hover
                row.onmouseenter = function() {
                    if (!this.querySelector('button:hover')) {
                        this.style.backgroundColor = '#f8f9fa';
                    }
                };
                row.onmouseleave = function() {
                    this.style.backgroundColor = '';
                };
                
                // Botones de acci√≥n seg√∫n el estado
                let botonesAccion = '';
                if (op.estado !== 'Pagado') {
                    // Estado Pendiente: mostrar bot√≥n para marcar como pagado
                    botonesAccion = `
                        <button class="btn btn-success btn-small" onclick="event.stopPropagation(); marcarComoPagado('${op.id}', '${op.tipoFactura}')" title="Marcar como pagado">
                            ‚úì Pagado
                        </button>
                    `;
                } else {
                    botonesAccion = `
                        <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); marcarComoPendiente('${op.id}', '${op.tipoFactura}')" title="Marcar como pendiente">
                            ‚Ü© Pendiente
                        </button>
                    `;
                }
                
                row.innerHTML = `
                    <td>${formatDate(op.fecha)}</td>
                    <td><span class="${tipoClass}">${op.tipoOp}</span></td>
                    <td>${op.nombre}</td>
                    <td>${op.descripcion ? op.descripcion.substring(0, 40) + '...' : ''}</td>
                    <td>${formatCurrency(op.total)}</td>
                    <td><span class="${estadoClass}">${op.estado}</span></td>
                    <td class="action-buttons">
                        ${botonesAccion}
                        <button class="btn btn-info btn-small" onclick="event.stopPropagation(); editarFacturaDesdeDashboard('${op.id}', '${op.tipoFactura}')" title="Editar">
                            ‚úèÔ∏è
                        </button>
                    </td>
                `;
            });
            
            // Actualizar contador
            const totalOperaciones = operaciones.length;
            const mostradas = Math.min(50, totalOperaciones);
            const contadorEl = document.getElementById('contadorOperaciones');
            if (contadorEl) {
                if (totalOperaciones > 50) {
                    contadorEl.textContent = `(mostrando ${mostradas} de ${totalOperaciones} facturas)`;
                } else {
                    contadorEl.textContent = `(${totalOperaciones} facturas)`;
                }
            }
        }

        // Funci√≥n para editar factura desde el dashboard
        function editarFacturaDesdeDashboard(id, tipo) {
            if (tipo === 'emitida') {
                // Ir a la pesta√±a de facturas emitidas
                showTab('facturas', document.querySelector('[onclick*="facturas"]'));
                showSubTab('facturas-emitidas', document.querySelector('[onclick*="facturas-emitidas"]'));
                // Buscar y cargar la factura
                setTimeout(() => editarFacturaEmitida(id), 100);
            } else {
                // Ir a la pesta√±a de facturas recibidas
                showTab('facturas', document.querySelector('[onclick*="facturas"]'));
                showSubTab('facturas-recibidas', document.querySelector('[onclick*="facturas-recibidas"]'));
                // Buscar y cargar la factura
                setTimeout(() => editarFacturaRecibida(id), 100);
            }
        }

        // Funci√≥n para marcar como pagado r√°pidamente
        function marcarComoPagado(id, tipo) {
            const facturas = tipo === 'emitida' ? datos.facturasEmitidas : datos.facturasRecibidas;
            const factura = facturas.find(f => f.id == id);
            
            if (factura) {
                factura.estado = 'Pagado';
                // Si no tiene fecha de cobro/pago, poner la fecha actual
                if (tipo === 'emitida' && !factura.fechaCobro) {
                    factura.fechaCobro = new Date().toISOString().split('T')[0];
                } else if (tipo === 'recibida' && !factura.fechaPago) {
                    factura.fechaPago = new Date().toISOString().split('T')[0];
                }
                
                guardarDatos();
                updateAllTables();
                mostrarNotificacion('‚úÖ Factura marcada como Pagada', 'success');
            }
        }

        // Funci√≥n para marcar como pendiente
        function marcarComoPendiente(id, tipo) {
            const facturas = tipo === 'emitida' ? datos.facturasEmitidas : datos.facturasRecibidas;
            const factura = facturas.find(f => f.id == id);
            
            if (factura) {
                factura.estado = 'Pendiente';
                
                guardarDatos();
                updateAllTables();
                mostrarNotificacion('‚Ü©Ô∏è Factura marcada como Pendiente', 'info');
            }
        }

        // Funciones optimizadas para cambio r√°pido desde las tablas
        function marcarComoPagadoTabla(id, tipo) {
            const facturas = tipo === 'emitida' ? datos.facturasEmitidas : datos.facturasRecibidas;
            const factura = facturas.find(f => f.id == id);
            
            if (factura) {
                factura.estado = 'Pagado';
                // Si no tiene fecha de cobro/pago, poner la fecha actual
                if (tipo === 'emitida' && !factura.fechaCobro) {
                    factura.fechaCobro = new Date().toISOString().split('T')[0];
                } else if (tipo === 'recibida' && !factura.fechaPago) {
                    factura.fechaPago = new Date().toISOString().split('T')[0];
                }
                
                guardarDatos();
                // Actualizar solo las tablas necesarias para rapidez
                if (tipo === 'emitida') {
                    updateFacturasEmitidasTable();
                } else {
                    updateFacturasRecibidasTable();
                }
                updateDashboard();
                mostrarNotificacion('‚úÖ Factura marcada como Pagada', 'success');
            }
        }

        function marcarComoPendienteTabla(id, tipo) {
            const facturas = tipo === 'emitida' ? datos.facturasEmitidas : datos.facturasRecibidas;
            const factura = facturas.find(f => f.id == id);
            
            if (factura) {
                factura.estado = 'Pendiente';
                
                guardarDatos();
                // Actualizar solo las tablas necesarias para rapidez
                if (tipo === 'emitida') {
                    updateFacturasEmitidasTable();
                } else {
                    updateFacturasRecibidasTable();
                }
                updateDashboard();
                mostrarNotificacion('‚Ü©Ô∏è Factura marcada como Pendiente', 'info');
            }
        }

        function updateAllTables() {
            updateFacturasEmitidasTable();
            updateFacturasRecibidasTable();
            updateRecurrentesTable();
            updateListadoGeneralTable();
            updateContactosTable();
            actualizarListaContactos();
            updateDashboard();
        }
    </script>
</body>
</html>
